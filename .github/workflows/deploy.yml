name: Deploy to Tencent Cloud via SCP/SSH

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ====================================
  # é˜¶æ®µ 1: API æµ‹è¯•
  # ====================================
  api-test:
    name: API Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ğŸ§ª Run API tests
      run: |
        echo "::group::Running API Integration Tests"
        # ä½¿ç”¨å†…å­˜æ•°æ®åº“è¿è¡Œæµ‹è¯•
        DATABASE_URL=sqlite:///:memory: pytest tests/api/ -v --cov=web_gui --cov-report=term
        echo "::endgroup::"
    
    - name: ğŸ“Š Code quality check
      run: |
        echo "::group::Code Quality Analysis"
        pip install flake8
        flake8 web_gui --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo "::endgroup::"

  # ====================================
  # é˜¶æ®µ 2: æ„å»ºå’Œéƒ¨ç½²ï¼ˆSCP/SSH æ¨é€æ¨¡å¼ï¼‰
  # ====================================
  deploy-to-production:
    name: Build and Deploy to Tencent Cloud
    needs: api-test  # å¿…é¡»ç­‰å¾… api-test å®Œæˆä¸”æˆåŠŸ
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸŸ¢ Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: ğŸ“¦ Build proxy package
      run: |
        echo "æ„å»ºæœ¬åœ°ä»£ç†åŒ…..."
        node scripts/build-proxy-package.js
        echo "âœ… ä»£ç†åŒ…æ„å»ºå®Œæˆ"
        ls -lh dist/intent-test-proxy.zip
    
    - name: ğŸ“¦ Prepare deployment package
      run: |
        echo "å‡†å¤‡éƒ¨ç½²åŒ…..."
        
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deploy-package
        
        # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
        rsync -av --progress \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='.coverage' \
          --exclude='logs' \
          --exclude='.env' \
          --exclude='.DS_Store' \
          --exclude='*.md' \
          --exclude='.github' \
          --exclude='.claude' \
          --exclude='.cursor' \
          --exclude='.bmad-core' \
          --exclude='.playwright-mcp' \
          --exclude='deploy-package' \
          ./ deploy-package/
        
        echo "âœ… éƒ¨ç½²åŒ…å‡†å¤‡å®Œæˆ"
        
        # æ˜¾ç¤ºåŒ…å¤§å°
        echo "éƒ¨ç½²åŒ…å¤§å°:"
        du -sh deploy-package
    
    - name: ğŸš€ Upload to Tencent Cloud Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 600s
        command_timeout: 600s
        script: |
          echo "å‡†å¤‡æ¥æ”¶éƒ¨ç½²æ–‡ä»¶..."
          # ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨ä¸”æƒé™æ­£ç¡®
          sudo rm -rf /opt/intent-test-framework-upload-tmp
          sudo mkdir -p /opt/intent-test-framework-upload-tmp
          sudo chown -R $USER:$USER /opt/intent-test-framework-upload-tmp
          echo "âœ… ä¸Šä¼ ç›®å½•å·²å‡†å¤‡å®Œæˆ"
    
    - name: ğŸ“¦ Transfer Files via Rsync
      run: |
        echo "å¼€å§‹ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
        
        # é…ç½® SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # ä½¿ç”¨ rsync ä¼ è¾“æ–‡ä»¶
        rsync -avz --progress \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          deploy-package/ \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/intent-test-framework-upload-tmp/
        
        echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"
        
        # æ¸…ç† SSH å¯†é’¥
        rm -f ~/.ssh/deploy_key
    
    - name: ğŸš€ Deploy on Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 1800s
        command_timeout: 1800s
        script: |
          
          echo "=========================================="
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²"
          echo "=========================================="
          
          # å¤åˆ¶ä¸Šä¼ çš„æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
          echo "ğŸ“¦ åŒæ­¥æ–‡ä»¶..."
          sudo rsync -a --delete /opt/intent-test-framework-upload-tmp/ /opt/intent-test-framework/
          sudo chown -R $USER:$USER /opt/intent-test-framework
          
          # åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
          cd /opt/intent-test-framework
          
          # æ„å»ºä»£ç†åŒ…ï¼ˆç¡®ä¿ ZIP æ–‡ä»¶å­˜åœ¨ï¼‰
          echo "ğŸ“¦ æ„å»ºæœ¬åœ°ä»£ç†åŒ…..."
          cd dist
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ intent-test-proxy ç›®å½•
          if [ ! -d "intent-test-proxy" ]; then
            echo "âŒ é”™è¯¯ï¼šintent-test-proxy ç›®å½•ä¸å­˜åœ¨"
            cd ..
          else
            # å°è¯•ä½¿ç”¨ Node.js æ„å»ºï¼ˆåŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼‰
            if command -v node &> /dev/null; then
              cd ..
              node scripts/build-proxy-package.js
              echo "âœ… ä½¿ç”¨ Node.js æ„å»ºä»£ç†åŒ…å®Œæˆ"
            else
              # åå¤‡æ–¹æ¡ˆï¼šä½¿ç”¨ç³»ç»Ÿ zip å‘½ä»¤ï¼ˆä¸ä¾èµ– Node.jsï¼‰
              echo "âš ï¸ Node.js æœªå®‰è£…ï¼Œä½¿ç”¨ç³»ç»Ÿ zip å‘½ä»¤åˆ›å»ºå‹ç¼©åŒ…"
              
              # åˆ é™¤æ—§çš„ ZIP æ–‡ä»¶
              rm -f intent-test-proxy.zip
              
              # åˆ›å»º ZIP æ–‡ä»¶
              zip -r intent-test-proxy.zip intent-test-proxy/
              
              if [ -f "intent-test-proxy.zip" ]; then
                echo "âœ… ZIP æ–‡ä»¶åˆ›å»ºæˆåŠŸ"
                ls -lh intent-test-proxy.zip
                chmod 644 intent-test-proxy.zip
              else
                echo "âŒ ZIP æ–‡ä»¶åˆ›å»ºå¤±è´¥"
              fi
              
              cd ..
            fi
          fi
          
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x scripts/deploy.sh
          
          # æ‰§è¡Œç»Ÿä¸€éƒ¨ç½²è„šæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
          bash scripts/deploy.sh production
          
          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "=========================================="
    
    - name: ğŸ“Š Deployment Summary
      if: success()
      run: |
        echo ""
        echo "=========================================="
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "=========================================="
        echo "âœ… API æµ‹è¯•å·²é€šè¿‡"
        echo "âœ… ä»£ç å·²é€šè¿‡ SCP æ¨é€åˆ°è…¾è®¯äº‘æœåŠ¡å™¨"
        echo "âœ… æœåŠ¡å·²é‡å¯å¹¶é€šè¿‡å¥åº·æ£€æŸ¥"
        echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}:5001"
        echo "=========================================="
    
    - name: ğŸ“Š Deployment Failed
      if: failure()
      run: |
        echo ""
        echo "=========================================="
        echo "âŒ éƒ¨ç½²å¤±è´¥"
        echo "=========================================="
        echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        echo "å¦‚æœæ˜¯æœåŠ¡å™¨ç«¯é”™è¯¯ï¼ŒSSH ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—ï¼š"
        echo "  ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        echo "  docker-compose -f /opt/intent-test-framework/docker-compose.prod.yml logs"
        echo "=========================================="
