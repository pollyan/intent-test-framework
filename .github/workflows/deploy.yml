name: Deploy to Tencent Cloud via SCP/SSH

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ====================================
  # 阶段 1: API 测试
  # ====================================
  api-test:
    name: API Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3
    
    - name: 🐍 Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: 🧪 Run API tests
      run: |
        echo "::group::Running API Integration Tests"
        # 使用内存数据库运行测试
        DATABASE_URL=sqlite:///:memory: pytest tests/api/ -v --cov=web_gui --cov-report=term
        echo "::endgroup::"
    
    - name: 📊 Code quality check
      run: |
        echo "::group::Code Quality Analysis"
        pip install flake8
        flake8 web_gui --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo "::endgroup::"

  # ====================================
  # 阶段 2: 构建和部署（SCP/SSH 推送模式）
  # ====================================
  deploy-to-production:
    name: Build and Deploy to Tencent Cloud
    needs: api-test  # 必须等待 api-test 完成且成功
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3
    
    - name: 🟢 Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: 📦 Build proxy package
      run: |
        echo "构建本地代理包..."
        node scripts/build-proxy-package.js
        echo "✅ 代理包构建完成"
        ls -lh dist/intent-test-proxy.zip
    
    - name: 📦 Prepare deployment package
      run: |
        echo "准备部署包..."
        
        # 创建部署目录
        mkdir -p deploy-package
        
        # 复制必要的文件（排除不需要的文件）
        rsync -av --progress \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='.coverage' \
          --exclude='logs' \
          --exclude='.env' \
          --exclude='.DS_Store' \
          --exclude='*.md' \
          --exclude='.github' \
          --exclude='.claude' \
          --exclude='.cursor' \
          --exclude='.bmad-core' \
          --exclude='.playwright-mcp' \
          --exclude='deploy-package' \
          ./ deploy-package/
        
        echo "✅ 部署包准备完成"
        
        # 显示包大小
        echo "部署包大小:"
        du -sh deploy-package
    
    - name: 🚀 Upload to Tencent Cloud Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 600s
        command_timeout: 600s
        script: |
          echo "准备接收部署文件..."
          # 确保上传目录存在且权限正确
          sudo rm -rf /opt/intent-test-framework-upload-tmp
          sudo mkdir -p /opt/intent-test-framework-upload-tmp
          sudo chown -R $USER:$USER /opt/intent-test-framework-upload-tmp
          echo "✅ 上传目录已准备完成"
    
    - name: 📦 Transfer Files via Rsync
      run: |
        echo "开始传输文件到服务器..."
        
        # 配置 SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # 使用 rsync 传输文件
        rsync -avz --progress \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          deploy-package/ \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/intent-test-framework-upload-tmp/
        
        echo "✅ 文件传输完成"
        
        # 清理 SSH 密钥
        rm -f ~/.ssh/deploy_key
    
    - name: 🚀 Deploy on Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 1800s
        command_timeout: 1800s
        script: |
          
          echo "=========================================="
          echo "🚀 开始部署"
          echo "=========================================="
          
          # 复制上传的文件到部署目录
          echo "📦 同步文件..."
          sudo rsync -a --delete /opt/intent-test-framework-upload-tmp/ /opt/intent-test-framework/
          sudo chown -R $USER:$USER /opt/intent-test-framework
          
          # 切换到部署目录
          cd /opt/intent-test-framework
          
          # 构建代理包（确保 ZIP 文件存在）
          echo "📦 构建本地代理包..."
          
          # 检查 dist/intent-test-proxy 目录是否存在
          if [ ! -d "dist/intent-test-proxy" ]; then
            echo "❌ 错误：dist/intent-test-proxy 目录不存在"
          else
            # 尝试使用 Node.js 构建（包含所有功能）
            if command -v node &> /dev/null; then
              node scripts/build-proxy-package.js
              echo "✅ 使用 Node.js 构建代理包完成"
            else
              # 后备方案：使用 Python 创建 ZIP（服务器肯定有 Python）
              echo "⚠️ Node.js 未安装，使用 Python 创建 ZIP 文件"
              
              python3 << 'PYEOF'
import zipfile
import os
from pathlib import Path

dist_dir = Path('dist')
source_dir = dist_dir / 'intent-test-proxy'
zip_path = dist_dir / 'intent-test-proxy.zip'

# 删除旧的 ZIP 文件
if zip_path.exists():
    zip_path.unlink()
    print(f"删除旧的 ZIP 文件: {zip_path}")

# 创建 ZIP 文件
print(f"创建 ZIP 文件: {zip_path}")
with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
    for file_path in source_dir.rglob('*'):
        if file_path.is_file():
            arcname = file_path.relative_to(dist_dir)
            zipf.write(file_path, arcname)
            print(f"  添加: {arcname}")

# 验证文件
if zip_path.exists():
    size_mb = zip_path.stat().st_size / (1024 * 1024)
    print(f"✅ ZIP 文件创建成功: {zip_path} ({size_mb:.2f} MB)")
    os.chmod(zip_path, 0o644)
else:
    print("❌ ZIP 文件创建失败")
    exit(1)
PYEOF
              
              echo "✅ Python ZIP 创建完成"
              ls -lh dist/intent-test-proxy.zip
            fi
          fi
          
          # 确保脚本有执行权限
          chmod +x scripts/deploy.sh
          
          # 执行统一部署脚本（生产环境）
          bash scripts/deploy.sh production
          
          echo "=========================================="
          echo "✅ 部署完成"
          echo "=========================================="
    
    - name: 📊 Deployment Summary
      if: success()
      run: |
        echo ""
        echo "=========================================="
        echo "🎉 部署成功！"
        echo "=========================================="
        echo "✅ API 测试已通过"
        echo "✅ 代码已通过 SCP 推送到腾讯云服务器"
        echo "✅ 服务已重启并通过健康检查"
        echo "🌐 访问地址: http://${{ secrets.SERVER_HOST }}:5001"
        echo "=========================================="
    
    - name: 📊 Deployment Failed
      if: failure()
      run: |
        echo ""
        echo "=========================================="
        echo "❌ 部署失败"
        echo "=========================================="
        echo "请检查 GitHub Actions 日志以获取详细错误信息"
        echo "如果是服务器端错误，SSH 登录服务器查看日志："
        echo "  ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        echo "  docker-compose -f /opt/intent-test-framework/docker-compose.prod.yml logs"
        echo "=========================================="
