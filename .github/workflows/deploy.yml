name: Deploy to Tencent Cloud via SCP/SSH

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•ç›´æ¥éƒ¨ç½² (ä»…ç”¨äºç´§æ€¥ä¿®å¤)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - 'production'

jobs:
  # ====================================
  # é˜¶æ®µ 1a: Intent Tester API æµ‹è¯•
  # ====================================
  intent-tester-test:
    name: Intent Tester API Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ğŸ§ª Run Intent Tester tests
      run: |
        echo "::group::Running Intent Tester API Tests"
        export PYTHONPATH=$PYTHONPATH:$(pwd):$(pwd)/tools/intent-tester
        python -m pytest tools/intent-tester/tests/ -v --cov=tools/intent-tester/backend --cov-report=term
        echo "::endgroup::"

  # ====================================
  # é˜¶æ®µ 1b: AI Agents API æµ‹è¯•
  # ====================================
  ai-agents-test:
    name: AI Agents API Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ğŸ§ª Run AI Agents tests
      run: |
        echo "::group::Running AI Agents API Tests"
        export PYTHONPATH=$PYTHONPATH:$(pwd):$(pwd)/tools/ai-agents
        python -m pytest tools/ai-agents/tests/ -v --cov=tools/ai-agents/backend --cov-report=term
        echo "::endgroup::"

  # ====================================
  # é˜¶æ®µ 1c: ä»£ç è´¨é‡æ£€æŸ¥
  # ====================================
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“Š Code quality check
      run: |
        echo "::group::Code Quality Analysis"
        pip install flake8
        flake8 tools/intent-tester/backend tools/ai-agents/backend --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo "::endgroup::"

  # ====================================
  # é˜¶æ®µ 1.5: MidScene ä»£ç†æµ‹è¯• (Node.js)
  # ====================================
  proxy-test:
    name: MidScene Proxy Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: tools/intent-tester
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      with:
        path: '.' # Checkout to current dir (redundant but explicit)
    
    - name: ğŸ“¥ Relocate for consistency
      run: |
        # Ensure we are in the project root first, though checkout defaults to it
        cd $GITHUB_WORKSPACE
        
    - name: ğŸŸ¢ Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
    
    - name: ğŸ§ª Run proxy tests
      run: |
        echo "::group::Running MidScene Proxy Tests"
        npx jest --testPathPatterns="tests/proxy" --passWithNoTests --forceExit
        echo "::endgroup::"

  # ====================================
  # é˜¶æ®µ 2: æ„å»ºå’Œéƒ¨ç½²ï¼ˆSCP/SSH æ¨é€æ¨¡å¼ï¼‰
  # ====================================
  deploy-to-production:
    name: Build and Deploy to Tencent Cloud
    needs: [intent-tester-test, ai-agents-test, proxy-test]  # å¿…é¡»ç­‰å¾…æ‰€æœ‰æµ‹è¯•å®Œæˆä¸”æˆåŠŸ
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://www.datou212.tech
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸŸ¢ Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: ğŸ“¦ Build proxy package
      run: |
        echo "æ„å»ºæœ¬åœ°ä»£ç†åŒ…..."
        node scripts/ci/build-proxy-package.js
        echo "âœ… ä»£ç†åŒ…æ„å»ºå®Œæˆ"
        ls -lh dist/intent-test-proxy.zip
    
    - name: âš›ï¸ Build React frontend (AI Agents)
      run: |
        echo "æ„å»º React å‰ç«¯..."
        cd tools/ai-agents/frontend
        npm ci
        npm run build
        echo "âœ… React å‰ç«¯æ„å»ºå®Œæˆ"
        ls -lh dist/
    
    - name: ğŸ“¦ Prepare deployment package
      run: |
        echo "å‡†å¤‡éƒ¨ç½²åŒ…..."
        
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deploy-package
        
        # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
        rsync -av --progress \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='.coverage' \
          --exclude='logs' \
          --exclude='.env' \
          --exclude='.DS_Store' \
          --exclude='.github' \
          --exclude='.claude' \
          --exclude='.cursor' \
          --exclude='.bmad-core' \
          --exclude='.playwright-mcp' \
          --exclude='deploy-package' \
          ./ deploy-package/
        
        echo "âœ… éƒ¨ç½²åŒ…å‡†å¤‡å®Œæˆ"
        
        # æ˜¾ç¤ºåŒ…å¤§å°
        echo "éƒ¨ç½²åŒ…å¤§å°:"
        du -sh deploy-package
    
    - name: ğŸš€ Upload to Tencent Cloud Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 600s
        command_timeout: 600s
        script: |
          echo "å‡†å¤‡æ¥æ”¶éƒ¨ç½²æ–‡ä»¶..."
          # ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨ä¸”æƒé™æ­£ç¡®
          sudo rm -rf /opt/intent-test-framework-upload-tmp
          sudo mkdir -p /opt/intent-test-framework-upload-tmp
          sudo chown -R $USER:$USER /opt/intent-test-framework-upload-tmp
          echo "âœ… ä¸Šä¼ ç›®å½•å·²å‡†å¤‡å®Œæˆ"
    
    - name: ğŸ“¦ Transfer Files via Rsync
      run: |
        echo "å¼€å§‹ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
        
        # é…ç½® SSH
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
        # ä½¿ç”¨ rsync ä¼ è¾“æ–‡ä»¶
        rsync -avz --progress \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          deploy-package/ \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/intent-test-framework-upload-tmp/
        
        echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"
        
        # æ¸…ç† SSH å¯†é’¥
        rm -f ~/.ssh/deploy_key
    
    - name: ğŸš€ Deploy on Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 1800s
        command_timeout: 1800s
        script: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼Œé˜²æ­¢è™šå‡æˆåŠŸ
          
          echo "=========================================="
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²"
          echo "=========================================="
          
          # å¤åˆ¶ä¸Šä¼ çš„æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
          echo "ğŸ“¦ åŒæ­¥æ–‡ä»¶..."
          sudo rsync -a --delete /opt/intent-test-framework-upload-tmp/ /opt/intent-test-framework/
          sudo chown -R $USER:$USER /opt/intent-test-framework
          
          # åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
          cd /opt/intent-test-framework
          
          # ==========================================
          # æ­¥éª¤1: é…ç½®ç¯å¢ƒå˜é‡
          # ==========================================
          echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
          
          # åˆ›å»º.envæ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -f .env ]; then
            echo "åˆ›å»ºæ–°çš„.envæ–‡ä»¶..."
            cat > .env << 'ENVEOF'
          DB_USER=intent_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          FLASK_ENV=production
          ENVEOF
            echo "âœ… .envæ–‡ä»¶å·²åˆ›å»º"
          else
            echo "âœ… .envæ–‡ä»¶å·²å­˜åœ¨ï¼Œæ›´æ–°å…³é”®é…ç½®..."
            # æ›´æ–°å¯†ç å’Œå¯†é’¥ï¼ˆå¦‚æœç¼ºå¤±ï¼‰
            grep -q "DB_PASSWORD=" .env || echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            grep -q "SECRET_KEY=" .env || echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          fi
          
          # ==========================================
          # æ­¥éª¤2: æ£€æŸ¥æ•°æ®åº“è¿ç§»éœ€æ±‚
          # ==========================================
          echo "ğŸ” æ£€æŸ¥æ•°æ®åº“è¿ç§»éœ€æ±‚..."
          
          NEED_MIGRATION=false
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—§çš„langfuseæ•°æ®åº“å®¹å™¨
          if docker ps -a --format '{{.Names}}' | grep -q "^langfuse-postgres-1$"; then
            echo "âš ï¸ æ£€æµ‹åˆ°æ—§çš„langfuse-postgres-1å®¹å™¨"
            
            # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ–°çš„æ•°æ®åº“å®¹å™¨
            if docker ps -a --format '{{.Names}}' | grep -q "^intent-test-db-prod$"; then
              echo "âœ… æ–°æ•°æ®åº“å®¹å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡è¿ç§»"
              NEED_MIGRATION=false
            else
              echo "éœ€è¦æ‰§è¡Œæ•°æ®åº“è¿ç§»"
              NEED_MIGRATION=true
            fi
          else
            echo "âœ… æœªæ£€æµ‹åˆ°æ—§æ•°æ®åº“ï¼Œå…¨æ–°éƒ¨ç½²"
            NEED_MIGRATION=false
          fi
          
          # ==========================================
          # æ­¥éª¤3: æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰
          # ==========================================
          if [ "$NEED_MIGRATION" = true ]; then
            echo "ğŸ“Š å¼€å§‹æ•°æ®åº“è¿ç§»..."
            echo "::group::Database Migration"
            
            # å…ˆå¯åŠ¨æ–°çš„PostgreSQLå®¹å™¨
            echo "å¯åŠ¨æ–°çš„PostgreSQLå®¹å™¨..."
            sudo docker-compose -f docker-compose.prod.yml up -d postgres
            
            # ç­‰å¾…æ•°æ®åº“å°±ç»ª
            echo "ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
            sleep 10
            
            # æ‰§è¡Œè¿ç§»è„šæœ¬
            chmod +x scripts/migrate_langfuse_to_local.sh
            
            # éäº¤äº’æ¨¡å¼æ‰§è¡Œè¿ç§»
            if ./scripts/migrate_langfuse_to_local.sh; then
              echo "âœ… æ•°æ®åº“è¿ç§»æˆåŠŸ"
            else
              echo "âŒ æ•°æ®åº“è¿ç§»å¤±è´¥"
              echo "::endgroup::"
              exit 1
            fi
            
            echo "::endgroup::"
          else
            echo "è·³è¿‡æ•°æ®åº“è¿ç§»æ­¥éª¤"
          fi
          
          # ==========================================
          # æ­¥éª¤4: æ£€æŸ¥ä»£ç†åŒ…
          # ==========================================
          echo "ğŸ“¦ æ£€æŸ¥ä»£ç†åŒ…..."
          if [ -d "dist/intent-test-proxy" ] || [ -f "dist/intent-test-proxy.zip" ]; then
             echo "âœ… ä»£ç†åŒ…å·²é€šè¿‡ rsync åŒæ­¥"
             ls -lh dist/intent-test-proxy.zip || true
          else
             echo "âš ï¸ è­¦å‘Š: dist/intent-test-proxy æœªæ‰¾åˆ°"
          fi
          
          # ==========================================
          # æ­¥éª¤5: æ‰§è¡Œéƒ¨ç½²
          # ==========================================
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x scripts/ci/deploy.sh
          
          # æ‰§è¡Œç»Ÿä¸€éƒ¨ç½²è„šæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
          bash scripts/ci/deploy.sh production
          
          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "=========================================="
    
    - name: ğŸ“Š Deployment Summary
      if: success()
      run: |
        echo ""
        echo "=========================================="
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "=========================================="
        echo "âœ… API æµ‹è¯•å·²é€šè¿‡"
        echo "âœ… ä»£ç å·²é€šè¿‡ SCP æ¨é€åˆ°è…¾è®¯äº‘æœåŠ¡å™¨"
        echo "âœ… æœåŠ¡å·²é‡å¯å¹¶é€šè¿‡å¥åº·æ£€æŸ¥"
        echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }} (é€šè¿‡ Nginx 80 ç«¯å£)"
        echo "=========================================="
    
    - name: ğŸ“Š Deployment Failed
      if: failure()
      run: |
        echo ""
        echo "=========================================="
        echo "âŒ éƒ¨ç½²å¤±è´¥"
        echo "=========================================="
        echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        echo "å¦‚æœæ˜¯æœåŠ¡å™¨ç«¯é”™è¯¯ï¼ŒSSH ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—ï¼š"
        echo "  ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        echo "  docker-compose -f /opt/intent-test-framework/docker-compose.prod.yml logs"
        echo "=========================================="
