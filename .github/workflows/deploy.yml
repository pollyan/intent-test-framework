name: Deploy to Tencent Cloud via SCP/SSH

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ====================================
  # é˜¶æ®µ 1: API æµ‹è¯•
  # ====================================
  api-test:
    name: API Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ğŸ§ª Run API tests
      run: |
        echo "::group::Running API Integration Tests"
        # ä½¿ç”¨å†…å­˜æ•°æ®åº“è¿è¡Œæµ‹è¯•
        DATABASE_URL=sqlite:///:memory: pytest tests/api/ -v --cov=web_gui --cov-report=term
        echo "::endgroup::"
    
    - name: ğŸ“Š Code quality check
      run: |
        echo "::group::Code Quality Analysis"
        pip install flake8
        flake8 web_gui --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo "::endgroup::"

  # ====================================
  # é˜¶æ®µ 2: æ„å»ºå’Œéƒ¨ç½²ï¼ˆSCP/SSH æ¨é€æ¨¡å¼ï¼‰
  # ====================================
  deploy-to-production:
    name: Build and Deploy to Tencent Cloud
    needs: api-test  # å¿…é¡»ç­‰å¾… api-test å®Œæˆä¸”æˆåŠŸ
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ“¦ Prepare deployment package
      run: |
        echo "å‡†å¤‡éƒ¨ç½²åŒ…..."
        
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deploy-package
        
        # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
        rsync -av --progress \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='.coverage' \
          --exclude='logs' \
          --exclude='.env' \
          --exclude='.DS_Store' \
          --exclude='*.md' \
          --exclude='dist' \
          --exclude='.github' \
          --exclude='.claude' \
          --exclude='.cursor' \
          --exclude='.bmad-core' \
          --exclude='.playwright-mcp' \
          --exclude='deploy-package' \
          ./ deploy-package/
        
        echo "âœ… éƒ¨ç½²åŒ…å‡†å¤‡å®Œæˆ"
        
        # æ˜¾ç¤ºåŒ…å¤§å°
        echo "éƒ¨ç½²åŒ…å¤§å°:"
        du -sh deploy-package
    
    - name: ğŸ”§ Prepare Server Upload Directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 60s
        script: |
          # æ¸…ç†å¹¶åˆ›å»ºä¸Šä¼ ç›®å½•
          sudo rm -rf /opt/intent-test-framework-upload-tmp
          sudo mkdir -p /opt/intent-test-framework-upload-tmp
          sudo chown -R $USER:$USER /opt/intent-test-framework-upload-tmp
          sudo chmod 755 /opt/intent-test-framework-upload-tmp
          echo "âœ… ä¸Šä¼ ç›®å½•å·²å‡†å¤‡å®Œæˆ"
    
    - name: ğŸš€ Upload to Tencent Cloud Server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "deploy-package/*"
        target: "/opt/intent-test-framework-upload-tmp"
        strip_components: 1
        rm: true
        timeout: 300s
    
    - name: ğŸ”§ Deploy on Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 600s
        command_timeout: 600s
        script: |
          set -e
          
          echo "=========================================="
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²æµç¨‹"
          echo "=========================================="
          
          # ç§»åŠ¨ä¸Šä¼ çš„æ–‡ä»¶åˆ°æ­£å¼çš„ä¸Šä¼ ç›®å½•
          echo "ğŸ“¦ æ•´ç†ä¸Šä¼ æ–‡ä»¶..."
          sudo rm -rf /opt/intent-test-framework-upload
          sudo mv /opt/intent-test-framework-upload-tmp /opt/intent-test-framework-upload
          sudo chown -R $USER:$USER /opt/intent-test-framework-upload
          
          # ç¡®ä¿éƒ¨ç½²è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x /opt/intent-test-framework-upload/scripts/deploy-from-upload.sh
          
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "ğŸ”¨ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
          sudo bash /opt/intent-test-framework-upload/scripts/deploy-from-upload.sh
          
          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "=========================================="
    
    - name: ğŸ“Š Deployment Summary
      if: success()
      run: |
        echo ""
        echo "=========================================="
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "=========================================="
        echo "âœ… API æµ‹è¯•å·²é€šè¿‡"
        echo "âœ… ä»£ç å·²é€šè¿‡ SCP æ¨é€åˆ°è…¾è®¯äº‘æœåŠ¡å™¨"
        echo "âœ… æœåŠ¡å·²é‡å¯å¹¶é€šè¿‡å¥åº·æ£€æŸ¥"
        echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}:5001"
        echo "=========================================="
    
    - name: ğŸ“Š Deployment Failed
      if: failure()
      run: |
        echo ""
        echo "=========================================="
        echo "âŒ éƒ¨ç½²å¤±è´¥"
        echo "=========================================="
        echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        echo "å¦‚æœæ˜¯æœåŠ¡å™¨ç«¯é”™è¯¯ï¼ŒSSH ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—ï¼š"
        echo "  ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        echo "  docker-compose -f /opt/intent-test-framework/docker-compose.prod.yml logs"
        echo "=========================================="
