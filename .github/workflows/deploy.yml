name: API Testing and Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ====================================
  # é˜¶æ®µ 1: API æµ‹è¯•
  # ====================================
  api-test:
    name: API Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ğŸ§ª Run API tests
      run: |
        echo "::group::Running API Integration Tests"
        # ä½¿ç”¨å†…å­˜æ•°æ®åº“è¿è¡Œæµ‹è¯•
        DATABASE_URL=sqlite:///:memory: pytest tests/api/ -v --cov=web_gui --cov-report=term
        echo "::endgroup::"
    
    - name: ğŸ“Š Code quality check
      run: |
        echo "::group::Code Quality Analysis"
        pip install flake8
        flake8 web_gui --count --select=E9,F63,F7,F82 --show-source --statistics || true
        echo "::endgroup::"

  # ====================================
  # é˜¶æ®µ 2: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆä¸²è¡Œæ‰§è¡Œï¼Œä¾èµ–æµ‹è¯•é€šè¿‡ï¼‰
  # ====================================
  deploy-to-production:
    name: Deploy to Tencent Cloud
    needs: api-test  # å¿…é¡»ç­‰å¾… api-test å®Œæˆä¸”æˆåŠŸ
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸš€ Deploy to Tencent Cloud Server
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        # é…ç½® SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
        
        # éƒ¨ç½²åˆ°æœåŠ¡å™¨
        ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'ENDSSH'
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          
          # æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "/opt/intent-test-framework/.git" ]; then
            echo "ğŸ“¦ é¦–æ¬¡éƒ¨ç½²ï¼Œå…‹éš†ä»£ç ä»“åº“..."
            cd /opt
            sudo rm -rf intent-test-framework
            sudo mkdir -p intent-test-framework
            sudo chown $USER:$USER intent-test-framework
            cd intent-test-framework
            git clone https://github.com/$GITHUB_REPOSITORY.git .
            
            echo "ğŸ“ åˆ›å»º .env æ–‡ä»¶..."
            cat > .env << 'ENVEOF'
DATABASE_URL=postgresql://postgres.jzmqsuxphksbulrbhebp:Shunlian04@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres?sslmode=require&connect_timeout=15&application_name=prod
FLASK_ENV=production
WEB_PORT=5001
ENVEOF
            # ç”Ÿæˆ SECRET_KEY
            echo "SECRET_KEY=$(openssl rand -hex 32)" >> .env
            
            echo "âœ… ä»£ç å…‹éš†å®Œæˆ"
          fi
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /opt/intent-test-framework || {
            echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"
            exit 1
          }
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main || git pull origin master
          
          # å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨ï¼ˆå¯é€‰ï¼‰
          echo "ğŸ’¾ å¤‡ä»½å½“å‰é…ç½®..."
          docker-compose -f docker-compose.prod.yml ps > /tmp/deploy_backup.txt || true
          
          # é‡æ–°æ„å»ºé•œåƒ
          echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
          docker-compose -f docker-compose.prod.yml build --no-cache web-app
          
          # é‡å¯æœåŠ¡
          echo "â™»ï¸  é‡å¯æœåŠ¡..."
          docker-compose -f docker-compose.prod.yml up -d
          
          # æ¸…ç†æ—§é•œåƒ
          echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
          docker image prune -f
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
          if curl -f http://localhost:5001/health; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            docker-compose -f docker-compose.prod.yml logs --tail=50 web-app
            exit 1
          fi
          
          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
          docker-compose -f docker-compose.prod.yml ps
        ENDSSH
        
        echo ""
        echo "=========================================="
        echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆï¼"
        echo "=========================================="
        echo "âœ… API æµ‹è¯•å·²é€šè¿‡"
        echo "âœ… ä»£ç å·²éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨"
        echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}:5001"
        echo "=========================================="
