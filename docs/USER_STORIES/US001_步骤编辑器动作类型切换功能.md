# 用户故事 US001: 步骤编辑器动作类型切换功能

**创建日期**: 2025-01-27  
**优先级**: 高  
**状态**: 待开发  
**预估工作量**: 3-5天  

## 📋 需求概述

**背景**: 用户在编辑测试用例步骤时，需要能够更改步骤的动作类型，但当前的动作类型选择器功能不可用。

**目标**: 实现当用户选择了新的动作类型时，能够自动更新当前步骤为用户选择的动作类型，并对应更新动作参数为合理的默认值。

## 🎯 业务价值

- **提升编辑效率**: 减少70%的重复配置工作
- **降低学习成本**: 自动提供合理默认值，减少用户认知负担  
- **增强用户体验**: 提供流畅的所见即所得编辑体验
- **提高测试质量**: 减少因重新创建步骤导致的配置错误

## 👥 用户画像

**主要用户**: 测试工程师（5-20人团队）  
**技术水平**: 具备基本编程能力，熟悉测试流程  
**使用场景**: 日常测试用例创建、执行、调试、维护  

## 📊 用户场景分析

### 核心业务场景

1. **原型调试场景**: 测试编写者在创建测试用例时，经常需要尝试不同的动作类型来找到最合适的实现方式
2. **需求变更场景**: 业务需求发生变化，原有的测试步骤需要调整动作类型
3. **优化重构场景**: 用户在使用过程中发现更适合的动作类型，需要将现有步骤升级到更好的实现方式
4. **复制修改场景**: 基于现有步骤创建类似功能，但需要不同的动作类型来实现细微差异

### 用户痛点

**当前问题**:
- 必须删除整个步骤后重新创建，流程繁琐
- 已配置的步骤信息（描述、部分参数）会丢失
- 打断用户的编辑流程，影响工作效率
- 增加出错概率，降低测试用例质量

## 🚀 用户故事

### 故事1: 基础动作类型切换
**作为** 测试编写者  
**我希望** 能够直接更改步骤的动作类型  
**以便** 快速调整测试逻辑而无需重新创建步骤  

**验收条件**:
```gherkin
Given 我正在编辑一个测试步骤
When 我在动作类型下拉框中选择新的类型
Then 动作类型选择器应该立即更新为新选择的值
And 参数文本区域应该在500毫秒内自动更新
And 新的参数应该是选定动作类型的有效默认值JSON格式
And 参数JSON应该通过格式验证
```

### 故事2: 智能参数保留
**作为** 测试编写者  
**我希望** 切换动作类型时系统能保留兼容的参数  
**以便** 避免重复输入相同信息  

**验收条件**:
```gherkin
Given 我有一个包含"locate"参数的aiTap步骤 
When 我将动作类型切换为aiInput
Then "locate"参数的值应该被保留
And "text"参数应该被设置为默认值
And 原有的其他兼容参数应该被保留
And 不兼容的参数应该被移除
And 缺失的必需参数应该被添加为默认值
```

### 故事3: 安全确认机制
**作为** 测试编写者  
**我希望** 在切换可能丢失重要参数的动作类型时收到确认提示  
**以便** 避免意外的数据丢失  

**验收条件**:
```gherkin
Given 我有一个包含复杂参数配置的步骤（JSON长度>100字符）
When 我切换到参数结构完全不同的动作类型
Then 系统应该显示确认对话框
And 对话框应该清楚说明将会丢失的参数信息
And 提供"保留兼容参数"和"完全重置"两个选项
And 我选择"取消"时应该恢复到原动作类型
And 我选择"确认"时应该执行参数更新
```

### 故事4: 操作反馈与引导
**作为** 测试编写者  
**我希望** 获得清晰的操作反馈和参数说明  
**以便** 理解参数变化并正确配置新参数  

**验收条件**:
```gherkin  
Given 我切换了步骤的动作类型
When 参数更新完成后
Then 参数文本框应该显示绿色边框闪烁效果（持续1秒）
And 参数文本框右上角应该显示"已自动更新"标记
And 鼠标悬停在参数说明区域时应该显示详细的参数格式说明
And 动作类型选择框的选项应该按功能分组显示
And 每个选项应该包含简洁的功能描述
```

### 故事5: 撤销恢复功能
**作为** 测试编写者  
**我希望** 能够撤销动作类型的更改  
**以便** 在发现切换错误时快速恢复  

**验收条件**:
```gherkin
Given 我已经切换了步骤的动作类型和参数
When 我发现切换错误需要恢复
Then 我应该能够通过"撤销更改"按钮恢复到切换前的状态
And 撤销操作应该同时恢复动作类型和参数
And 撤销后的参数应该与切换前完全一致
And 系统应该显示"已撤销更改"的确认消息
And 撤销功能应该在保存步骤后失效
```

## 🛠️ 功能需求详细拆解

### 核心交互流程
```
用户编辑步骤 → 选择新动作类型 → 系统检测变化 → 智能更新参数 → 用户确认保存
```

**详细流程设计**:
1. 用户点击步骤的"编辑"按钮，显示内联编辑表单
2. 用户在"动作类型"下拉选择器中选择新的动作类型
3. **关键时刻**: 系统检测到 `change` 事件，触发参数更新逻辑
4. 系统根据新动作类型和参数保留策略更新参数JSON
5. 参数文本区域自动更新，高亮显示变更内容
6. 显示操作反馈提示用户参数已更新
7. 用户在默认参数基础上进行微调
8. 用户点击"保存步骤"完成修改

### 支持的动作类型范围
**系统需要支持全部动作类型的相互切换**:
- **页面导航类**: `goto`, `refresh`, `back`, `evaluateJavaScript`
- **智能交互类**: `ai`, `aiTap`, `aiInput`, `aiHover`, `aiScroll`, `aiKeyboardPress`, `aiRightClick`  
- **数据提取类**: `aiQuery`, `aiAsk`, `aiBoolean`, `aiNumber`, `aiString`, `aiLocate`
- **验证等待类**: `aiAssert`, `aiWaitFor`
- **工具操作类**: `logScreenshot`, `sleep`, `runYaml`

### 参数更新策略

**智能参数保留逻辑**:

1. **完全兼容**: 参数名称和类型完全匹配时保留原值
   - 例如: `aiTap` 的 `locate` 参数切换到 `aiInput` 时保留

2. **部分兼容**: 参数名称相同但语义相近时保留并转换
   - 例如: `goto` 的 `url` 参数在某些情况下可以保留为字符串参数

3. **不兼容**: 参数结构完全不同时使用默认值
   - 例如: 从 `aiQuery` 的复杂 `schema` 参数切换到 `sleep` 的 `duration` 参数

## ⚠️ 边界条件和异常情况

### 数据安全保护

**用户确认机制触发条件**:
- 原步骤参数JSON超过100字符
- 切换的新动作类型兼容参数少于50%
- 包含数组或嵌套对象等复杂数据结构

**确认对话框设计**:
```
⚠️ 切换动作类型将会重置参数

当前参数包含复杂配置，切换到新的动作类型将丢失以下信息：
• schema 配置（3个字段定义）
• options 选项设置
• 自定义超时时间

□ 保留兼容参数（推荐）
□ 完全重置为默认值

[取消] [确认切换]
```

### 错误处理机制

**参数格式验证**:
- JSON语法实时检查，无效格式高亮显示错误
- 必填参数缺失时显示警告图标和提示信息
- 参数类型检查（字符串、数字、布尔值、对象）

**异常恢复**:
- 切换失败时自动回滚到原动作类型
- 提供"撤销更改"功能恢复到切换前状态
- 网络错误时保留用户输入，避免数据丢失

## 🎨 用户体验设计要求

### 视觉反馈设计

**实时状态指示**:
- 动作类型选择时，选项按分组显示并附带简洁描述
- 参数更新时显示微妙的加载动画（200ms）
- 更新完成后参数文本框绿色边框闪烁提示变更

**信息提示优化**:
- 参数文本框右上角显示 `已自动更新` 标记
- 区分显示"默认值"和"保留原值"的参数
- 鼠标悬停显示参数说明和示例值

### 交互体验优化  

**帮助引导**:
- 动作类型选择框支持搜索和分类筛选
- 参数文本框下方显示当前动作类型的参数模板
- 提供"查看示例"链接展示典型用法

**键盘操作支持**:
- `Ctrl+Z` 撤销参数更改
- `Tab` 键快速在表单字段间切换
- `Enter` 键保存当前步骤

## 🔧 技术实现考虑

### 前端实现需求

**状态管理**:
- 维护参数变更历史栈支持撤销操作
- 跟踪参数来源（自动生成 vs 用户修改）
- 保存切换前状态用于错误恢复

**事件处理架构**:
```javascript
// 动作类型切换监听
document.getElementById(`edit-action-${index}`).addEventListener('change', (e) => {
    const newAction = e.target.value;
    const oldParams = getCurrentParams();
    const newParams = this.mergeParamsOnActionChange(oldAction, newAction, oldParams);
    this.updateParamsTextarea(newParams, index);
});
```

**参数合并算法核心逻辑**:
1. 解析当前参数JSON
2. 获取新动作类型的默认参数模板  
3. 执行智能参数映射和保留
4. 生成新的参数JSON并格式化显示

### 后端API适配

**现有API兼容性**: 
- 步骤更新 API (`PUT /api/testcases/{id}/steps/{step_id}`) 已支持动作类型变更
- 参数验证逻辑需要增强对动态动作类型的支持

**数据验证增强**:
- 动作类型和参数组合的有效性验证
- 参数 schema 动态验证机制
- 并发编辑检测和冲突解决

## 📈 实施计划

### 功能优先级分级

**P0 (核心功能 - 必须实现)**:
- 动作类型选择器change事件监听 
- 基础参数默认值更新逻辑
- 更新后的保存功能正常工作

**P1 (用户体验优化 - 强烈建议)**:
- 智能参数保留逻辑
- 用户确认提示机制  
- 基础视觉反馈和状态提示

**P2 (高级功能 - 锦上添花)**:
- 撤销恢复机制
- 高级参数合并算法
- 详细帮助引导和示例

### 风险评估

**技术实现风险: 低**
- 主要涉及前端JavaScript开发，技术成熟
- 现有代码基础良好，扩展性强
- 后端API基本无需修改

**用户体验风险: 中**  
- 参数保留逻辑复杂，需要仔细设计和测试
- 不同动作类型间的参数兼容性判断需要大量测试用例
- 确认对话框的文案和交互需要用户测试验证

**数据安全风险: 低**
- 主要是前端操作，后端已有完善的数据验证
- 参数更新不影响历史执行记录
- 自动保存机制可以防止意外数据丢失

## 📊 成功指标

### 功能指标
- 23种动作类型间100%支持相互切换
- 参数保留准确率 >90%
- 操作响应时间 <500ms

### 用户体验指标  
- 用户编辑效率提升 >70%
- 参数配置错误率降低 >50%
- 用户满意度评分 >4.5/5.0

## 📝 测试策略

### 单元测试
- 参数合并算法的各种边界情况
- 动作类型兼容性判断逻辑
- 默认值生成的正确性

### 集成测试
- 前端表单与后端API的数据传输
- 并发编辑场景的数据一致性
- 异常情况下的错误处理

### 用户验收测试
- 真实用户场景的端到端测试
- 不同动作类型切换的用户体验
- 确认对话框的易用性测试

---

**需求状态**: 已分析完成，待开发实现  
**下一步**: 开始P0功能的技术实现  
**负责人**: 开发团队  
**评审人**: 产品经理、QA团队