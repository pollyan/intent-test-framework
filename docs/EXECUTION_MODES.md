# 执行模式架构说明

## 🎯 三种执行模式对比

### 1. 🌉 Chrome桥接模式（客户端执行）
**执行路径**：`WebUI生成脚本 → 用户下载脚本 → 本地Node.js执行 → 连接Chrome扩展 → 浏览器自动化`

**特点**：
- ✅ **真正的本地执行**：在用户的本地环境中执行，连接到Chrome扩展
- ✅ **可视化过程**：用户可以看到真实的浏览器操作过程
- ✅ **无网络延迟**：完全本地执行，响应迅速
- ✅ **调试友好**：便于测试开发、调试和人机协作
- ✅ **利用本地环境**：使用用户的cookies、插件、登录状态
- ❌ **环境要求**：需要安装官方MidSceneJS Chrome扩展和Node.js
- ❌ **设置复杂**：需要配置本地环境和AI API密钥

**适用场景**：
- 测试用例开发和调试
- 演示和培训
- 需要可视化执行过程的场景
- 人机协作的自动化任务

### 2. ☁️ 云端模式（服务器执行）
**执行路径**：`WebUI → Vercel API → Playwright云端执行`

**特点**：
- ✅ **无环境依赖**：不需要本地安装任何软件
- ✅ **稳定可靠**：云端环境一致性好
- ✅ **CI/CD友好**：适合自动化流水线
- ✅ **并发执行**：支持多个测试同时运行
- ❌ **不可视化**：看不到执行过程
- ❌ **网络依赖**：需要稳定的网络连接

**适用场景**：
- 回归测试
- CI/CD集成
- 批量测试执行

### 3. 🏠 本地模式（本地服务器）
**执行路径**：`WebUI → 本地Python服务 → 本地Playwright执行`

**特点**：
- ✅ **完全本地控制**：所有执行都在本地
- ✅ **高性能**：无网络延迟
- ✅ **隐私安全**：数据不离开本地
- ❌ **环境要求**：需要本地安装Python和Playwright
- ❌ **配置复杂**：需要启动本地服务

**适用场景**：
- 开发环境测试
- 对隐私要求高的场景
- 需要高性能执行的场景

## 🔧 技术实现细节

### Chrome桥接模式实现
```javascript
// 1. 生成MidSceneJS脚本
function generateMidSceneScript(testcase, mode) {
    // 解析测试步骤
    // 生成AgentOverChromeBridge脚本
    // 返回可执行的Node.js脚本
}

// 2. 提供脚本下载
function downloadScript(content, filename) {
    // 创建下载链接
    // 自动下载脚本文件
}

// 3. 用户本地执行
// 用户在本地运行：node script.mjs
// 脚本通过AgentOverChromeBridge连接Chrome扩展
// 在用户的Chrome浏览器中执行自动化
```

### 云端模式实现
```javascript
// 1. 发送到服务器
const response = await axios.post('/api/executions/start', {
    testcase_id: testcaseId,
    mode: mode,
    execution_type: 'cloud'
});

// 2. 轮询执行状态
function startPolling(executionId) {
    // 定期查询执行进度
    // 更新UI状态
}
```

## 🚀 使用指南

### 选择执行模式的建议

1. **开发阶段**：使用Chrome桥接模式
   - 可以看到执行过程
   - 便于调试和优化

2. **测试阶段**：使用云端模式
   - 稳定可靠
   - 不受本地环境影响

3. **生产阶段**：使用本地模式
   - 高性能
   - 数据安全

### 故障排除

#### Chrome桥接模式问题
1. **扩展未安装**：
   - 访问Chrome扩展商店
   - 搜索并安装MidSceneJS扩展

2. **扩展未配置**：
   - 在扩展中配置AI API密钥
   - 确保API密钥有效

3. **权限问题**：
   - 确保扩展有足够权限
   - 检查浏览器安全设置

#### 云端模式问题
1. **网络连接**：
   - 检查网络连接
   - 确认服务器状态

2. **API限制**：
   - 检查API配额
   - 确认服务可用性

#### 本地模式问题
1. **环境配置**：
   - 安装Python和依赖
   - 启动本地服务

2. **端口冲突**：
   - 检查端口占用
   - 修改配置文件

## 📊 性能对比

| 特性 | Chrome桥接 | 云端模式 | 本地模式 |
|------|------------|----------|----------|
| 执行速度 | 快 | 中等 | 最快 |
| 可视化 | ✅ | ❌ | ✅ |
| 环境要求 | 低 | 无 | 高 |
| 稳定性 | 中等 | 高 | 高 |
| 调试友好 | ✅ | ❌ | ✅ |
| CI/CD适用 | ❌ | ✅ | ✅ |

## 🔮 未来规划

1. **Chrome桥接模式增强**：
   - 支持更多浏览器
   - 增强扩展功能
   - 改进通信协议

2. **云端模式优化**：
   - 增加执行节点
   - 支持并发执行
   - 优化性能

3. **本地模式简化**：
   - 一键安装脚本
   - 图形化配置界面
   - 自动环境检测

## 📝 总结

正确的架构设计确保了：
- **Chrome桥接模式**：真正在客户端执行，不经过服务器
- **云端模式**：通过服务器API执行，适合自动化
- **本地模式**：本地服务器执行，兼顾性能和控制

每种模式都有其适用场景，用户可以根据需求选择最合适的执行方式。
