# 服务器部署步骤指南

## 前提条件

✅ 服务器信息：Ubuntu Server 24.04 LTS，IP: 120.53.220.231  
✅ 域名：www.datou212.tech（已解析到服务器IP）  
✅ 需要root或sudo权限

## 部署步骤

### 1️⃣ 提交代码到 GitHub

```bash
# 在本地执行（已完成）
git add scripts/deployment/
git commit -m "添加云主机部署脚本"
git push origin master
```

### 2️⃣ 登录到服务器

```bash
# 在本地终端执行
ssh root@120.53.220.231
# 或使用你配置的用户名
ssh your_username@120.53.220.231
```

### 3️⃣ 在服务器上克隆代码

```bash
# 在服务器上执行
cd /opt
git clone https://github.com/pollyan/intent-test-framework.git
cd intent-test-framework
```

### 4️⃣ 执行一键部署脚本

```bash
# 在服务器上执行
sudo bash scripts/deployment/deploy-all.sh
```

### 5️⃣ 按提示完成配置

部署过程中会提示你输入以下信息：

#### 数据库配置（步骤2）
- 数据库名称：直接回车使用默认 `intent_test_framework`
- 数据库用户名：直接回车使用默认 `intent_user`
- 数据库密码：输入一个强密码（请记住）

**保存数据库连接字符串**：
```
postgresql://intent_user:你的密码@localhost:5432/intent_test_framework
```

#### 环境变量配置（步骤4）

脚本会提示你编辑 `.env` 文件：

```bash
sudo -u appuser nano /opt/intent-test-framework/.env
```

**必须配置的内容**：

```env
# 数据库配置（使用上面保存的连接字符串）
DATABASE_URL=postgresql://intent_user:你的密码@localhost:5432/intent_test_framework

# Flask配置（生成强密钥）
SECRET_KEY=在服务器上执行: openssl rand -hex 32
FLASK_ENV=production
FLASK_DEBUG=False

# AI API配置（使用你的阿里云DashScope配置）
OPENAI_API_KEY=你的阿里云API密钥
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
MIDSCENE_MODEL_NAME=qwen-vl-max-latest

# 应用配置
PORT=5001
HOST=127.0.0.1
```

**生成 SECRET_KEY**：
```bash
openssl rand -hex 32
```
复制输出的密钥到 `.env` 文件的 `SECRET_KEY=` 后面。

编辑完成后：
- 按 `Ctrl + O` 保存
- 按 `Enter` 确认
- 按 `Ctrl + X` 退出

### 6️⃣ 验证部署

部署完成后，执行以下命令验证：

```bash
# 检查服务状态
sudo systemctl status intent-test-framework
sudo systemctl status nginx

# 测试健康检查
curl http://localhost:5001/health
curl http://www.datou212.tech/health

# 查看应用日志
sudo journalctl -u intent-test-framework -n 50
```

### 7️⃣ 访问网站

在浏览器中访问：
- **http://www.datou212.tech** ✅

---

## 方式二：手动上传代码（备选）

如果不使用 Git，可以通过 SCP 上传代码：

```bash
# 在本地执行
cd /Users/anhui/Documents
tar -czf intent-test-framework.tar.gz intent-test-framework/
scp intent-test-framework.tar.gz root@120.53.220.231:/opt/

# 登录服务器
ssh root@120.53.220.231

# 解压代码
cd /opt
tar -xzf intent-test-framework.tar.gz
cd intent-test-framework

# 执行部署脚本
sudo bash scripts/deployment/deploy-all.sh
```

---

## 常用服务管理命令

部署完成后，可以使用以下命令管理服务：

```bash
# 查看应用状态
sudo systemctl status intent-test-framework

# 重启应用
sudo systemctl restart intent-test-framework

# 停止应用
sudo systemctl stop intent-test-framework

# 启动应用
sudo systemctl start intent-test-framework

# 查看实时日志
sudo journalctl -u intent-test-framework -f

# 查看最近50条日志
sudo journalctl -u intent-test-framework -n 50
```

---

## 故障排查

### 如果服务无法启动

```bash
# 1. 查看详细日志
sudo journalctl -u intent-test-framework -n 100

# 2. 检查配置文件
sudo -u appuser cat /opt/intent-test-framework/.env

# 3. 手动测试启动
cd /opt/intent-test-framework
sudo -u appuser /opt/intent-test-framework/venv/bin/python scripts/deployment/start-production.py
```

### 如果网站无法访问

```bash
# 1. 检查 Nginx
sudo systemctl status nginx
sudo nginx -t

# 2. 检查端口
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :5001

# 3. 查看 Nginx 日志
sudo tail -f /var/log/nginx/intent-test-framework-error.log
```

### 如果数据库连接失败

```bash
# 1. 检查 PostgreSQL
sudo systemctl status postgresql

# 2. 测试连接
psql -U intent_user -d intent_test_framework -h localhost

# 3. 检查用户权限
sudo -u postgres psql -c "\du"
sudo -u postgres psql -c "\l"
```

---

## 更新应用

当代码有更新时：

```bash
# 1. 停止服务
sudo systemctl stop intent-test-framework

# 2. 更新代码
cd /opt/intent-test-framework
sudo -u appuser git pull

# 3. 更新依赖（如有变化）
sudo -u appuser /opt/intent-test-framework/venv/bin/pip install -r requirements.txt

# 4. 运行数据库迁移（如有需要）
sudo bash scripts/deployment/init-database.sh

# 5. 重启服务
sudo systemctl start intent-test-framework
```

---

## 需要的信息清单

部署前请准备好以下信息：

- [ ] 服务器IP：120.53.220.231
- [ ] SSH登录方式（用户名和密码/密钥）
- [ ] 数据库密码（自己设定）
- [ ] 阿里云DashScope API密钥
- [ ] 域名已解析到服务器IP

所有信息准备好后，就可以开始部署了！

