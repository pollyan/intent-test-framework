<!DOCTYPE html>
<html>
<head>
    <title>æµ‹è¯•è„šæœ¬ç”Ÿæˆ</title>
</head>
<body>
    <h1>æµ‹è¯•MidSceneJSè„šæœ¬ç”Ÿæˆ</h1>
    <button onclick="testScriptGeneration()">æµ‹è¯•è„šæœ¬ç”Ÿæˆ</button>
    <pre id="output"></pre>

    <script>
        function generateMidSceneScript(testcase, mode) {
            const steps = JSON.parse(testcase.steps || '[]');
            
            let script = `// MidSceneJSæ¡¥æ¥æ¨¡å¼è„šæœ¬
// æµ‹è¯•ç”¨ä¾‹: ${testcase.name}
// ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

import { AgentOverChromeBridge } from '@midscene/web/bridge-mode';

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

Promise.resolve(
  (async () => {
    const agent = new AgentOverChromeBridge();
    
    try {
      console.log('ğŸŒ‰ å¼€å§‹æ¡¥æ¥æ¨¡å¼æ‰§è¡Œ: ${testcase.name}');
      
`;

            // ç¡®å®šè¿æ¥æ–¹å¼
            const firstStep = steps[0] || {};
            const startUrl = firstStep.params?.url || 'https://www.baidu.com';
            
            if (firstStep.action === 'navigate' && startUrl) {
                script += `      // è¿æ¥åˆ°æ–°æ ‡ç­¾é¡µå¹¶å¯¼èˆª
      await agent.connectNewTabWithUrl('${startUrl}');
      console.log('âœ… å·²è¿æ¥åˆ°æ–°æ ‡ç­¾é¡µ: ${startUrl}');
      
`;
                // è·³è¿‡ç¬¬ä¸€ä¸ªå¯¼èˆªæ­¥éª¤
                steps.shift();
            } else {
                script += `      // è¿æ¥åˆ°å½“å‰æ ‡ç­¾é¡µ
      await agent.connectCurrentTab();
      console.log('âœ… å·²è¿æ¥åˆ°å½“å‰æ ‡ç­¾é¡µ');
      
`;
            }

            // ç”Ÿæˆæ­¥éª¤æ‰§è¡Œä»£ç 
            steps.forEach((step, index) => {
                const { action, params = {}, description } = step;
                const stepNum = index + 1;
                
                script += `      // æ­¥éª¤ ${stepNum}: ${description || action}
`;
                
                switch (action) {
                    case 'navigate':
                        if (params.url) {
                            script += `      await agent.goto('${params.url}');
      console.log('ğŸ”— å¯¼èˆªåˆ°: ${params.url}');
`;
                        }
                        break;
                        
                    case 'click':
                        if (params.locate) {
                            script += `      await agent.ai('click "${params.locate}"');
      console.log('ğŸ‘† ç‚¹å‡»: ${params.locate}');
`;
                        }
                        break;
                        
                    case 'type':
                        if (params.locate && params.text) {
                            script += `      await agent.ai('type "${params.text}" in "${params.locate}"');
      console.log('âŒ¨ï¸ è¾“å…¥æ–‡æœ¬: ${params.text} åˆ° ${params.locate}');
`;
                        }
                        break;
                        
                    case 'wait':
                        const waitTime = params.time || 1000;
                        script += `      await sleep(${waitTime});
      console.log('â±ï¸ ç­‰å¾… ${waitTime}ms');
`;
                        break;
                        
                    case 'assert':
                        if (params.condition) {
                            script += `      await agent.aiAssert('${params.condition}');
      console.log('âœ… æ–­è¨€: ${params.condition}');
`;
                        }
                        break;
                        
                    default:
                        // é€šç”¨AIæ“ä½œ
                        let aiInstruction = description || action;
                        if (params.locate) {
                            aiInstruction = `${action} ${params.locate}`;
                            if (params.text) {
                                aiInstruction += ` with text "${params.text}"`;
                            }
                        }
                        script += `      await agent.ai('${aiInstruction}');
      console.log('ğŸ¤– AIæ“ä½œ: ${aiInstruction}');
`;
                        break;
                }
                
                script += `
`;
            });

            script += `      console.log('ğŸ‰ æµ‹è¯•æ‰§è¡Œå®Œæˆï¼');
      await agent.destroy();
      
    } catch (error) {
      console.error('âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥:', error.message);
      await agent.destroy();
      process.exit(1);
    }
  })()
);
`;

            return script;
        }

        function testScriptGeneration() {
            const testcase = {
                name: "ç™¾åº¦æœç´¢æµ‹è¯•",
                steps: JSON.stringify([
                    {
                        action: "navigate",
                        params: { url: "https://www.baidu.com" },
                        description: "æ‰“å¼€ç™¾åº¦é¦–é¡µ"
                    },
                    {
                        action: "type",
                        params: { locate: "input[name='wd']", text: "äººå·¥æ™ºèƒ½" },
                        description: "åœ¨æœç´¢æ¡†è¾“å…¥å…³é”®è¯"
                    },
                    {
                        action: "click",
                        params: { locate: "input[type='submit']" },
                        description: "ç‚¹å‡»æœç´¢æŒ‰é’®"
                    },
                    {
                        action: "wait",
                        params: { time: 2000 },
                        description: "ç­‰å¾…æœç´¢ç»“æœåŠ è½½"
                    },
                    {
                        action: "assert",
                        params: { condition: "search results are displayed" },
                        description: "éªŒè¯æœç´¢ç»“æœæ˜¾ç¤º"
                    }
                ])
            };

            try {
                const script = generateMidSceneScript(testcase, 'browser');
                document.getElementById('output').textContent = script;
                console.log('âœ… è„šæœ¬ç”ŸæˆæˆåŠŸ');
            } catch (error) {
                document.getElementById('output').textContent = `âŒ è„šæœ¬ç”Ÿæˆå¤±è´¥: ${error.message}`;
                console.error('è„šæœ¬ç”Ÿæˆå¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>
