{% extends "base_layout.html" %}

{% block title %}AIæ™ºèƒ½åŠ©æ‰‹ - è€å…µå¤§å¤´çš„ AI4SE å·¥å…·é›†{% endblock %}
{% block page_title %}æ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block container_class %}{% endblock %}

{% block extra_css %}
<style>
    /* æ™ºèƒ½åŠ©æ‰‹ç‰¹æ®Šå¸ƒå±€æ ·å¼ */
    .grid-cols-5 {
        grid-template-columns: repeat(5, 1fr);
    }

    /* æ¡Œé¢ç«¯ä¸»å¸ƒå±€ï¼šå·¦å³åˆ†æ ï¼ŒåŠ¨æ€å“åº”çª—å£å¤§å° */
    .desktop-layout {
        --dynamic-height: calc(100vh - 180px);
        display: flex;
        flex-direction: row;
        height: var(--dynamic-height);
        padding: 0 20px 20px 20px;
        /* é¡¶éƒ¨æ— paddingï¼Œå·¦å³ä¸‹æœ‰padding */
        box-sizing: border-box;
        width: 100%;
        /* æ¨ªå‘å……æ»¡å±å¹• */
    }

    /* å·¦ä¾§å¯¹è¯é¢æ¿ - è¾…åŠ©åŒºåŸŸ */
    .chat-panel {
        width: 600px;
        /* è°ƒæ•´åˆå§‹å®½åº¦åˆ°600px */
        flex: none;
        display: flex;
        flex-direction: column;
        min-width: 500px;
        /* å®‰å…¨é˜ˆå€¼ï¼š500px */
        max-width: none;
    }

    /* å¯æ‹–æ‹½åˆ†éš”æ¡ */
    .resize-handle {
        width: 12px;
        background: transparent;
        cursor: col-resize;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
        position: relative;
    }

    .resize-handle:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .resize-handle-line {
        width: 1px;
        height: 60%;
        background: #d0d0d0;
        position: relative;
        transition: all 0.2s ease;
    }

    /* æ·»åŠ ä¸‰ç‚¹æç¤º */
    .resize-handle-line::before,
    .resize-handle-line::after {
        content: '';
        position: absolute;
        width: 3px;
        height: 3px;
        background: #999999;
        border-radius: 50%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .resize-handle-line::before {
        top: 30%;
    }

    .resize-handle-line::after {
        bottom: 30%;
    }

    /* hoveræ—¶æ˜¾ç¤ºæç¤ºç‚¹ */
    .resize-handle:hover .resize-handle-line {
        background: #999999;
    }

    .resize-handle:hover .resize-handle-line::before,
    .resize-handle:hover .resize-handle-line::after {
        opacity: 1;
    }

    /* æ‹–æ‹½æ—¶çš„æ ·å¼ */
    .desktop-layout.resizing {
        user-select: none;
    }

    .desktop-layout.resizing .resize-handle {
        background: rgba(0, 0, 0, 0.05);
    }

    .desktop-layout.resizing .resize-handle-line {
        background: #999999;
    }

    .desktop-layout.resizing .resize-handle-line::before,
    .desktop-layout.resizing .resize-handle-line::after {
        opacity: 1;
    }

    /* å³ä¾§åˆ†æé¢æ¿ - ä¸»è¦åŒºåŸŸ */
    .analysis-panel {
        flex: 1;
        /* å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ */
        display: flex;
        flex-direction: column;
        min-width: 500px;
        /* å®‰å…¨é˜ˆå€¼ï¼š500px */
        max-width: none;
        width: 0;
        /* è®©flexæ­£å¸¸å·¥ä½œ */
        overflow: hidden;
        /* é¿å…å†…éƒ¨å†…å®¹æ’‘å¼€ */
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        height: 100%;
        /* å……æ»¡çˆ¶å®¹å™¨é«˜åº¦ */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chat-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e8e8e8;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f8f8;
    }

    .chat-title {
        font-size: 15px;
        font-weight: 600;
        color: #333333;
    }

    .chat-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #dc3545;
    }

    .status-text {
        font-size: 13px;
        color: #666666;
    }

    .messages-area {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 400px;
        position: relative;
        /* æ”¯æŒç»å¯¹å®šä½çš„é®ç½© */
    }

    .message {
        display: flex;
        gap: 12px;
        max-width: 80%;
    }

    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message.assistant {
        align-self: flex-start;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 500;
        flex-shrink: 0;
    }

    .message.user .message-avatar {
        background: #333333;
        color: white;
    }

    .message.assistant .message-avatar {
        background: #f0f0f0;
        color: #666666;
    }

    .message-content {
        padding: 12px 16px;
        border-radius: 8px;
        line-height: 1.5;
        font-size: 14px;
    }

    .message.user .message-content {
        background: #f0f0f0;
        color: #333333;
    }

    .message.assistant .message-content {
        background: #ffffff;
        border: 1px solid #e8e8e8;
        color: #333333;
    }

    .message-time {
        font-size: 12px;
        color: #999999;
        margin-top: 4px;
    }

    .input-area {
        padding: 20px;
        border-top: 1px solid #e8e8e8;
        background: #f8f8f8;
    }

    .input-form {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .input-wrapper {
        flex: 1;
        position: relative;
    }

    .message-input {
        width: 100%;
        min-height: 44px;
        /* å¢åŠ æœ€å°é«˜åº¦ç¡®ä¿ä¸€è¡Œæ–‡æœ¬ä¸è¢«æˆªæ–­ */
        max-height: 200px;
        /* å¢åŠ æœ€å¤§é«˜åº¦ä»¥é€‚åº”æ›´é•¿æ–‡æœ¬ */
        padding: 12px 16px;
        padding-right: 90px;
        /* ä¸ºå­—ç¬¦è®¡æ•°å™¨ç•™å‡ºç©ºé—´ */
        border: 1px solid #e8e8e8;
        border-radius: 20px;
        background: #ffffff;
        resize: none;
        font-size: 14px;
        line-height: 1.4;
        font-family: inherit;
        transition: border-color 0.2s ease;
        /* æ·»åŠ å¹³æ»‘è¾¹æ¡†è¿‡æ¸¡ */
        box-sizing: border-box;
    }

    .message-input:focus {
        outline: none;
        border-color: #333333;
    }

    .message-input::placeholder {
        color: #999999;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .char-counter {
        position: absolute;
        top: 50%;
        right: 16px;
        transform: translateY(-50%);
        font-size: 12px;
        color: #999999;
        transition: color 0.2s ease;
        white-space: nowrap;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 6px;
        border-radius: 10px;
        pointer-events: none;
        /* é¿å…é˜»æŒ¡è¾“å…¥ */
    }

    .char-counter.warning {
        color: #ff9800;
        /* æ¥è¿‘é™åˆ¶æ—¶æ˜¾ç¤ºæ©™è‰² */
    }

    .char-counter.danger {
        color: #f44336;
        /* è¶…è¿‡é™åˆ¶æ—¶æ˜¾ç¤ºçº¢è‰² */
    }

    .send-btn {
        padding: 12px 20px;
        background: #333333;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        height: 44px;
        /* ä¸è¾“å…¥æ¡†é«˜åº¦ä¿æŒä¸€è‡´ */
        min-width: 80px;
        align-self: flex-start;
        /* é¡¶éƒ¨å¯¹é½ */
        flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
        background: #555555;
    }

    .send-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }

    .consensus-container {
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        height: 100%;
        /* å……æ»¡çˆ¶å®¹å™¨é«˜åº¦ */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        min-width: 0;
        /* å…è®¸å†…éƒ¨æ”¶ç¼© */
    }

    .consensus-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e8e8e8;
        background: #f8f8f8;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .consensus-title {
        font-size: 16px;
        font-weight: 600;
        color: #333333;
    }


    .consensus-content {
        flex: 1;
        padding: 20px;
        overflow: auto;
        /* åŒæ—¶å…è®¸æ¨ªå‘å‡ºç°æ»šåŠ¨ï¼Œé¿å…æ’‘å¼€ */
        min-width: 0;
        /* å…è®¸å†…å®¹æ”¶ç¼© */
    }

    .consensus-section {
        margin-bottom: 24px;
    }

    .consensus-section:last-child {
        margin-bottom: 0;
    }

    .section-title {
        font-size: 14px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 12px;
    }

    .keywords-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
    }

    .keyword-tag {
        padding: 4px 8px;
        background: #f0f0f0;
        border-radius: 4px;
        font-size: 12px;
        color: #666666;
    }

    .requirements-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .requirement-item {
        padding: 8px 0;
        font-size: 14px;
        color: #333333;
        border-bottom: 1px solid #f0f0f0;
    }

    .requirement-item:last-child {
        border-bottom: none;
    }

    .requirement-item::before {
        content: 'â€¢';
        color: #666666;
        margin-right: 8px;
    }

    .progress-section {
        text-align: center;
        padding: 20px;
    }

    .stage-indicator {
        font-size: 13px;
        color: #666666;
        margin-bottom: 8px;
    }

    .stage-name {
        font-weight: 500;
        color: #333333;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999999;
    }

    /* AIæ¶ˆæ¯æ ¼å¼åŒ–æ ·å¼ */
    .ai-formatted {
        line-height: 1.6;
    }

    .ai-formatted .ai-paragraph {
        margin: 8px 0;
        color: #333333;
    }

    .ai-formatted .ai-title {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin: 16px 0 12px 0;
        text-align: center;
        padding: 8px 0;
        border-bottom: 2px solid #3498db;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 4px;
    }

    .ai-formatted .ai-subtitle {
        font-size: 14px;
        font-weight: 600;
        color: #34495e;
        margin: 16px 0 10px 0;
        padding: 8px 12px;
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        border-radius: 0 4px 4px 0;
    }

    .ai-formatted .ai-command-item {
        margin: 10px 0;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #007bff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .ai-formatted .ai-command-item:hover {
        background: #e9ecef;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .ai-formatted .ai-command-num {
        font-weight: 600;
        color: #007bff;
        margin-right: 8px;
    }

    .ai-formatted .ai-command {
        background: #e9ecef;
        color: #495057;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 13px;
    }

    .ai-formatted .ai-feature-item {
        margin: 6px 0 6px 16px;
        padding: 4px 0;
    }

    .ai-formatted .ai-feature-label {
        font-weight: 600;
        color: #2c3e50;
    }

    .ai-formatted .ai-feature-desc {
        color: #555555;
    }

    .ai-formatted .ai-list-item {
        margin: 4px 0 4px 12px;
        color: #555555;
    }

    .ai-formatted .inline-code {
        background: #f1f3f4;
        color: #d73a49;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 13px;
    }

    .ai-formatted strong {
        color: #2c3e50;
        font-weight: 600;
    }

    .ai-formatted em {
        color: #555555;
        font-style: italic;
    }

    /* æ ‡å‡†markdownå…ƒç´ æ ·å¼ */
    .ai-formatted h1,
    .ai-formatted h2 {
        color: #2c3e50;
        margin: 16px 0 12px 0;
        font-weight: 600;
    }

    .ai-formatted h1 {
        font-size: 24px;
        border-bottom: 2px solid #e8e8e8;
        padding-bottom: 8px;
    }

    .ai-formatted h2 {
        font-size: 20px;
        border-bottom: 1px solid #e8e8e8;
        padding-bottom: 4px;
    }

    .ai-formatted ul,
    .ai-formatted ol {
        margin: 12px 0;
        padding-left: 24px;
    }

    .ai-formatted li {
        margin: 4px 0;
        line-height: 1.6;
    }

    .ai-formatted blockquote {
        border-left: 4px solid #007bff;
        margin: 16px 0;
        padding: 12px 16px;
        background: #f8f9fa;
        color: #555555;
        font-style: italic;
    }

    .ai-formatted pre {
        background: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 16px;
        margin: 16px 0;
        overflow-x: auto;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.45;
    }

    .ai-formatted pre code {
        background: none;
        padding: 0;
        border-radius: 0;
        color: inherit;
    }

    .ai-formatted table {
        border-collapse: collapse;
        margin: 16px 0;
        width: 100%;
        max-width: 100%;
    }

    .ai-formatted table th,
    .ai-formatted table td {
        border: 1px solid #e1e4e8;
        padding: 8px 12px;
        text-align: left;
    }

    .ai-formatted table th {
        background: #f6f8fa;
        font-weight: 600;
    }

    .ai-formatted table tr:nth-child(even) {
        background: #f9f9f9;
    }

    .ai-formatted del {
        color: #6a737d;
        text-decoration: line-through;
    }

    .ai-formatted hr {
        border: none;
        border-top: 1px solid #e1e4e8;
        margin: 24px 0;
    }

    .ai-formatted a {
        color: #007bff;
        text-decoration: none;
    }

    .ai-formatted a:hover {
        text-decoration: underline;
    }

    /* æ¶ˆæ¯ç»“æ„è°ƒæ•´ */
    .message-body {
        flex: 1;
    }

    .message-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
    }


    /* AIå¤„ç†ä¸­åŠ¨æ•ˆ */
    .ai-processing {
        display: none;
        gap: 12px;
        max-width: 80%;
        margin: 16px 0;
        align-items: flex-start;
    }

    .ai-processing.show {
        display: flex;
    }

    .ai-processing .message-avatar {
        background: #f0f0f0;
        color: #666666;
        border-radius: 50%;
    }

    .thinking-content {
        flex: 1;
    }

    .thinking-text {
        color: #666666;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .processing-dots {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .processing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #666666;
        animation: processingPulse 1.4s infinite ease-in-out;
    }

    .processing-dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .processing-dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    .processing-dot:nth-child(3) {
        animation-delay: 0s;
    }

    @keyframes processingPulse {

        0%,
        80%,
        100% {
            opacity: 0.3;
            transform: scale(0.8);
        }

        40% {
            opacity: 1;
            transform: scale(1.1);
        }
    }

    /* è¿æ¥æŒ‰é’®åŠ è½½åŠ¨æ•ˆ */
    .connect-btn.loading {
        position: relative;
        pointer-events: none;
        padding-left: 35px;
    }

    .connect-btn.loading::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 12px;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 0;
        border: 2px solid #ffffff40;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: buttonSpin 1s linear infinite;
    }

    .connect-btn.disabled {
        background: #28a745;
        cursor: not-allowed;
        opacity: 0.8;
    }

    .connect-btn.disabled:hover {
        background: #28a745;
        transform: none;
    }

    @keyframes buttonSpin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }


    /* è¿æ¥AIåŠ©æ‰‹æç¤ºæ ·å¼ */
    .connect-prompt {
        text-align: center;
        padding: 40px 20px;
        max-width: 400px;
        margin: 0 auto;
    }



    .connect-prompt h3 {
        font-size: 20px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 12px;
    }

    .connect-prompt p {
        color: #666666;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    .connect-features {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 24px;
    }

    .feature {
        padding: 8px 12px;
        background: #f8f8f8;
        border-radius: 6px;
        font-size: 13px;
        color: #555555;
    }

    .connect-btn {
        padding: 12px 24px;
        background: #333333;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 16px;
    }

    .connect-btn:hover {
        background: #555555;
        transform: translateY(-1px);
    }

    .connect-note {
        font-size: 12px;
        color: #999999;
        margin: 0;
    }

    /* AIé…ç½®æ¨¡æ€æ¡† */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal {
        background: white;
        border-radius: 8px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 8px;
    }

    .modal-subtitle {
        font-size: 14px;
        color: #666666;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .modal-actions {
        margin-top: 24px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    /* æ¡Œé¢ç«¯ä¸“ç”¨æ ·å¼ä¼˜åŒ– */

    /* é’ˆå¯¹ä¸åŒå±å¹•å°ºå¯¸çš„å¸ƒå±€ä¼˜åŒ– */
    @media (min-width: 1400px) {
        .desktop-layout {
            padding: 20px;
            gap: 24px;
        }

        .chat-panel {
            max-width: none;
            /* å…è®¸ä»»æ„æ‹–åŠ¨ï¼Œå–æ¶ˆä¸Šé™ */
        }
    }

    /* ================================
åˆ†ææˆæœåŒºåŸŸä¸“ç”¨æ ·å¼
================================ */
    .analysis-results-content {
        line-height: 1.6;
        color: #333333;
        font-size: 14px;
    }

    .analysis-results-content h1,
    .analysis-results-content h2,
    .analysis-results-content h3,
    .analysis-results-content h4 {
        color: #2c3e50;
        margin: 16px 0 12px 0;
        font-weight: 600;
        line-height: 1.4;
    }

    .analysis-results-content h1 {
        font-size: 18px;
        text-align: center;
        padding: 12px 16px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 6px;
        border-left: 4px solid #007bff;
        margin-bottom: 20px;
    }

    .analysis-results-content h2 {
        font-size: 16px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-left: 4px solid #28a745;
        border-radius: 0 4px 4px 0;
        margin-bottom: 16px;
    }

    .analysis-results-content h3 {
        font-size: 15px;
        padding: 6px 10px;
        background: #f9f9f9;
        border-left: 3px solid #17a2b8;
        border-radius: 0 3px 3px 0;
        margin-bottom: 12px;
    }

    .analysis-results-content ul,
    .analysis-results-content ol {
        margin: 12px 0;
        padding-left: 20px;
    }

    .analysis-results-content li {
        margin: 6px 0;
        line-height: 1.5;
        color: #444444;
    }

    .analysis-results-content strong {
        color: #2c3e50;
        font-weight: 600;
    }

    .analysis-results-content em {
        color: #666666;
        font-style: italic;
    }

    .analysis-results-content code {
        background: #f1f3f4;
        color: #d73a49;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 13px;
    }

    .analysis-results-content blockquote {
        border-left: 4px solid #007bff;
        margin: 16px 0;
        padding: 12px 16px;
        background: #f8f9fa;
        color: #555555;
        font-style: italic;
        border-radius: 0 4px 4px 0;
    }

    .analysis-results-content pre {
        background: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 12px;
        margin: 12px 0;
        overflow-x: auto;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.4;
    }

    .analysis-results-content pre code {
        background: none;
        padding: 0;
        border-radius: 0;
        color: inherit;
    }

    /* åˆ†ææˆæœè¿›åº¦æŒ‡ç¤º */
    .analysis-results-content .current-phase {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 6px;
        padding: 12px 16px;
        margin: 16px 0;
        text-align: center;
        font-weight: 500;
        color: #1565c0;
    }

    /* åˆ†ææˆæœçŠ¶æ€æ ‡ç­¾ */
    .analysis-results-content .stage-completed {
        display: inline-block;
        background: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-right: 8px;
        margin-bottom: 4px;
    }

    .analysis-results-content .stage-in-progress {
        display: inline-block;
        background: #fff3cd;
        color: #856404;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-right: 8px;
        margin-bottom: 4px;
    }

    /* åˆ†ææˆæœå†…å®¹ä¼˜åŒ– */
    .analysis-results-content {
        font-size: 14px;
        line-height: 1.6;
    }

    .analysis-results-content h1 {
        font-size: 20px;
        padding: 16px 20px;
    }

    .analysis-results-content h2 {
        font-size: 18px;
        padding: 12px 16px;
    }

    .analysis-results-content h3 {
        font-size: 16px;
        padding: 10px 14px;
    }

    /* å“åº”å¼å¸ƒå±€è°ƒæ•´ - ç¡®ä¿åœ¨ä¸åŒåˆ†è¾¨ç‡ä¸‹éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º */
    @media (max-width: 1200px) {
        .chat-panel {
            min-width: 500px;
            /* ä¸å®‰å…¨é˜ˆå€¼ä¸€è‡´ */
            flex: 0 0 40%;
            /* å°å±æ—¶å¢åŠ å¯¹è¯åŒºåŸŸæ¯”ä¾‹ */
        }

        .analysis-panel {
            min-width: 500px;
            /* ä¸å®‰å…¨é˜ˆå€¼ä¸€è‡´ */
        }
    }

    @media (max-width: 900px) {
        .desktop-layout {
            flex-direction: column;
            /* è¶…å°å±æ—¶å‚ç›´æ’åˆ— */
            height: auto;
            gap: 16px;
        }

        .chat-panel,
        .analysis-panel {
            flex: none;
            min-width: auto;
            max-width: none;
        }

        .chat-container,
        .consensus-container {
            height: 50vh;
            /* å‚ç›´æ’åˆ—æ—¶å„å ä¸€åŠå±å¹•é«˜åº¦ */
        }
    }

    /* é«˜åˆ†è¾¨ç‡ä¼˜åŒ– */
    @media (min-width: 1920px) {
        .desktop-layout {
            gap: 30px;
            padding: 0 40px 40px 40px;
        }
    }

    /* åŠ©æ‰‹é€‰æ‹©å™¨æ ·å¼ */
    .assistant-selector {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 24px 20px;
    }

    .selector-content {
        text-align: center;
        max-width: 600px;
        width: 100%;
    }

    .selector-content h3 {
        font-size: 22px;
        font-weight: 600;
        color: #333;
        margin: 0 0 12px 0;
    }

    .selector-content p {
        font-size: 15px;
        color: #666;
        margin: 0 0 20px 0;
    }

    .assistant-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .assistant-card {
        background: #ffffff;
        border: 2px solid #e8e8e8;
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
    }

    .assistant-card:hover {
        border-color: #4f46e5;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        transform: translateY(-2px);
    }

    .assistant-card.selected {
        border-color: #4f46e5;
        background: #f8faff;
    }

    .assistant-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 12px;
    }

    .assistant-card.alex .assistant-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .assistant-card.song .assistant-avatar {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .assistant-name {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin: 0 0 4px 0;
    }

    .assistant-title {
        font-size: 13px;
        color: #4f46e5;
        font-weight: 500;
        margin: 0 0 8px 0;
    }

    .assistant-description {
        font-size: 13px;
        color: #666;
        line-height: 1.4;
        margin: 0;
    }

    .assistant-switch-btn {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        color: #374151;
        cursor: pointer;
        margin-left: 12px;
        transition: all 0.2s ease;
    }

    .assistant-switch-btn:hover {
        background: #e5e7eb;
        border-color: #9ca3af;
    }

    .selector-footer .note {
        font-size: 14px;
        color: #9ca3af;
        margin: 0;
    }

    /* è¿æ¥åŠ è½½é®ç½©æ ·å¼ */
    .connection-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }

    .connection-loading-overlay.show {
        display: flex;
    }

    .connection-loading-content {
        text-align: center;
        padding: 40px 20px;
    }

    .connection-loading-text {
        font-size: 16px;
        color: #333333;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .connection-loading-dots {
        display: inline-flex;
        gap: 4px;
        align-items: center;
    }

    .connection-loading-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #333333;
        animation: connectionDotJump 1.4s infinite ease-in-out;
    }

    .connection-loading-dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .connection-loading-dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    .connection-loading-dot:nth-child(3) {
        animation-delay: 0s;
    }

    @keyframes connectionDotJump {

        0%,
        80%,
        100% {
            opacity: 0.4;
            transform: translateY(0);
        }

        40% {
            opacity: 1;
            transform: translateY(-8px);
        }
    }

    .connection-success {
        color: #28a745;
        font-weight: 500;
    }

    .connection-error {
        color: #dc3545;
        font-weight: 500;
        margin-bottom: 16px;
    }

    .connection-retry-btn {
        background: none;
        border: 1px solid #333333;
        color: #333333;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .connection-retry-btn:hover {
        background: #333333;
        color: white;
    }

    /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
    .message.system {
        background: #f8f9fa;
        border-left: 4px solid #6c757d;
        margin: 10px 0;
    }

    .message.system.error {
        background: #fff5f5;
        border-left-color: #e53e3e;
    }

    .message.system.success {
        background: #f0fff4;
        border-left-color: #38a169;
    }

    .message.system .message-sender {
        color: #6c757d;
        font-weight: 500;
    }

    /* æ–‡ä»¶é™„ä»¶é¢„è§ˆåŒºåŸŸ */
    .attachment-preview {
        background: #f8f9fa;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        margin-bottom: 12px;
        padding: 12px;
    }

    .attachment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 13px;
        font-weight: 500;
        color: #666;
    }

    .clear-all-btn {
        background: none;
        border: none;
        color: #dc3545;
        font-size: 12px;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 3px;
    }

    .clear-all-btn:hover {
        background: #f5c6cb;
    }

    .attachment-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .attachment-item {
        display: flex;
        align-items: center;
        gap: 6px;
        background: #ffffff;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #e8e8e8;
        font-size: 12px;
    }

    .attachment-icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #333333;
        color: white;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 600;
    }

    .attachment-info {
        display: flex;
        flex-direction: column;
        gap: 1px;
    }

    .attachment-name {
        color: #333333;
        font-weight: 500;
    }

    .attachment-size {
        color: #666666;
        font-size: 10px;
    }

    .remove-attachment {
        width: 14px;
        height: 14px;
        border: none;
        background: #f0f0f0;
        color: #999999;
        border-radius: 50%;
        cursor: pointer;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-attachment:hover {
        background: #ffebee;
        color: #d32f2f;
    }

    /* è¾“å…¥æ“ä½œåŒºåŸŸ */
    .input-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 10px;
    }

    .file-btn {
        background: #f8f9fa;
        border: 1px solid #e8e8e8;
        color: #666;
        padding: 12px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
    }

    .file-btn:hover {
        background: #e9ecef;
        border-color: #d6d9dd;
    }

    /* æ‹–æ‹½æ•ˆæœ */
    .input-wrapper {
        position: relative;
    }

    .drag-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(40, 167, 69, 0.1);
        border: 2px dashed #28a745;
        border-radius: 20px;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 8px;
        z-index: 10;
    }

    .drag-overlay.active {
        display: flex;
    }

    .drag-text {
        color: #28a745;
        font-size: 14px;
        font-weight: 600;
    }

    .drag-subtext {
        color: #666666;
        font-size: 12px;
    }

    .message-input.drag-over {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }

    /* æ¶ˆæ¯ä¸­çš„é™„ä»¶æ˜¾ç¤º */
    .message-attachments {
        margin-top: 8px;
        padding: 6px 8px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 12px;
        color: #666;
    }

    .attachment-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-right: 12px;
    }
</style>
{% endblock %}

{% block content %}

<div class="desktop-layout">
    <!-- å·¦ä¾§ï¼šå¯¹è¯åŒºåŸŸ -->
    <div class="chat-panel">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title"><span id="chatTitle">è¯·é€‰æ‹©æ™ºèƒ½åŠ©æ‰‹</span><button class="assistant-switch-btn"
                        id="assistantSwitchBtn" style="display: none;">åˆ‡æ¢åŠ©æ‰‹</button></div>
                <div class="chat-status" title="åŠ©æ‰‹è¿æ¥çŠ¶æ€">
                    <div class="status-dot" id="connectionStatus"></div><span class="status-text"
                        id="statusText">æœªè¿æ¥</span>
                </div>
            </div>
            <div class="messages-area" id="messagesArea">
                <!-- è¿æ¥åŠ è½½é®ç½© -->
                <div class="connection-loading-overlay" id="connectionLoadingOverlay">
                    <div class="connection-loading-content">
                        <div class="connection-loading-text" id="connectionLoadingText">æ­£åœ¨åˆå§‹åŒ–...</div>
                        <div class="connection-loading-dots" id="connectionLoadingDots">
                            <div class="connection-loading-dot"></div>
                            <div class="connection-loading-dot"></div>
                            <div class="connection-loading-dot"></div>
                        </div>
                        <div class="connection-error" id="connectionError" style="display: none;"></div><button
                            class="connection-retry-btn" id="connectionRetryBtn" style="display: none;"
                            onclick="retryConnection()">é‡è¯•</button>
                    </div>
                </div>
                <!-- åŠ©æ‰‹é€‰æ‹©å™¨ç•Œé¢ -->
                <div class="assistant-selector" id="assistantSelector">
                    <div class="selector-content">
                        <h3>é€‰æ‹©æ‚¨çš„æ™ºèƒ½åŠ©æ‰‹</h3>
                        <p>è¯·é€‰æ‹©ä¸€ä½ä¸“ä¸šçš„AIåŠ©æ‰‹å¼€å§‹å¯¹è¯ï¼š</p>
                        <div class="assistant-cards" id="assistantCards">
                            <!-- åŠ©æ‰‹å¡ç‰‡å°†åŠ¨æ€åŠ è½½ -->
                        </div>
                        <div class="selector-footer">
                            <p class="note">é€‰æ‹©åå³å¯å¼€å§‹ä¸“ä¸šçš„AIè¾…åŠ©å¯¹è¯</p>
                        </div>
                    </div>
                </div>
                <!-- æ¶ˆæ¯å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                <div class="ai-processing" id="aiProcessing" style="display: none;">
                    <div class="message-avatar">AI</div>
                    <div class="thinking-content">
                        <div class="thinking-text" id="thinkingText">AIæ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚</div>
                        <div class="processing-dots">
                            <div class="processing-dot"></div>
                            <div class="processing-dot"></div>
                            <div class="processing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="input-area">
                <!-- æ–‡ä»¶é™„ä»¶é¢„è§ˆåŒºåŸŸ -->
                <div id="attachmentPreview" class="attachment-preview" style="display: none;">
                    <div class="attachment-header"><span>å·²é€‰æ‹©çš„æ–‡ä»¶</span><button type="button"
                            onclick="clearAllAttachments()" class="clear-all-btn">æ¸…é™¤å…¨éƒ¨</button></div>
                    <div id="attachmentList" class="attachment-list"></div>
                </div>
                <form class="input-form" id="messageForm">
                    <div class="input-wrapper"><textarea class="message-input" id="messageInput"
                            placeholder="è¯·æè¿°é¡¹ç›®éœ€æ±‚æˆ–æƒ³æ³•ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼  txt/md æ–‡æ¡£" maxlength="10000" rows="1"></textarea>
                        <div class="char-counter"><span id="charCount">0</span>/10000 </div>
                        <!-- æ‹–æ‹½è¦†ç›–å±‚ -->
                        <div class="drag-overlay" id="dragOverlay">
                            <div class="drag-text">é‡Šæ”¾æ–‡ä»¶å³å¯ä¸Šä¼ </div>
                            <div class="drag-subtext">ä»…æ”¯æŒ .txt å’Œ .md æ ¼å¼</div>
                        </div>
                    </div>
                    <div class="input-actions">
                        <!-- æ–‡ä»¶ä¸Šä¼ æŒ‰é’® --><button type="button" onclick="document.getElementById('fileInput').click()"
                            class="file-btn">ğŸ“
                        </button>
                        <!-- å‘é€æŒ‰é’® --><button type="submit" class="send-btn" id="sendBtn">å‘é€</button>
                    </div>
                </form>
                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ --><input type="file" id="fileInput" multiple accept=".txt,.md" style="display: none;">
            </div>
        </div>
    </div>
    <!-- å¯æ‹–æ‹½åˆ†éš”æ¡ -->
    <div class="resize-handle" id="resizeHandle">
        <div class="resize-handle-line"></div>
    </div>
    <!-- å³ä¾§ï¼šåˆ†ææˆæœåŒºåŸŸï¼ˆä¸»è¦åŒºåŸŸï¼‰ -->
    <div class="analysis-panel">
        <div class="consensus-container">
            <div class="consensus-header">
                <div class="consensus-title">åˆ†ææˆæœ</div>
            </div>
            <div class="consensus-content" id="consensusContent">
                <div class="empty-state">å¼€å§‹ä¸AIåŠ©æ‰‹å¯¹è¯åï¼Œè¿™é‡Œå°†å®æ—¶æ˜¾ç¤ºç»“æ„åŒ–çš„åˆ†ææˆæœ </div>
            </div>
        </div>
    </div>
</div>{% endblock %}

{% block extra_js %}

<!-- å¼•å…¥marked.jsç”¨äºå®Œæ•´markdownè§£æ -->
<script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
<!-- å¼•å…¥DOMPurifyç”¨äºHTMLå®‰å…¨è¿‡æ»¤ -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
<script> // å…¨å±€å˜é‡
    let socket = null;
    let currentSessionId = null;
    let isConnected = false;
    let isAIAssistantInitialized = false;
    let currentAssistant = null;
    let availableAssistants = [];
    let connectionRetryCount = 0;
    let maxRetries = 3;

    // ä¿å­˜åˆ‡æ¢å‰çš„çŠ¶æ€
    let savedSwitchState = null;

    // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å˜é‡
    let attachedFiles = [];

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {

        // è®¾ç½®axioså…¨å±€è¶…æ—¶ä¸º3åˆ†é’Ÿï¼Œé¿å…é•¿AIå›å¤è¢«æˆªæ–­
        if (typeof axios !== 'undefined') {
            axios.defaults.timeout = 300000; // 5åˆ†é’Ÿ = 300ç§’ * 1000æ¯«ç§’
            console.log('å·²è®¾ç½®axioså…¨å±€è¶…æ—¶ä¸º5åˆ†é’Ÿ');
        }

        // åˆå§‹åŒ–å“åº”å¼å¸ƒå±€
        initializeResponsiveLayout();

        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        initializeResize();

        initializeWebSocket();
        initializeUI();
        initializeFileUpload(); // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        loadAvailableAssistants();
        // å…ˆä¸åˆ›å»ºä¼šè¯ï¼Œç­‰ç”¨æˆ·é€‰æ‹©åŠ©æ‰‹åå†åˆ›å»º
        // createSession();
        // åˆå§‹åŒ–å‘é€æŒ‰é’®çŠ¶æ€ï¼ˆAIåŠ©æ‰‹æœªåˆå§‹åŒ–æ—¶ç¦ç”¨ï¼‰
        updateSendButtonState();
    });

    // ç¯å¢ƒæ£€æµ‹ - ç°åœ¨æ‰€æœ‰ç¯å¢ƒéƒ½ä½¿ç”¨HTTPè½®è¯¢ï¼Œä¸å†ä½¿ç”¨WebSocket
    function isVercelEnvironment() {
        // å§‹ç»ˆè¿”å›trueï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»ç§»é™¤äº†WebSocketæ”¯æŒ
        return true;
    }

    // HTTPæ–¹å¼å‘é€æ¶ˆæ¯ï¼ˆæ›¿ä»£WebSocketï¼‰
    async function sendMessageViaHTTP(content, showProcessing = true) {
        try {
            const response = await axios.post(`/api/requirements/sessions/${currentSessionId}/messages`, {
                content: content
            });

            if (response.data.code === 200) {
                const data = response.data.data;

                // åªæ˜¾ç¤ºAIå“åº”ï¼ˆç”¨æˆ·æ¶ˆæ¯å·²åœ¨å‰ç«¯ç«‹å³æ˜¾ç¤ºï¼‰
                if (data.ai_message) {
                    hideAiProcessing();
                    displayMessage(data.ai_message);

                    // ç¡®ä¿AIå›å¤æ˜¾ç¤ºåæ»šåŠ¨åˆ°åº•éƒ¨
                    scrollToBottom();

                    // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”åŠ©æ‰‹å·²åˆå§‹åŒ–ï¼Œæ›´æ–°è¿æ¥çŠ¶æ€
                    if (data.ai_message.message_type === 'ai' && currentAssistant) {
                        const assistantName = currentAssistant.name;

                        updateConnectionStatus('connected', `AIåŠ©æ‰‹${assistantName
                            }

                        å·²æ¿€æ´»`);
                        // è®¾ç½®AIåŠ©æ‰‹å·²åˆå§‹åŒ–
                        isAIAssistantInitialized = true;
                        updateSendButtonState();

                        console.log(`åŠ©æ‰‹${assistantName
                            }

                        å·²æ¿€æ´»å¹¶æ›´æ–°è¿æ¥çŠ¶æ€`);
                    }
                }

                return true;
            }

            else {
                throw new Error(response.data.message || 'å‘é€å¤±è´¥');
            }
        }

        catch (error) {
            console.error('HTTPå‘é€æ¶ˆæ¯å¤±è´¥:', error);
            hideAiProcessing();
            showMessage('å‘é€æ¶ˆæ¯å¤±è´¥: ' + (error.response?.data?.message || error.message), 'error');
            return false;
        }
    }

    // æ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„HTTPå‘é€æ¶ˆæ¯å‡½æ•°
    async function sendMessageWithFiles(content, files) {
        console.log('ğŸ“ å‘é€æ–‡ä»¶æ¶ˆæ¯:', {
            contentLength: content ? content.length : 0,
            filesCount: files.length,
            fileNames: files.map(f => f.name),
            fileSizes: files.map(f => f.content.length)
        });

        try {
            // æ„å»º FormData
            const formData = new FormData();

            if (content) {
                formData.append('content', content);
                console.log('ğŸ“ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯å†…å®¹:', content.substring(0, 100) + '...');
            }

            // æ·»åŠ æ–‡ä»¶
            files.forEach(fileInfo => {
                const blob = new Blob([fileInfo.content], {
                    type: 'text/plain'
                });
                formData.append('files', blob, fileInfo.name);

                console.log(`ğŸ“ æ·»åŠ æ–‡ä»¶ ${fileInfo.name
                    }

                , å†…å®¹é¢„è§ˆ:`, fileInfo.content.substring(0, 100) + '...');
            });

            // å‘é€è¯·æ±‚
            console.log('ğŸ“ å³å°†å‘é€è¯·æ±‚åˆ°:', `/api/requirements/sessions/${currentSessionId
                }

        /messages`);
            const response = await axios.post(`/api/requirements/sessions/${currentSessionId}/messages`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            if (response.data.code === 200) {
                const data = response.data.data;

                // åªæ˜¾ç¤ºAIå“åº”ï¼ˆç”¨æˆ·æ¶ˆæ¯å·²åœ¨å‰ç«¯ç«‹å³æ˜¾ç¤ºï¼‰
                if (data.ai_message) {
                    hideAiProcessing();
                    displayMessage(data.ai_message);

                    // ç¡®ä¿šAIå›å¤æ˜¾ç¤ºåæ»šåŠ¨åˆ°åº•éƒ¨
                    scrollToBottom();

                    // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”åŠ©æ‰‹å·²åˆå§‹åŒ–ï¼Œæ›´æ–°è¿æ¥çŠ¶æ€
                    if (data.ai_message.message_type === 'ai' && currentAssistant) {
                        const assistantName = currentAssistant.name;

                        updateConnectionStatus('connected', `AIåŠ©æ‰‹${assistantName
                            }

                    å·²æ¿€æ´»`);
                        isAIAssistantInitialized = true;
                        updateSendButtonState();

                        console.log(`åŠ©æ‰‹${assistantName
                            }

                    å·²æ¿€æ´»å¹¶æ›´æ–°è¿æ¥çŠ¶æ€`);
                    }
                }

                return true;
            }

            else {
                throw new Error(response.data.message || 'å‘é€å¤±è´¥');
            }
        }

        catch (error) {
            console.error('HTTPæ–‡ä»¶ä¸Šä¼ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            hideAiProcessing();
            showMessage('å‘é€æ¶ˆæ¯å¤±è´¥: ' + (error.response?.data?.message || error.message), 'error');
            return false;
        }
    }

    // è½®è¯¢è·å–æ–°æ¶ˆæ¯ï¼ˆVercelç¯å¢ƒä¸“ç”¨ï¼‰
    let lastMessageTimestamp = null;
    let pollingInterval = null;

    function startMessagePolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }

        pollingInterval = setInterval(async () => {
            try {
                const params = new URLSearchParams();

                if (lastMessageTimestamp) {
                    params.append('since', lastMessageTimestamp);
                }

                params.append('limit', '10');

                const response = await axios.get(`/api/requirements/sessions/${currentSessionId}/poll-messages?${params}`);

                if (response.data.code === 200) {
                    const messages = response.data.data.messages;

                    messages.forEach(message => {
                        displayMessage(message);
                        lastMessageTimestamp = message.created_at;

                        // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”åŠ©æ‰‹å·²åˆå§‹åŒ–ï¼Œæ›´æ–°è¿æ¥çŠ¶æ€
                        if (message.message_type === 'ai' && currentAssistant) {
                            const assistantName = currentAssistant.name;

                            updateConnectionStatus('connected', `AIåŠ©æ‰‹${assistantName
                                }

                                        å·²æ¿€æ´»`);
                            hideAiTyping();
                            // è®¾ç½®AIåŠ©æ‰‹å·²åˆå§‹åŒ–
                            isAIAssistantInitialized = true;
                            updateSendButtonState();
                        }
                    });
                }
            }

            catch (error) {
                console.error('è½®è¯¢æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

            , 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
    }

    function stopMessagePolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }

    // WebSocketè¿æ¥ï¼ˆæœ¬åœ°ç¯å¢ƒï¼‰
    function initializeWebSocket() {
        if (isVercelEnvironment()) {
            console.log('æ£€æµ‹åˆ°Vercelç¯å¢ƒï¼Œä½¿ç”¨HTTPè½®è¯¢æ¨¡å¼');
            updateConnectionStatus('ready', 'å‡†å¤‡å°±ç»ª');
            return;
        }

        socket = io();

        socket.on('connect', function () {
            console.log('WebSocketè¿æ¥æˆåŠŸ');
            isConnected = true;
            updateConnectionStatus('connected', 'å·²è¿æ¥');
        });

        socket.on('disconnect', function () {
            console.log('WebSocketè¿æ¥æ–­å¼€');
            isConnected = false;
            updateConnectionStatus('disconnected', 'è¿æ¥æ–­å¼€');
        });

        socket.on('error', function (data) {
            console.error('WebSocketé”™è¯¯:', data);
            showMessage(data.message || 'è¿æ¥é”™è¯¯', 'error');
        });

        // éœ€æ±‚åˆ†æç›¸å…³äº‹ä»¶
        socket.on('joined_session', function (data) {
            console.log('åŠ å…¥ä¼šè¯æˆåŠŸ:', data);
            loadSessionMessages();
        });

        socket.on('new_message', function (data) {
            console.log('æ”¶åˆ°æ–°æ¶ˆæ¯:', data);
            displayMessage(data.message);
            hideAiTyping();

            // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”åŠ©æ‰‹å·²åˆå§‹åŒ–ï¼Œæ›´æ–°è¿æ¥çŠ¶æ€
            if (data.message.message_type === 'ai' && currentAssistant) {
                const assistantName = currentAssistant.name;

                updateConnectionStatus('connected', `AIåŠ©æ‰‹${assistantName
                    }

                        å·²æ¿€æ´»`);
                // è®¾ç½®AIåŠ©æ‰‹å·²åˆå§‹åŒ–
                isAIAssistantInitialized = true;
                updateSendButtonState();
            }
        });

        socket.on('consensus_updated', function (data) {
            console.log('å…±è¯†æ›´æ–°:', data);
            updateConsensusDisplay(data.consensus);
        });
    }

    // æ»šåŠ¨æ¶ˆæ¯åŒºåŸŸåˆ°åº•éƒ¨
    function scrollToBottom(delay = 100) {
        setTimeout(() => {
            const messagesArea = document.getElementById('messagesArea');

            if (messagesArea) {
                messagesArea.scrollTo({
                    top: messagesArea.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

            , delay);
    }

    // ç»Ÿä¸€æ§åˆ¶å‘é€æŒ‰é’®çŠ¶æ€
    function updateSendButtonState() {
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const switchBtn = document.getElementById('assistantSwitchBtn');

        if (!sendBtn || !messageInput) return;

        // å¿…é¡»æœ‰æ–‡æœ¬å†…å®¹æ‰èƒ½å‘é€ï¼ˆä»…æœ‰é™„ä»¶ä¸å…è®¸å‘é€ï¼‰
        const hasContent = messageInput.value.trim().length > 0;
        const hasAttachments = attachedFiles && attachedFiles.length > 0;
        const canSend = isAIAssistantInitialized && hasContent;

        sendBtn.disabled = !canSend;

        // æ›´æ–°æŒ‰é’®æ–‡å­—æç¤º
        if (!isAIAssistantInitialized) {
            sendBtn.title = 'AIåŠ©æ‰‹å°šæœªåˆå§‹åŒ–';
        }

        else if (!hasContent) {
            sendBtn.title = hasAttachments ? 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼ˆä»…æœ‰é™„ä»¶æ— æ³•å‘é€ï¼‰' : 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹';
        }

        else {
            sendBtn.title = hasAttachments ? 'å‘é€æ¶ˆæ¯å’Œé™„ä»¶' : 'å‘é€æ¶ˆæ¯';
        }

        // æ§åˆ¶åˆ‡æ¢åŠ©æ‰‹æŒ‰é’®çŠ¶æ€
        if (switchBtn) {
            // æ­£åœ¨åˆå§‹åŒ–æˆ–æ­£åœ¨å¯¹è¯æ—¶ç¦ç”¨
            const shouldDisable = !isAIAssistantInitialized || isSending;
            switchBtn.disabled = shouldDisable;

            if (shouldDisable) {
                if (!isAIAssistantInitialized) {
                    switchBtn.title = 'åŠ©æ‰‹æ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å...';
                }

                else if (isSending) {
                    switchBtn.title = 'æ­£åœ¨å¯¹è¯ä¸­ï¼Œè¯·ç¨å...';
                }

                switchBtn.style.opacity = '0.6';
                switchBtn.style.pointerEvents = 'none'; // ç¡®ä¿ç¦ç”¨æ—¶ä¸å¯ç‚¹å‡»
            }

            else {
                switchBtn.title = 'åˆ‡æ¢åˆ°å…¶ä»–åŠ©æ‰‹';
                switchBtn.style.opacity = '1';
                switchBtn.style.pointerEvents = 'auto'; // æ¢å¤ç‚¹å‡»
            }
        }
    }

    // åˆå§‹åŒ–å“åº”å¼å¸ƒå±€
    function initializeResponsiveLayout() {

        // è®¡ç®—å¹¶è®¾ç½®åŠ¨æ€é«˜åº¦
        function updateLayoutHeight() {
            const navHeight = document.querySelector('.navbar')?.offsetHeight || 64;
            const titleHeight = document.querySelector('.container h1')?.offsetHeight || 40;
            const additionalSpace = 76; // å…¶ä»–é—´è·å’Œpadding
            const availableHeight = window.innerHeight - navHeight - titleHeight - additionalSpace;

            // æ›´æ–°CSSå˜é‡
            document.documentElement.style.setProperty('--dynamic-height', `${availableHeight
                }

                px`);

            console.log(`å“åº”å¼å¸ƒå±€æ›´æ–°: çª—å£=${window.innerHeight
                }

                px, å¯¼èˆª=${navHeight
                }

                px, æ ‡é¢˜=${titleHeight
                }

                px, å¯ç”¨=${availableHeight
                }

                px`);
        }

        // åˆå§‹åŒ–è®¾ç½®
        updateLayoutHeight();

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', function () {
            // ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹æ›´æ–°
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(updateLayoutHeight, 100);
        });

        // ç›‘å¬è®¾å¤‡æ–¹å‘å˜åŒ–ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
        window.addEventListener('orientationchange', function () {
            setTimeout(updateLayoutHeight, 200); // æ–¹å‘å˜åŒ–åç¨å¾®å»¶è¿Ÿï¼Œç­‰å¾…å¸ƒå±€ç¨³å®š
        });

        console.log('âœ… å“åº”å¼å¸ƒå±€åˆå§‹åŒ–å®Œæˆ');
    }

    // åˆå§‹åŒ–UIäº‹ä»¶
    function initializeUI() {
        const messageInput = document.getElementById('messageInput');
        const messageForm = document.getElementById('messageForm');
        const charCount = document.getElementById('charCount');
        const assistantSwitchBtn = document.getElementById('assistantSwitchBtn');

        // æ·»åŠ åˆ‡æ¢åŠ©æ‰‹æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        if (assistantSwitchBtn) {
            assistantSwitchBtn.addEventListener('click', switchAssistant);
        }

        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';

            // æ›´æ–°å­—ç¬¦è®¡æ•°å’Œé¢œè‰²åé¦ˆ
            const currentLength = this.value.length;
            const maxLength = 10000;
            charCount.textContent = currentLength;

            // æ¸…é™¤ä¹‹å‰çš„æ ·å¼ç±»
            charCount.classList.remove('warning', 'danger');

            // æ ¹æ®å­—ç¬¦æ•°é‡æ·»åŠ é€‚å½“çš„æ ·å¼
            if (currentLength >= maxLength) {
                charCount.classList.add('danger');
            }

            else if (currentLength >= maxLength * 0.8) {
                // 80%æ—¶æ˜¾ç¤ºè­¦å‘Š
                charCount.classList.add('warning');
            }

            // æ§åˆ¶å‘é€æŒ‰é’®çŠ¶æ€
            updateSendButtonState();
        });

        // æ”¯æŒShift+Enteræ¢è¡Œï¼ŒEnterå‘é€
        // æ·»åŠ è¾“å…¥æ³•çŠ¶æ€è·Ÿè¸ª
        let isComposing = false;

        messageInput.addEventListener('compositionstart', function () {
            isComposing = true;
        });

        messageInput.addEventListener('compositionend', function () {
            isComposing = false;
        });

        messageInput.addEventListener('keydown', function (e) {

            // å¦‚æœæ­£åœ¨è¾“å…¥æ³•ç»„åˆä¸­ï¼Œä¸è§¦å‘å‘é€
            if (isComposing) {
                return;
            }

            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();

                if (this.value.trim()) {
                    sendMessage();
                }
            }
        });

        // è¡¨å•æäº¤
        messageForm.addEventListener('submit', function (e) {
            e.preventDefault();
            sendMessage();
        });
    }

    // åŠ è½½å¯ç”¨çš„åŠ©æ‰‹åˆ—è¡¨
    async function loadAvailableAssistants() {
        console.log('å¼€å§‹åŠ è½½åŠ©æ‰‹åˆ—è¡¨...');

        try {
            const response = await axios.get('/api/requirements/assistants');
            console.log('APIå“åº”:', response.data);

            if (response.data.code === 200) {
                availableAssistants = response.data.data.assistants;
                console.log('åŠ è½½åŠ©æ‰‹åˆ—è¡¨æˆåŠŸ:', availableAssistants);
                renderAssistantSelector();
            }

            else {
                console.error('åŠ è½½åŠ©æ‰‹åˆ—è¡¨å¤±è´¥:', response.data);
                displaySystemMessage('åŠ è½½åŠ©æ‰‹åˆ—è¡¨å¤±è´¥: ' + (response.data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }

        catch (error) {
            console.error('åŠ è½½åŠ©æ‰‹åˆ—è¡¨å¤±è´¥:', error);
            displaySystemMessage('åŠ è½½åŠ©æ‰‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•: ' + error.message, 'error');
        }
    }

    // æ¸²æŸ“åŠ©æ‰‹é€‰æ‹©å™¨
    function renderAssistantSelector() {
        console.log('å¼€å§‹æ¸²æŸ“åŠ©æ‰‹é€‰æ‹©å™¨...');
        const assistantCards = document.getElementById('assistantCards');

        if (!assistantCards) {
            console.error('æ‰¾ä¸åˆ°assistantCardså…ƒç´ ');
            return;
        }

        console.log('æ¸…ç©ºç°æœ‰å†…å®¹å¹¶æ¸²æŸ“', availableAssistants.length, 'ä¸ªåŠ©æ‰‹');
        assistantCards.innerHTML = '';

        availableAssistants.forEach((assistant, index) => {
            console.log(`æ¸²æŸ“åŠ©æ‰‹ ${index + 1
                }

                    :`, assistant);
            const card = document.createElement('div');

            card.className = `assistant-card ${assistant.id
                }

                `;
            card.onclick = () => selectAssistant(assistant);

            const avatar = assistant.id === 'alex' ? 'A' : 'S';
            const description = assistant.id === 'alex'
                ? 'ä¸“ä¸šçš„éœ€æ±‚åˆ†æå¸ˆï¼Œå¸®åŠ©æ‚¨æ¾„æ¸…å’Œå®Œå–„é¡¹ç›®éœ€æ±‚ï¼Œç”Ÿæˆç»“æ„åŒ–éœ€æ±‚æ–‡æ¡£'
                : 'èµ„æ·±çš„æµ‹è¯•åˆ†æå¸ˆï¼ŒååŠ©æ‚¨è®¾è®¡æµ‹è¯•ç­–ç•¥ã€åˆ†ææµ‹è¯•ç‚¹å¹¶ç”Ÿæˆå®Œæ•´æµ‹è¯•ç”¨ä¾‹';

            card.innerHTML = ` <div class="assistant-avatar" >${avatar
                }

                </div> <div class="assistant-name" >${assistant.name
                }

                </div> <div class="assistant-title" >${assistant.title
                }

                </div> <div class="assistant-description" >${description
                }

                </div> `;

            assistantCards.appendChild(card);
        });
    }

    // é€‰æ‹©åŠ©æ‰‹
    async function selectAssistant(assistant) {
        console.log('é€‰æ‹©åŠ©æ‰‹:', assistant.name);

        // å¦‚æœæ˜¯åœ¨åˆ‡æ¢çŠ¶æ€ä¸­ï¼Œéœ€è¦æ¸…ç©ºå½“å‰å¯¹è¯è®°å½•
        if (savedSwitchState) {
            console.log('æ­£åœ¨åˆ‡æ¢åŠ©æ‰‹ï¼Œæ¸…ç©ºå¯¹è¯è®°å½•');
            // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            const messagesArea = document.getElementById('messagesArea');
            const messages = messagesArea.querySelectorAll('.message');
            messages.forEach(msg => msg.remove());

            // é‡ç½®å³ä¾§é¢æ¿å†…å®¹
            const consensusContent = document.getElementById('consensusContent');

            if (consensusContent) {
                consensusContent.innerHTML = ` <div class="empty-state">å¼€å§‹ä¸AIåŠ©æ‰‹å¯¹è¯åï¼Œè¿™é‡Œå°†å®æ—¶æ˜¾ç¤ºç»“æ„åŒ–çš„åˆ†ææˆæœ </div>`;
            }

            // æ¢å¤é€‰æ‹©å™¨åŸå§‹å†…å®¹
            const assistantSelector = document.getElementById('assistantSelector');
            const selectorContent = assistantSelector.querySelector('.selector-content');

            if (assistantSelector.dataset.originalContent) {
                selectorContent.innerHTML = assistantSelector.dataset.originalContent;
            }

            // æ¸…é™¤ä¿å­˜çš„åˆ‡æ¢çŠ¶æ€
            savedSwitchState = null;
        }

        // é‡ç½®çŠ¶æ€
        currentAssistant = assistant;
        currentSessionId = null; // é‡è¦ï¼šé‡ç½®ä¼šè¯IDï¼Œåˆ›å»ºæ–°ä¼šè¯
        isAIAssistantInitialized = false; // é‡ç½®åˆå§‹åŒ–çŠ¶æ€
        connectionRetryCount = 0; // é‡ç½®é‡è¯•æ¬¡æ•°

        // æ›´æ–°UIï¼ˆåŠ é˜²ç©ºåˆ¤æ–­ï¼Œé¿å…å…ƒç´ ä¸å­˜åœ¨æ—¶æŠ¥é”™ï¼‰
        const chatTitleEl = document.getElementById('chatTitle');

        if (chatTitleEl) {
            chatTitleEl.textContent = `ä¸${assistant.title
                }

            ${assistant.name
                }

            å¯¹è¯`;
        }

        else {
            console.warn('chatTitle å…ƒç´ æœªæ‰¾åˆ°');
        }

        const switchBtnEl = document.getElementById('assistantSwitchBtn');

        if (switchBtnEl) {
            switchBtnEl.style.display = 'inline-block';
        }

        const thinkingTextEl = document.getElementById('thinkingText');

        if (thinkingTextEl) {
            thinkingTextEl.textContent = `${assistant.name
                }

            æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚`;
        }

        else {
            console.warn('thinkingText å…ƒç´ æœªæ‰¾åˆ°');
        }

        // æ›´æ–°å³ä¾§åˆ†æé¢æ¿æ ‡é¢˜
        const consensusTitle = document.querySelector('.consensus-title');

        if (consensusTitle) {
            if (assistant.id === 'alex') {
                consensusTitle.textContent = 'éœ€æ±‚åˆ†ææˆæœ';
            }

            else if (assistant.id === 'song') {
                consensusTitle.textContent = 'æµ‹è¯•åˆ†ææˆæœ';
            }

            else {
                consensusTitle.textContent = 'åˆ†ææˆæœ';
            }
        }

        console.log('å¼€å§‹åˆå§‹åŒ–æ–°åŠ©æ‰‹...');

        // éšè—é€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢
        const assistantSelectorEl = document.getElementById('assistantSelector');

        if (assistantSelectorEl) {
            assistantSelectorEl.style.display = 'none';
        }

        else {
            console.warn('assistantSelector å…ƒç´ æœªæ‰¾åˆ°');
        }

        // æ˜¾ç¤ºè¿æ¥åŠ è½½åŠ¨ç”»
        showConnectionLoading('æ­£åœ¨åˆ›å»ºä¼šè¯...');

        try {
            console.log('æ­¥éª¤1: åˆ›å»ºä¼šè¯');
            // åˆ›å»ºä¼šè¯
            await createSessionWithAssistant(assistant.id);
            console.log('ä¼šè¯åˆ›å»ºæˆåŠŸï¼Œä¼šè¯ID:', currentSessionId);

            // æ›´æ–°åŠ è½½æ–‡æœ¬
            showConnectionLoading('æ­£åœ¨åˆå§‹åŒ–åŠ©æ‰‹...');

            console.log('æ­¥éª¤2: åˆå§‹åŒ–åŠ©æ‰‹');
            // åˆå§‹åŒ–åŠ©æ‰‹
            await initializeSelectedAssistant();

            console.log(`åŠ©æ‰‹åˆå§‹åŒ–å®Œæˆ: ${assistant.title
                }

                ${assistant.name
                }

                `);

        }

        catch (error) {
            console.error('é€‰æ‹©åŠ©æ‰‹å¤±è´¥:', error);
            showConnectionError('åˆå§‹åŒ–åŠ©æ‰‹å¤±è´¥: ' + error.message);
            // å¤±è´¥æ—¶æ˜¾ç¤ºé€‰æ‹©å™¨ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡è¯•
            const selectorForRetry = document.getElementById('assistantSelector');

            if (selectorForRetry) {
                selectorForRetry.style.display = 'block';
            }
        }
    }

    // åˆ‡æ¢åŠ©æ‰‹
    function switchAssistant() {
        // ä¿å­˜å½“å‰çŠ¶æ€
        saveSwitchState();

        // æ˜¾ç¤ºå¸¦å–æ¶ˆæŒ‰é’®çš„é€‰æ‹©å™¨
        showSwitchSelector();
    }

    // ä¿å­˜åˆ‡æ¢å‰çš„çŠ¶æ€
    function saveSwitchState() {
        const messagesArea = document.getElementById('messagesArea');
        const messages = Array.from(messagesArea.querySelectorAll('.message'));
        const consensusContent = document.getElementById('consensusContent');

        const chatTitleEl2 = document.getElementById('chatTitle');
        const statusDotEl = document.getElementById('connectionStatus');
        const statusTextEl = document.getElementById('statusText');

        savedSwitchState = {

            assistant: currentAssistant,
            sessionId: currentSessionId,
            isInitialized: isAIAssistantInitialized,
            messages: messages.map(msg => msg.outerHTML),
            consensusHTML: consensusContent ? consensusContent.innerHTML : '',
            chatTitle: chatTitleEl2 ? chatTitleEl2.textContent : 'è¯·é€‰æ‹©æ™ºèƒ½åŠ©æ‰‹',
            connectionStatus: {
                dot: statusDotEl ? statusDotEl.style.background : '',
                text: statusTextEl ? statusTextEl.textContent : 'æœªè¿æ¥'
            }
        }

            ;

        console.log('å·²ä¿å­˜åˆ‡æ¢å‰çŠ¶æ€');
    }

    // æ˜¾ç¤ºå¸¦å–æ¶ˆæŒ‰é’®çš„åŠ©æ‰‹é€‰æ‹©å™¨
    function showSwitchSelector() {
        const assistantSelector = document.getElementById('assistantSelector');
        const selectorContent = assistantSelector.querySelector('.selector-content');

        // ä¿å­˜åŸå§‹å†…å®¹
        if (!assistantSelector.dataset.originalContent) {
            assistantSelector.dataset.originalContent = selectorContent.innerHTML;
        }

        const currentName = currentAssistant ? currentAssistant.name : 'å½“å‰åŠ©æ‰‹';
        const messageCount = savedSwitchState ? savedSwitchState.messages.length : 0;

        // ä¿®æ”¹é€‰æ‹©å™¨å†…å®¹ï¼Œæ·»åŠ å–æ¶ˆæŒ‰é’®
        selectorContent.innerHTML = ` <h3>åˆ‡æ¢æ™ºèƒ½åŠ©æ‰‹</h3><p>è¯·é€‰æ‹©ä¸€ä½ä¸“ä¸šçš„AIåŠ©æ‰‹å¼€å§‹å¯¹è¯ï¼š</p><div class="assistant-cards" id="assistantCards"><!-- åŠ©æ‰‹å¡ç‰‡å°†åŠ¨æ€åŠ è½½ --></div><div class="selector-footer"><div style="display: flex; justify-content: center; margin: 16px 0;"><button onclick="cancelSwitch()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">å–æ¶ˆåˆ‡æ¢</button></div><p class="note">é€‰æ‹©æ–°åŠ©æ‰‹å³å¯å¼€å§‹å¯¹è¯</p></div>`;

        // æ˜¾ç¤ºé€‰æ‹©å™¨å¹¶é‡æ–°æ¸²æŸ“åŠ©æ‰‹å¡ç‰‡
        assistantSelector.style.display = 'block';
        const chatTitleEl3 = document.getElementById('chatTitle');

        if (chatTitleEl3) {
            chatTitleEl3.textContent = 'åˆ‡æ¢æ™ºèƒ½åŠ©æ‰‹';
        }

        renderAssistantSelector();

        // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°åˆ‡æ¢ç•Œé¢
        const messagesArea = document.getElementById('messagesArea');

        if (messagesArea) {
            messagesArea.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }

    // å–æ¶ˆåˆ‡æ¢ï¼Œæ¢å¤ä¹‹å‰çš„çŠ¶æ€
    function cancelSwitch() {
        if (!savedSwitchState) {
            console.warn('æ²¡æœ‰ä¿å­˜çš„çŠ¶æ€');
            return;
        }

        console.log('å–æ¶ˆåˆ‡æ¢ï¼Œæ¢å¤çŠ¶æ€');

        // æ¢å¤çŠ¶æ€
        currentAssistant = savedSwitchState.assistant;
        currentSessionId = savedSwitchState.sessionId;
        isAIAssistantInitialized = savedSwitchState.isInitialized;

        // æ¢å¤æ¶ˆæ¯
        const messagesArea = document.getElementById('messagesArea');
        const existingMessages = messagesArea.querySelectorAll('.message');
        existingMessages.forEach(msg => msg.remove());

        savedSwitchState.messages.forEach(messageHTML => {
            messagesArea.insertAdjacentHTML('beforeend', messageHTML);
        });

        // æ¢å¤å³ä¾§å†…å®¹
        const consensusContent = document.getElementById('consensusContent');

        if (consensusContent) {
            consensusContent.innerHTML = savedSwitchState.consensusHTML;
        }

        // æ¢å¤æ ‡é¢˜
        const chatTitleEl4 = document.getElementById('chatTitle');

        if (chatTitleEl4) {
            chatTitleEl4.textContent = savedSwitchState.chatTitle;
        }

        // æ¢å¤è¿æ¥çŠ¶æ€
        const statusDot = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        if (statusDot) statusDot.style.background = savedSwitchState.connectionStatus.dot;
        if (statusText) statusText.textContent = savedSwitchState.connectionStatus.text;

        // éšè—é€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
        const selectorEl = document.getElementById('assistantSelector');
        const switchBtnEl2 = document.getElementById('assistantSwitchBtn');
        if (selectorEl) selectorEl.style.display = 'none';
        if (switchBtnEl2) switchBtnEl2.style.display = 'inline-block';

        // æ¢å¤é€‰æ‹©å™¨åŸå§‹å†…å®¹
        const assistantSelector = document.getElementById('assistantSelector');
        const selectorContent = assistantSelector.querySelector('.selector-content');

        if (assistantSelector.dataset.originalContent) {
            selectorContent.innerHTML = assistantSelector.dataset.originalContent;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateSendButtonState();

        // æ¸…é™¤ä¿å­˜çš„çŠ¶æ€
        savedSwitchState = null;

        // æ»šåŠ¨åˆ°åº•éƒ¨
        scrollToBottom();

        console.log('å·²æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€');
    }

    // ä½¿ç”¨æŒ‡å®šåŠ©æ‰‹åˆ›å»ºä¼šè¯
    async function createSessionWithAssistant(assistantType) {
        console.log(`å¼€å§‹åˆ›å»º${assistantType
            }

            åŠ©æ‰‹ä¼šè¯...`);

        const response = await axios.post('/api/requirements/sessions', {
            project_name: `${assistantType.toUpperCase()}åŠ©æ‰‹ä¼šè¯`,
            assistant_type: assistantType
        });

        console.log('åˆ›å»ºä¼šè¯ APIå“åº”:', response.data);

        if (response.data.code === 200) {
            currentSessionId = response.data.data.id;

            console.log(`ä¼šè¯åˆ›å»ºæˆåŠŸï¼ŒID: ${currentSessionId
                }

            , åŠ©æ‰‹ç±»å‹: ${assistantType
                }

            `);
            updateConnectionStatus('ready', 'å°±ç»ª');
        }

        else {
            throw new Error(response.data.message || 'åˆ›å»ºä¼šè¯å¤±è´¥');
        }
    }

    // åˆå§‹åŒ–é€‰ä¸­çš„åŠ©æ‰‹
    async function initializeSelectedAssistant() {
        console.log('å¼€å§‹åˆå§‹åŒ–åŠ©æ‰‹...', {
            currentAssistant, currentSessionId
        });

        if (!currentAssistant || !currentSessionId) {
            const errorMsg = 'åŠ©æ‰‹æˆ–ä¼šè¯æœªåˆå§‹åŒ–';
            console.error(errorMsg);
            showConnectionError(errorMsg);
            return;
        }

        try {
            console.log(`è·å–${currentAssistant.id
                }

            åŠ©æ‰‹çš„bundle...`);

            // è·å–åŠ©æ‰‹çš„bundleå†…å®¹
            const bundleResponse = await axios.get(`/api/requirements/assistants/${currentAssistant.id}/bundle`);

            console.log('Bundle APIå“åº”:', bundleResponse.data);

            if (bundleResponse.data.code === 200) {
                const bundleContent = bundleResponse.data.data.bundle_content;

                console.log('Bundleå†…å®¹é•¿åº¦:', bundleContent.length);

                // æ›´æ–°åŠ è½½çŠ¶æ€
                showConnectionLoading('æ­£åœ¨å»ºç«‹è¿æ¥...');

                // å‘é€bundleæ¿€æ´»æ¶ˆæ¯
                console.log('å‘é€bundleæ¿€æ´»æ¶ˆæ¯...');
                await sendBundleMessage(bundleContent);

                isAIAssistantInitialized = true;
                updateSendButtonState();

                // æ˜¾ç¤ºæˆåŠŸåŠ¨ç”»
                showConnectionSuccess(currentAssistant.name);

                console.log('åŠ©æ‰‹åˆå§‹åŒ–å®Œæˆ');
            }

            else {
                throw new Error('è·å–bundleå¤±è´¥: ' + bundleResponse.data.message);
            }
        }

        catch (error) {
            console.error('åˆå§‹åŒ–åŠ©æ‰‹å¤±è´¥:', error);
            showConnectionError('åŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä¾›ä¸Šå±‚å¤„ç†
        }
    }

    // å‘é€Bundleæ¿€æ´»æ¶ˆæ¯
    async function sendBundleMessage(bundleContent) {
        console.log('å¼€å§‹å‘é€Bundleæ¿€æ´»æ¶ˆæ¯...');

        try {
            const response = await axios.post(`/api/requirements/sessions/${currentSessionId}/messages`, {
                content: bundleContent
            });

            console.log('Bundleæ¶ˆæ¯å‘é€å“åº”:', response.data);

            if (response.data.code === 200) {
                const data = response.data.data;
                console.log('Bundleæ¿€æ´»æˆåŠŸï¼ŒAIå“åº”:', data.ai_message);

                // æ˜¾ç¤ºAIçš„æ¬¢è¿æ¶ˆæ¯
                if (data.ai_message) {
                    displayMessage(data.ai_message);
                    scrollToBottom();

                    // ç«‹å³æ›´æ–°è¿æ¥çŠ¶æ€
                    if (currentAssistant) {
                        const assistantName = currentAssistant.name;

                        updateConnectionStatus('connected', `AIåŠ©æ‰‹${assistantName
                            }

                        å·²æ¿€æ´»`);
                        console.log(`Bundleæ¿€æ´»æˆåŠŸï¼Œæ›´æ–°çŠ¶æ€ä¸ºå·²è¿æ¥`);
                    }
                }

                return true;
            }

            else {
                throw new Error('Bundleæ¿€æ´»å¤±è´¥: ' + response.data.message);
            }
        }

        catch (error) {
            console.error('å‘é€Bundleæ¶ˆæ¯å¤±è´¥:', error);
            throw error;
        }
    }

    // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯ï¼ˆåœ¨èŠå¤©ç•Œé¢ä¸­æ˜¾ç¤ºè€Œä¸æ˜¯å¼¹å‡ºå¯¹è¯æ¡†ï¼‰
    function displaySystemMessage(content, type = 'info') {
        const messagesArea = document.getElementById('messagesArea');
        const messageEl = document.createElement('div');

        messageEl.className = `message system ${type
            }

        `;

        const time = new Date().toLocaleTimeString();
        const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';

        messageEl.innerHTML = ` <div class="message-header"><div class="message-avatar">${icon
            }

        </div><div class="message-meta"><div class="message-sender">ç³»ç»Ÿ</div><div class="message-time">${time
            }

        </div></div></div><div class="message-content">${content
            }

        </div>`;

        messagesArea.appendChild(messageEl);
        scrollToBottom();
    }

    // åˆ›å»ºæ–°ä¼šè¯  
    async function createSession() {
        try {
            const response = await axios.post('/api/requirements/sessions', {
                project_name: 'éœ€æ±‚åˆ†æä¼šè¯' // ä½¿ç”¨å›ºå®šçš„é»˜è®¤åç§°
            });

            if (response.data.code === 200) {
                currentSessionId = response.data.data.id;
                console.log('ä¼šè¯åˆ›å»ºæˆåŠŸ:', currentSessionId);

                // åŠ å…¥WebSocketæˆ¿é—´ï¼ˆä»…æœ¬åœ°ç¯å¢ƒï¼‰
                if (!isVercelEnvironment()) {
                    socket.emit('join_requirements_session', {
                        session_id: currentSessionId
                    });
                }

                // æ˜¾ç¤ºè¿æ¥AIåŠ©æ‰‹çš„æç¤º
                showConnectPrompt();
            }

            else {
                throw new Error(response.data.message);
            }
        }

        catch (error) {
            console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
            showMessage('åˆ›å»ºä¼šè¯å¤±è´¥: ' + error.message, 'error');
        }
    }

    // åŠ è½½å®Œæ•´çš„AIåŠ©æ‰‹Bundleå†…å®¹
    async function loadAssistantBundleContent() {
        try {
            const assistantId = currentAssistant ? currentAssistant.id : 'alex';

            const response = await axios.get(`/api/requirements/assistants/${assistantId}/bundle`);
            if (response.data.code === 200) {
                return response.data.data.bundle_content;
            }

            else {
                // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨fallback bundle
                return getFallbackAssistantBundle();
            }
        }

        catch (error) {
            console.warn('æ— æ³•åŠ è½½å®Œæ•´bundleï¼Œä½¿ç”¨fallbackç‰ˆæœ¬:', error);
            return getFallbackAssistantBundle();
        }
    }

    // è·å–fallbackçš„AIåŠ©æ‰‹ bundleï¼ˆç®€åŒ–ç‰ˆï¼‰
    function getFallbackAssistantBundle() {
        const assistantName = currentAssistant ? currentAssistant.name : 'AIåŠ©æ‰‹';
        const assistantTitle = currentAssistant ? currentAssistant.title : 'æ™ºèƒ½åŠ©æ‰‹';

        return `ä½ çš„å…³é”®æ“ä½œæŒ‡ä»¤å·²é™„åœ¨ä¸‹æ–¹ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§æŒ‡ä»¤ä¸­çš„personaæ‰§è¡Œï¼Œä¸è¦æ‰“ç ´è§’è‰²è®¾å®šã€‚ ä½ æ˜¯${assistantName
            }

        ï¼Œ${assistantTitle
            }

        ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ¿€æ´»æŒ‡ä»¤æ‰§è¡Œï¼š STEP 1: é‡‡ç”¨${assistantTitle
            }

        ${assistantName
            }

        çš„èº«ä»½ STEP 2: ä»¥${assistantName
            }

        çš„èº«ä»½å‘ç”¨æˆ·é—®å¥½ STEP 3: ç«‹å³è¿è¡Œ *help å‘½ä»¤æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨åŠŸèƒ½ STEP 4: ç­‰å¾…ç”¨æˆ·é€‰æ‹©åŠŸèƒ½æˆ–ç›´æ¥æè¿°éœ€æ±‚===ä½ çš„èº«ä»½===name: ${assistantName
            }

        title: ${assistantTitle
            }

        role: ä¸“ä¸šçš„AIåŠ©æ‰‹ focus: ä¸ºç”¨æˆ·æä¾›ä¸“ä¸šçš„å¸®åŠ©å’ŒæŒ‡å¯¼ ç°åœ¨è¯·ä»¥${assistantName
            }

        çš„èº«ä»½é—®å¥½å¹¶è¿è¡Œ *help å‘½ä»¤ã€‚`;
    }

    // é˜²é‡å¤è¿æ¥æ ‡å¿—
    let isConnecting = false;

    // è¿æ¥AIåŠ©æ‰‹ - å‘é€æ™ºèƒ½éœ€æ±‚åˆ†æå¸ˆæç¤ºè¯æ¿€æ´»Alex
    async function connectAIAssistant() {
        if (!currentSessionId || isConnecting) {
            console.error('æ²¡æœ‰æ´»è·ƒçš„ä¼šè¯IDæˆ–æ­£åœ¨è¿æ¥ä¸­');
            return;
        }

        isConnecting = true;

        try {
            const assistantName = currentAssistant ? currentAssistant.name : 'AIåŠ©æ‰‹';

            updateConnectionStatus('connecting', `æ­£åœ¨æ¿€æ´»${assistantName
                }

                ...`);
            // ç«‹å³è®¾ç½®æŒ‰é’®çŠ¶æ€ï¼Œå†…éƒ¨å·²æœ‰å»¶è¿Ÿå¤„ç†
            setConnectButtonState('loading');

            // ä»å®Œæ•´çš„bundleæ–‡ä»¶ä¸­è·å–æ¿€æ´»æ¶ˆæ¯
            const activationMessage = await loadAssistantBundleContent();

            // ä½¿ç”¨HTTPå‘é€æ¿€æ´»æ¶ˆæ¯ï¼ˆåˆå§‹åŒ–æ—¶ä¸æ˜¾ç¤ºå¤„ç†åŠ¨ç”»ï¼‰
            await sendMessageViaHTTP(activationMessage, false);

        }

        catch (error) {
            console.error('è¿æ¥AIåŠ©æ‰‹å¤±è´¥:', error);
            updateConnectionStatus('error', 'è¿æ¥å¤±è´¥');
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            setConnectButtonState('normal');
            showMessage('è¿æ¥AIåŠ©æ‰‹å¤±è´¥: ' + error.message, 'error');
        }

        finally {
            // æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½é‡ç½®è¿æ¥çŠ¶æ€
            isConnecting = false;
        }
    }

    // è®¾ç½®è¿æ¥æŒ‰é’®çŠ¶æ€
    function setConnectButtonState(state) {

        // ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        setTimeout(() => {
            try {
                const connectBtns = document.querySelectorAll('.connect-btn');

                if (!connectBtns || connectBtns.length === 0) {
                    console.log('æœªæ‰¾åˆ°è¿æ¥æŒ‰é’®ï¼Œå¯èƒ½è¿˜æœªæ¸²æŸ“å®Œæˆ');
                    // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼Œå†æ¬¡å°è¯•
                    setTimeout(() => setConnectButtonState(state), 500);
                    return;
                }

                connectBtns.forEach(btn => {
                    if (!btn || typeof btn !== 'object') {
                        console.warn('å‘ç°æ— æ•ˆæŒ‰é’®å…ƒç´ ï¼Œè·³è¿‡å¤„ç†');
                        return;
                    }

                    try {

                        // å½»åº•æ£€æŸ¥classListå±æ€§
                        if (!btn.classList || typeof btn.classList.remove !== 'function') {
                            console.warn('æŒ‰é’®å…ƒç´ ç¼ºå°‘classListæ–¹æ³•ï¼Œè·³è¿‡å¤„ç†');
                            return;
                        }

                        // å®‰å…¨åœ°ç§»é™¤ç±»
                        btn.classList.remove('loading', 'disabled');

                        const assistantName = currentAssistant ? currentAssistant.name : 'AIåŠ©æ‰‹';

                        switch (state) {
                            case 'loading': btn.classList.add('loading');
                                btn.disabled = true;

                                btn.textContent = `æ­£åœ¨åˆå§‹åŒ–${assistantName
                                    }

                                    ...`;
                                break;
                            case 'activated': btn.classList.add('disabled');
                                btn.disabled = true;

                                btn.textContent = `${assistantName
                                    }

                                    å·²æ¿€æ´»`;
                                break;
                            case 'normal': default: btn.disabled = false;

                                btn.textContent = `è¿æ¥${assistantName
                                    }

                                    `;
                                break;
                        }
                    }

                    catch (innerError) {
                        console.error('è®¾ç½®å•ä¸ªæŒ‰é’®çŠ¶æ€æ—¶å‡ºé”™:', innerError, btn);
                    }
                });
            }

            catch (error) {
                console.error('setConnectButtonStateæ‰§è¡Œå¤±è´¥:', error);
            }
        }

            , 200);
    }

    // æ˜¾ç¤ºè¿æ¥AIåŠ©æ‰‹çš„æç¤º - å·²ç¦ç”¨ï¼Œä½¿ç”¨æ–°çš„åŠ©æ‰‹é€‰æ‹©å™¨
    async function showConnectPrompt() {
        console.log('showConnectPrompt è¢«è°ƒç”¨ï¼Œä½†å·²ç¦ç”¨ - ä½¿ç”¨æ–°çš„åŠ©æ‰‹é€‰æ‹©å™¨');
        // ä¸åšä»»ä½•æ“ä½œï¼Œè®©åŠ©æ‰‹é€‰æ‹©å™¨æ­£å¸¸æ˜¾ç¤º
    }

    // æ£€æŸ¥AIé…ç½®æ˜¯å¦å­˜åœ¨
    async function checkAIConfiguration() {
        try {
            const response = await axios.get('/api/ai-configs');
            console.log('AIé…ç½®æ£€æŸ¥å“åº”:', response.data); // è°ƒè¯•æ—¥å¿—

            // è¯¦ç»†æ£€æŸ¥å“åº”ç»“æ„
            const hasValidResponse = response.data.code === 200;
            const hasData = response.data.data;
            const hasConfigs = hasData && response.data.data.configs;
            const hasConfigsLength = hasConfigs && response.data.data.configs.length > 0;

            console.log('AIé…ç½®æ£€æŸ¥è¯¦æƒ…:', {
                hasValidResponse,
                hasData,
                hasConfigs,
                configsLength: hasConfigs ? response.data.data.configs.length : 0,
                hasConfigsLength
            });

            return hasValidResponse && hasData && hasConfigs && hasConfigsLength;
        }

        catch (error) {
            console.error('æ£€æŸ¥AIé…ç½®å¤±è´¥:', error);
            return false;
        }
    }

    // é˜²é‡å¤å‘é€æ ‡å¿—
    let isSending = false;

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();

        // å¿…é¡»æœ‰æ–‡æœ¬å†…å®¹æ‰èƒ½å‘é€ï¼ˆä»…æœ‰é™„ä»¶ä¸å…è®¸å‘é€ï¼‰
        if (!content || !currentSessionId || isSending) {
            console.log('å‘é€è¢«é˜»æ­¢:', {
                hasContent: ! !content,
                hasSession: ! !currentSessionId,
                isSending: isSending,
                attachedFilesCount: attachedFiles.length
            });
            return;
        }

        // è®¾ç½®å‘é€ä¸­çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤å‘é€
        isSending = true;
        updateSendButtonState(); // æ›´æ–°æŒ‰é’®çŠ¶æ€

        // æ£€æŸ¥è¿æ¥çŠ¶æ€ï¼ˆVercelç¯å¢ƒä¸éœ€è¦WebSocketè¿æ¥ï¼‰
        if (!isVercelEnvironment() && !isConnected) {
            isSending = false; // é‡ç½®å‘é€çŠ¶æ€
            showMessage('WebSocketæœªè¿æ¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            return;
        }

        // ä¿å­˜å½“å‰é™„ä»¶å‰¯æœ¬ï¼Œç”¨äºå‘é€
        const filesToSend = [...attachedFiles];

        // ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«é™„ä»¶ä¿¡æ¯ï¼‰
        const userMessage = {

            message_type: 'user',
            content: content,
            attached_files: filesToSend.map(f => ({
                filename: f.name,
                size: f.size
            })),
            created_at: new Date().toISOString()
        }

            ;
        displayMessage(userMessage);

        // æ¸…ç©ºè¾“å…¥æ¡†å’Œé™„ä»¶
        messageInput.value = '';
        messageInput.style.height = 'auto';
        document.getElementById('charCount').textContent = '0';
        attachedFiles = []; // æ¸…ç©ºé™„ä»¶
        updateAttachmentPreview(); // æ›´æ–°é™„ä»¶é¢„è§ˆ
        updateSendButtonState();

        // å»¶è¿Ÿæ˜¾ç¤ºAIå¤„ç†åŠ¨æ•ˆï¼Œç¡®ä¿ç”¨æˆ·æ¶ˆæ¯å…ˆå®Œæˆæ¸²æŸ“å’Œæ»šåŠ¨
        setTimeout(() => {
            const assistantName = currentAssistant ? currentAssistant.name : 'AIåŠ©æ‰‹';

            showAiProcessing(`${assistantName
                }

                æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚`);
        }

            , 200);

        try {

            // ä½¿ç”¨HTTPå‘é€æ¶ˆæ¯ï¼ˆæ”¯æŒæ–‡ä»¶é™„ä»¶ï¼‰
            if (filesToSend.length > 0) {
                await sendMessageWithFiles(content, filesToSend);
            }

            else {
                await sendMessageViaHTTP(content);
            }
        }

        catch (error) {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            hideAiProcessing();
            showMessage('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
        }

        finally {
            // æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½é‡ç½®å‘é€çŠ¶æ€
            isSending = false;
            updateSendButtonState(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function displayMessage(message) {
        const messagesArea = document.getElementById('messagesArea');
        const messageEl = document.createElement('div');

        messageEl.className = `message ${message.message_type
            }

        `;
        messageEl.dataset.messageId = message.id; // æ·»åŠ æ¶ˆæ¯IDï¼Œç”¨äºåˆ·æ–°æ—¶å®šä½

        const avatar = message.message_type === 'user' ? 'ä½ ' : 'AI';
        const time = new Date(message.created_at).toLocaleTimeString();

        // AIæ¶ˆæ¯å¤„ç†ï¼šæå–è¿›å±•å†…å®¹å¹¶æ¸²æŸ“ï¼Œç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨æ™®é€šHTMLè½¬ä¹‰
        let contentHtml;

        if (message.message_type === 'ai' || message.message_type === 'assistant') {
            console.log('å¤„ç†AIæ¶ˆæ¯ï¼ŒåŸå§‹é•¿åº¦:', message.content.length);
            console.log('åŸå§‹å†…å®¹é¢„è§ˆ:', message.content.substring(0, 200) + '...');

            // ä»AIæ¶ˆæ¯ä¸­æå–è¿›å±•æ€»ç»“å†…å®¹
            const extracted = extractProgressContent(message.content);

            console.log('æå–ç»“æœ:', {
                hasProgress: extracted.hasProgress,
                progressContentLength: extracted.progressContent.length,
                cleanedContentLength: extracted.cleanedContent.length
            });

            // å¦‚æœæœ‰è¿›å±•å†…å®¹ï¼Œæ›´æ–°åˆ†ææˆæœåŒºåŸŸ
            if (extracted.hasProgress) {
                console.log('æ›´æ–°åˆ†ææˆæœåŒºåŸŸ');
                updateAnalysisResults(extracted.progressContent);
            }

            // ä½¿ç”¨æ¸…ç†åçš„å†…å®¹è¿›è¡Œmarkdownè§£æå’Œæ˜¾ç¤º
            contentHtml = parseMarkdown(extracted.cleanedContent);

            console.log('æœ€ç»ˆæ˜¾ç¤ºå†…å®¹é•¿åº¦:', extracted.cleanedContent.length);
        }

        else {
            contentHtml = escapeHtml(message.content);
        }

        // ä¸ºç”¨æˆ·æ¶ˆæ¯æ·»åŠ é™„ä»¶æ˜¾ç¤º
        let attachmentHtml = '';

        if (message.message_type === 'user' && message.attached_files && message.attached_files.length > 0) {
            attachmentHtml = ` <div class="message-attachments">${message.attached_files.map(file => ` <div class="attachment-indicator" > ğŸ“ ${escapeHtml(file.filename)
                }

                    (${formatFileSize(file.size || 0)
                }) </div > `).join('')
                }

        </div>`;
        }

        // ç§»é™¤äº†AIæ¶ˆæ¯åˆ·æ–°åŠŸèƒ½
        const refreshButton = '';

        messageEl.innerHTML = ` <div class="message-avatar">${avatar
            }

    </div><div class="message-body"><div class="message-content ${message.message_type === 'ai' || message.message_type === 'assistant' ? 'ai-formatted' : ''}">${contentHtml
            }

    </div>${attachmentHtml
            }

    <div class="message-footer"><div class="message-time">${time
            }

    </div>${refreshButton
            }

    </div></div>`;

        messagesArea.appendChild(messageEl);

        // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œé¿å…çªç„¶è·³è½¬
        scrollToBottom();
    }


    // åŠ è½½ä¼šè¯æ¶ˆæ¯
    async function loadSessionMessages() {
        if (!currentSessionId) return;

        try {
            const response = await axios.get(`/api/requirements/sessions/${currentSessionId}/messages`);

            if (response.data.code === 200) {
                const messages = response.data.data.messages;
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.innerHTML = '';

                messages.forEach(displayMessage);
            }
        }

        catch (error) {
            console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
        }
    }

    // ================================
    // æ‹–æ‹½åˆ†éš”æ¡åŠŸèƒ½
    // ================================

    let isResizing = false;
    let startX = 0;
    let startLeftWidth = 0;

    // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
    function initializeResize() {
        const resizeHandle = document.getElementById('resizeHandle');
        const desktopLayout = document.querySelector('.desktop-layout');
        const chatPanel = document.querySelector('.chat-panel');
        const analysisPanel = document.querySelector('.analysis-panel');

        if (!resizeHandle || !desktopLayout || !chatPanel || !analysisPanel) {
            console.warn('æ‹–æ‹½åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼šæ‰¾ä¸åˆ°å¿…è¦å…ƒç´ ', {
                resizeHandle: ! !resizeHandle,
                desktopLayout: ! !desktopLayout,
                chatPanel: ! !chatPanel,
                analysisPanel: ! !analysisPanel
            });
            return;
        }

        console.log('æ‹–æ‹½åŠŸèƒ½åˆå§‹åŒ–: æ‰¾åˆ°æ‰€æœ‰å¿…è¦å…ƒç´ ');

        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        resizeHandle.addEventListener('mousedown', function (e) {
            isResizing = true;
            startX = e.clientX;

            // è·å–å½“å‰å®½åº¦
            const chatRect = chatPanel.getBoundingClientRect();
            startLeftWidth = chatRect.width;

            // æ·»åŠ æ‹–æ‹½çŠ¶æ€æ ·å¼
            desktopLayout.classList.add('resizing');

            // ç¦ç”¨æ–‡æœ¬é€‰æ‹©
            document.body.style.userSelect = 'none';

            e.preventDefault();

            const containerWidth = desktopLayout.getBoundingClientRect().width;

            console.log(`å¼€å§‹æ‹–æ‹½: startX=${startX
                }

                , startLeftWidth=${startLeftWidth
                }

                px, å®¹å™¨å®½åº¦=${containerWidth
                }

                px`);
        });

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        document.addEventListener('mousemove', function (e) {
            if (!isResizing) return;

            const currentX = e.clientX;
            const deltaX = currentX - startX;
            let newLeftWidth = startLeftWidth + deltaX;

            // è®¾ç½®æœ€å°/æœ€å¤§å®½åº¦é™åˆ¶ï¼ˆå®‰å…¨é˜ˆå€¼ 500pxï¼‰
            const minWidth = 500;
            const containerRect = desktopLayout.getBoundingClientRect();
            const containerPadding = 40; // 20px å·¦å³ padding
            const actualContainerWidth = containerRect.width - containerPadding;
            const handleWidth = 12;
            const rightMinWidth = 500; // æ¢å¤å®‰å…¨é˜ˆå€¼ 500px
            const maxWidth = actualContainerWidth - handleWidth - rightMinWidth;

            // æ·»åŠ å®‰å…¨è¾¹è·ï¼Œç¡®ä¿ä¸ä¼šå¡ä½
            const safetyMargin = 10;
            const safeMaxWidth = Math.max(minWidth + safetyMargin, maxWidth - safetyMargin);

            newLeftWidth = Math.max(minWidth, Math.min(newLeftWidth, safeMaxWidth));

            // è°ƒè¯•: æ˜¾ç¤ºè®¡ç®—ç»“æœ
            if (deltaX !== 0) {
                console.log(`å®¹å™¨: ${containerRect.width
                    }

                    px, å®é™…: ${actualContainerWidth
                    }

                    px, ç†è®ºæœ€å¤§: ${maxWidth
                    }

                    px, å®‰å…¨æœ€å¤§: ${safeMaxWidth
                    }

                    px, å½“å‰: ${newLeftWidth
                    }

                    px`);
            }

            // ç›´æ¥è®¾ç½®å®½åº¦
            chatPanel.style.width = newLeftWidth + 'px';
            chatPanel.style.flex = 'none';

            // æ‰“å°æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
            const rightWidth = analysisPanel.getBoundingClientRect().width;

            console.log(`[drag] container=${containerRect.width
                }

                px, actual=${actualContainerWidth
                }

                px, left=${newLeftWidth
                }

                px, right=${rightWidth
                }

                px, minLeft=${minWidth
                }

                , minRight=${rightMinWidth
                }

                `);

            e.preventDefault();
        });

        // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
        document.addEventListener('mouseup', function (e) {
            if (!isResizing) return;

            isResizing = false;

            // ç§»é™¤æ‹–æ‹½çŠ¶æ€æ ·å¼
            desktopLayout.classList.remove('resizing');

            // æ¢å¤æ–‡æœ¬é€‰æ‹©
            document.body.style.userSelect = '';

            // è·å–æœ€ç»ˆå®½åº¦
            const finalWidth = chatPanel.getBoundingClientRect().width;

            console.log(`æ‹–æ‹½ç»“æŸ: æœ€ç»ˆå®½åº¦=${finalWidth
                }

                px, å˜åŒ–=${finalWidth - startLeftWidth
                }

                px`);
        });

        // è§¦æ‘¸æ”¯æŒï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
        resizeHandle.addEventListener('touchstart', function (e) {
            const touch = e.touches[0];
            isResizing = true;
            startX = touch.clientX;

            const chatRect = chatPanel.getBoundingClientRect();
            startLeftWidth = chatRect.width;

            desktopLayout.classList.add('resizing');
            e.preventDefault();
        });

        document.addEventListener('touchmove', function (e) {
            if (!isResizing) return;

            const touch = e.touches[0];
            const deltaX = touch.clientX - startX;
            let newLeftWidth = startLeftWidth + deltaX;

            const minWidth = 500;
            const containerRect = desktopLayout.getBoundingClientRect();
            const containerPadding = 40;
            const actualContainerWidth = containerRect.width - containerPadding;
            const handleWidth = 12;
            const rightMinWidth = 500; // ä¸æ¡Œé¢ä¸€è‡´
            const maxWidth = actualContainerWidth - handleWidth - rightMinWidth;

            // æ·»åŠ å®‰å…¨è¾¹è·ï¼Œç¡®ä¿ä¸ä¼šå¡ä½
            const safetyMargin = 10;
            const safeMaxWidth = Math.max(minWidth + safetyMargin, maxWidth - safetyMargin);

            newLeftWidth = Math.max(minWidth, Math.min(newLeftWidth, safeMaxWidth));
            // è°ƒè¯•æ—¥å¿—
            const rightWidth = analysisPanel.getBoundingClientRect().width;

            console.log(`[touch-drag] container=${containerRect.width
                }

                px, actual=${actualContainerWidth
                }

                px, left=${newLeftWidth
                }

                px, right=${rightWidth
                }

                px, minLeft=${minWidth
                }

                , minRight=${rightMinWidth
                }

                `);

            chatPanel.style.width = newLeftWidth + 'px';
            chatPanel.style.flex = 'none';

            e.preventDefault();
        });

        document.addEventListener('touchend', function (e) {
            if (!isResizing) return;

            isResizing = false;
            desktopLayout.classList.remove('resizing');
        });

        console.log('æ‹–æ‹½åˆ†éš”æ¡åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    }

    // ================================
    // è¿æ¥åŠ è½½åŠ¨ç”»æ§åˆ¶å‡½æ•°
    // ================================

    // æ˜¾ç¤ºè¿æ¥åŠ è½½åŠ¨ç”»
    function showConnectionLoading(text = 'æ­£åœ¨åˆå§‹åŒ–...') {
        const overlay = document.getElementById('connectionLoadingOverlay');
        const loadingText = document.getElementById('connectionLoadingText');
        const loadingDots = document.getElementById('connectionLoadingDots');
        const errorElement = document.getElementById('connectionError');
        const retryBtn = document.getElementById('connectionRetryBtn');

        if (!overlay) {
            console.warn('æ‰¾ä¸åˆ°è¿æ¥åŠ è½½é®ç½©å…ƒç´ ');
            return;
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        loadingText.textContent = text;
        loadingDots.style.display = 'inline-flex';
        errorElement.style.display = 'none';
        retryBtn.style.display = 'none';

        // æ˜¾ç¤ºé®ç½©
        overlay.classList.add('show');

        console.log('æ˜¾ç¤ºè¿æ¥åŠ è½½åŠ¨ç”»:', text);
    }

    // éšè—è¿æ¥åŠ è½½åŠ¨ç”»
    function hideConnectionLoading() {
        const overlay = document.getElementById('connectionLoadingOverlay');

        if (overlay) {
            overlay.classList.remove('show');
            console.log('éšè—è¿æ¥åŠ è½½åŠ¨ç”»');
        }
    }

    // AIå“åº”åç›´æ¥éšè—è¿æ¥åŠ¨ç”»
    function showConnectionSuccess(assistantName) {
        // ç›´æ¥éšè—åŠ è½½é®ç½©ï¼Œä¸æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        hideConnectionLoading();
    }

    // æ˜¾ç¤ºè¿æ¥é”™è¯¯
    function showConnectionError(errorMessage) {
        const loadingText = document.getElementById('connectionLoadingText');
        const loadingDots = document.getElementById('connectionLoadingDots');
        const errorElement = document.getElementById('connectionError');
        const retryBtn = document.getElementById('connectionRetryBtn');

        if (loadingText && loadingDots && errorElement && retryBtn) {
            loadingText.textContent = 'è¿æ¥å¤±è´¥';
            loadingText.className = 'connection-loading-text connection-error';
            loadingDots.style.display = 'none';
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';

            // æ˜¾ç¤ºé‡è¯•æŒ‰é’®ï¼ˆå¦‚æœæœªè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰
            if (connectionRetryCount < maxRetries) {
                retryBtn.style.display = 'inline-block';
            }

            console.log('æ˜¾ç¤ºè¿æ¥é”™è¯¯:', errorMessage);
        }
    }

    // é‡è¯•è¿æ¥
    function retryConnection() {
        if (connectionRetryCount >= maxRetries) {
            console.log('å·²è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°');
            return;
        }

        connectionRetryCount++;

        console.log(`ç¬¬${connectionRetryCount
            }

            æ¬¡é‡è¯•è¿æ¥`);

        // é‡æ–°åˆå§‹åŒ–åŠ©æ‰‹
        if (currentAssistant) {
            initializeSelectedAssistant();
        }
    }

    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(status, text) {
        const statusDot = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');

        if (!statusDot || !statusText) {
            console.warn('æ‰¾ä¸åˆ°çŠ¶æ€æ˜¾ç¤ºå…ƒç´ ');
            return;
        }

        // é‡ç½®çŠ¶æ€ç‚¹çš„åŸºç¡€æ ·å¼
        statusDot.className = 'status-dot';

        // æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²å’Œæ–‡æœ¬
        switch (status) {
            case 'connected':
            case true: // å…¼å®¹æ—§ç‰ˆæœ¬
                statusDot.style.background = '#28a745';
                statusText.textContent = text || 'å·²è¿æ¥';
                console.log('çŠ¶æ€æ›´æ–°ä¸ºå·²è¿æ¥:', text);
                break;
            case 'connecting':
                statusDot.style.background = '#ffc107';
                statusText.textContent = text || 'è¿æ¥ä¸­';
                break;
            case 'ready':
                statusDot.style.background = '#17a2b8';
                statusText.textContent = text || 'å°±ç»ª';
                break;
            case 'config-needed':
                statusDot.style.background = '#6c757d';
                statusText.textContent = text || 'éœ€è¦é…ç½®';
                break;
            case 'disconnected':
            case 'error': case false: // å…¼å®¹æ—§ç‰ˆæœ¬
            default: statusDot.style.background = '#dc3545';
                statusText.textContent = text || 'æœªè¿æ¥';
                break;
        }

        console.log(`çŠ¶æ€æ›´æ–°: ${status
            }

            -> ${statusText.textContent
            }

            `);
    }

    // æ˜¾ç¤ºAIå¤„ç†åŠ¨æ•ˆ
    function showAiProcessing(text = 'AIåŠ©æ‰‹æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚') {
        const messagesArea = document.getElementById('messagesArea');

        if (!messagesArea) {
            console.warn('æœªæ‰¾åˆ°æ¶ˆæ¯åŒºåŸŸ');
            return;
        }

        // ç§»é™¤ç°æœ‰çš„AIå¤„ç†å…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        let existingAiProcessing = document.getElementById('aiProcessing');

        if (existingAiProcessing) {
            existingAiProcessing.remove();
        }

        // åˆ›å»ºæ–°çš„AIå¤„ç†å…ƒç´ å¹¶æ·»åŠ åˆ°æ¶ˆæ¯åŒºåŸŸæœ«å°¾
        const aiProcessing = document.createElement('div');
        aiProcessing.id = 'aiProcessing';
        aiProcessing.className = 'ai-processing show';

        aiProcessing.innerHTML = ` <div class="message-avatar">AI</div><div class="thinking-content"><div class="thinking-text">${text
            }

        </div><div class="processing-dots"><div class="processing-dot"></div><div class="processing-dot"></div><div class="processing-dot"></div></div></div>`;

        // ç¡®ä¿æ·»åŠ åˆ°æ¶ˆæ¯åŒºåŸŸçš„æœ€åä½ç½®
        messagesArea.appendChild(aiProcessing);

        // æ»šåŠ¨åˆ°æ¶ˆæ¯åŒºåŸŸåº•éƒ¨
        scrollToBottom(150);
    }

    // éšè—AIå¤„ç†åŠ¨æ•ˆ
    function hideAiProcessing() {
        const aiProcessing = document.getElementById('aiProcessing');

        if (aiProcessing) {
            // å®Œå…¨ç§»é™¤AIå¤„ç†åŠ¨ç”»å…ƒç´ ï¼Œè€Œä¸ä»…ä»…æ˜¯éšè—
            aiProcessing.remove();
        }

        else {
            console.warn('æœªæ‰¾åˆ°AIå¤„ç†åŠ¨æ•ˆå…ƒç´ ');
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆAIå¤„ç†å®Œæˆåå¯ä»¥åˆ‡æ¢åŠ©æ‰‹ï¼‰
        updateSendButtonState();
    }

    // æ›´æ–°å…±è¯†æ˜¾ç¤º
    function updateConsensusDisplay(consensus) {
        const consensusContent = document.getElementById('consensusContent');

        if (!consensus || (!consensus.keywords && !consensus.requirements)) {
            consensusContent.innerHTML = ` <div class="empty-state">ç»§ç»­å¯¹è¯ä»¥ç”Ÿæˆæ›´å¤šåˆ†æå†…å®¹ </div>`;
            return;
        }

        let html = '';

        // å…³é”®è¯éƒ¨åˆ†
        if (consensus.keywords && consensus.keywords.length > 0) {
            html += ` <div class="consensus-section"><div class="section-title">å…³é”®è¯</div><div class="keywords-list">${consensus.keywords.map(keyword => `<span class="keyword-tag" > ${escapeHtml(keyword)
                }

                    </span> `).join('')
                }

            </div></div>`;
        }

        // éœ€æ±‚è¦ç‚¹éƒ¨åˆ†
        if (consensus.requirements && consensus.requirements.length > 0) {
            html += ` <div class="consensus-section"><div class="section-title">éœ€æ±‚è¦ç‚¹</div><ul class="requirements-list">${consensus.requirements.map(req => `<li class="requirement-item" > ${escapeHtml(req)
                }

                    </li > `).join('')
                }

            </ul></div>`;
        }

        // è¿›åº¦æŒ‡ç¤º
        html += ` <div class="consensus-section"><div class="progress-section"><div class="stage-indicator">å½“å‰é˜¶æ®µ: <span class="stage-name">${getStageDisplayName(consensus.stage)
            }

        </span></div></div></div>`;

        consensusContent.innerHTML = html;
    }

    // è·å–é˜¶æ®µæ˜¾ç¤ºåç§°
    function getStageDisplayName(stage) {
        const stageNames = {
            'initial': 'åˆå§‹å¯¹è¯',
            'clarification': 'éœ€æ±‚æ¾„æ¸…',
            'consensus': 'å…±è¯†è¾¾æˆ',
            'documentation': 'æ–‡æ¡£ç”Ÿæˆ'
        }

            ;
        return stageNames[stage] || stage;
    }


    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ================================
    // åˆ†ææˆæœç›¸å…³å‡½æ•°
    // ================================

    /**
     * ä»AIæ¶ˆæ¯ä¸­æå–è¿›å±•æ€»ç»“å†…å®¹
     * @param {string} content - AIæ¶ˆæ¯åŸå§‹å†…å®¹
     * @returns {Object} {hasProgress: boolean, progressContent: string, cleanedContent: string}
     */
    function extractProgressContent(content) {
        // æ”¯æŒå¤šç§æ ‡è®°æ ¼å¼ï¼ŒåŒ…æ‹¬éœ€æ±‚åˆ†æå¸ˆå’Œæµ‹è¯•åˆ†æå¸ˆçš„æ ‡è®°
        const markers = [ // éœ€æ±‚åˆ†æå¸ˆæ ‡è®°

            {
                start: '=== REQUIREMENTS_PROGRESS_START ===', end: '=== REQUIREMENTS_PROGRESS_END ==='
            }

            ,
            {
                start: 'REQUIREMENTS_PROGRESS_START', end: 'REQUIREMENTS_PROGRESS_END'
            }

            ,
            {
                start: '--- REQUIREMENTS_PROGRESS_START ---', end: '--- REQUIREMENTS_PROGRESS_END ---'
            }

            ,
            // æµ‹è¯•åˆ†æå¸ˆæ ‡è®°
            {
                start: '=== TEST_ANALYSIS_PROGRESS_START ===', end: '=== TEST_ANALYSIS_PROGRESS_END ==='
            }

            ,
            {
                start: 'TEST_ANALYSIS_PROGRESS_START', end: 'TEST_ANALYSIS_PROGRESS_END'
            }

            ,
            {
                start: '--- TEST_ANALYSIS_PROGRESS_START ---', end: '--- TEST_ANALYSIS_PROGRESS_END ---'
            }

        ];

        for (const marker of markers) {
            const startIndex = content.indexOf(marker.start);
            const endIndex = content.indexOf(marker.end);

            if (startIndex !== -1 && endIndex !== -1) {
                // æå–è¿›å±•å†…å®¹ï¼ˆå»æ‰æ ‡è®°ï¼‰
                const progressContent = content.substring(startIndex + marker.start.length,
                    endIndex).trim();

                // æ¸…ç†åçš„å¯¹è¯å†…å®¹ï¼ˆç§»é™¤æ•´ä¸ªè¿›å±•å—ï¼‰
                const cleanedContent = content.substring(0, startIndex) + content.substring(endIndex + marker.end.length);

                console.log('æ£€æµ‹åˆ°è¿›å±•å†…å®¹ï¼Œæ ‡è®°æ ¼å¼:', marker.start);
                console.log('æå–çš„è¿›å±•å†…å®¹:', progressContent.substring(0, 200) + '...');

                return {
                    hasProgress: true,
                    progressContent,
                    cleanedContent: cleanedContent.trim()
                }

                    ;
            }
        }

        return {
            hasProgress: false,
            progressContent: '',
            cleanedContent: content
        }

            ;
    }

    /**
     * å°†è¿›å±•å†…å®¹æ¸²æŸ“åˆ°åˆ†ææˆæœåŒºåŸŸ
     * @param {string} progressContent - è¿›å±•æ€»ç»“å†…å®¹ï¼ˆå¯èƒ½æ˜¯markdownæˆ–JSONæ ¼å¼ï¼‰
     */
    function updateAnalysisResults(progressContent) {
        const consensusContent = document.getElementById('consensusContent');

        if (!progressContent) {
            // æ ¹æ®å½“å‰åŠ©æ‰‹ç±»å‹æ˜¾ç¤ºä¸åŒçš„é»˜è®¤æ–‡æœ¬
            let defaultText = 'å¼€å§‹å¯¹è¯åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºåˆ†ææˆæœ';

            if (currentAssistant && currentAssistant.id === 'alex') {
                defaultText = 'å¼€å§‹å¯¹è¯åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºéœ€æ±‚åˆ†æçš„è¦ç‚¹å’Œå…±è¯†å†…å®¹';
            }

            else if (currentAssistant && currentAssistant.id === 'song') {
                defaultText = 'å¼€å§‹å¯¹è¯åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºæµ‹è¯•åˆ†æçš„æˆæœå’Œè¿›å±•å†…å®¹';
            }

            consensusContent.innerHTML = ` <div class="empty-state">${defaultText
                }

            </div>`;
            return;
        }

        let htmlContent = '';

        try {
            // å°è¯•è§£æä¸ºJSONï¼ˆä»…é™éœ€æ±‚åˆ†æå¸ˆï¼‰
            const jsonData = JSON.parse(progressContent);
            htmlContent = formatProgressJSON(jsonData);
            console.log('è§£æéœ€æ±‚åˆ†æJSONæ ¼å¼çš„è¿›å±•å†…å®¹');
        }

        catch (e) {
            // å¦‚æœä¸æ˜¯JSONï¼ˆåŒ…æ‹¬æµ‹è¯•åˆ†æå¸ˆçš„markdownï¼‰ï¼Œåˆ™æŒ‰markdownå¤„ç†
            htmlContent = parseMarkdown(progressContent);
            console.log('è§£æmarkdownæ ¼å¼çš„è¿›å±•å†…å®¹');
        }

        // åº”ç”¨åˆ†ææˆæœä¸“ç”¨çš„CSSç±»
        consensusContent.innerHTML = ` <div class="analysis-results-content">${htmlContent
            }

        </div>`;

        console.log('åˆ†ææˆæœå·²æ›´æ–°');
    }

    /**
     * å°†JSONæ ¼å¼çš„è¿›å±•æ•°æ®è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„HTML
     * @param {Object} jsonData - è¿›å±•æ•°æ®å¯¹è±¡
     * @returns {string} HTMLå†…å®¹
     */
    function formatProgressJSON(jsonData) {
        let html = '';

        // å½“å‰é˜¶æ®µ
        if (jsonData.current_step) {
            html += ` <div class="current-phase"><h2>ğŸ“ å½“å‰é˜¶æ®µ</h2><p><strong>${jsonData.current_step
                }

            </strong></p></div>`;
        }

        // ç”µæ¢¯æ¼”è®²é˜¶æ®µ
        if (jsonData.elevator_pitch) {
            const ep = jsonData.elevator_pitch;
            html += `<div class="consensus-section"><h3>ğŸ¤ ç”µæ¢¯æ¼”è®² - ä»·å€¼å®šä½æ¾„æ¸…</h3>`;

            if (ep.for_target_customer) html += `<p><strong>ç›®æ ‡ç”¨æˆ·ï¼š</strong>${ep.for_target_customer
                }

            </p>`;

            if (ep.who_need_statement) html += `<p><strong>éœ€æ±‚æè¿°ï¼š</strong>${ep.who_need_statement
                }

            </p>`;

            if (ep.product_name) html += `<p><strong>äº§å“åç§°ï¼š</strong>${ep.product_name
                }

            </p>`;

            if (ep.is_a_product_category) html += `<p><strong>äº§å“ç±»åˆ«ï¼š</strong>${ep.is_a_product_category
                }

            </p>`;

            if (ep.that_key_benefit) html += `<p><strong>æ ¸å¿ƒä»·å€¼ï¼š</strong>${ep.that_key_benefit
                }

            </p>`;

            if (ep.unlike_competitor) html += `<p><strong>ç«äº‰ä¼˜åŠ¿ï¼š</strong>${ep.unlike_competitor
                }

            </p>`;

            if (ep.our_product_differentiation) html += `<p><strong>å·®å¼‚åŒ–ï¼š</strong>${ep.our_product_differentiation
                }

            </p>`;

            html += `</div>`;
        }

        // ç”¨æˆ·ç”»åƒé˜¶æ®µ
        if (jsonData.user_personas && jsonData.user_personas.length > 0) {
            html += ` <div class="consensus-section"><h3>ğŸ‘¤ ç”¨æˆ·ç”»åƒ - ç›®æ ‡ç”¨æˆ·åˆ†æ</h3><ul>${jsonData.user_personas.map(persona => `<li > ${persona
                }

                    </li > `).join('')
                }

            </ul></div>`;
        }

        // ç”¨æˆ·æ—…ç¨‹é˜¶æ®µ
        if (jsonData.user_journeys && jsonData.user_journeys.length > 0) {
            html += ` <div class="consensus-section"><h3>ğŸ—ºï¸ ç”¨æˆ·æ—…ç¨‹ - ç—›ç‚¹æŒ–æ˜ä¸æœºä¼šè¯†åˆ«</h3><ul>${jsonData.user_journeys.map(journey => `<li > ${journey
                }

                    </li > `).join('')
                }

            </ul></div>`;
        }

        // BRDé˜¶æ®µ
        if (jsonData.brd) {
            const brd = jsonData.brd;
            html += ` <div class="consensus-section"><h3>ğŸ“‹ ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£</h3>`;

            if (brd.product_name) html += `<p><strong>äº§å“åç§°ï¼š</strong>${brd.product_name
                }

            </p>`;

            if (brd.target_market) html += `<p><strong>ç›®æ ‡å¸‚åœºï¼š</strong>${brd.target_market
                }

            </p>`;

            if (brd.business_model) html += `<p><strong>å•†ä¸šæ¨¡å¼ï¼š</strong>${brd.business_model
                }

            </p>`;

            html += `</div>`;
        }

        // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
        if (!html) {
            html = ` <div class="empty-state">éœ€æ±‚åˆ†ææ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç»§ç»­å¯¹è¯... </div>`;
        }

        return html;
    }

    // å¢å¼ºçš„Markdownè§£æå‡½æ•°ï¼Œç»“åˆmarked.jså’ŒAIåŠ©æ‰‹ç‰¹æ®Šæ ¼å¼
    function parseMarkdown(text) {
        if (!text) return '';

        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨markedåº“
        if (typeof marked === 'undefined') {
            console.warn('marked.jsæœªåŠ è½½ï¼Œä½¿ç”¨ç®€åŒ–è§£æ');
            return parseMarkdownSimple(text);
        }

        // å…ˆå¤„ç†AIåŠ©æ‰‹çš„ç‰¹æ®Šæ ¼å¼ï¼Œå†äº¤ç»™marked.jså¤„ç†æ ‡å‡†markdown
        let processedText = text;

        // 1. é¢„å¤„ç†AIåŠ©æ‰‹ç‰¹æœ‰çš„æ ¼å¼ï¼Œè½¬æ¢ä¸ºæ ‡å‡†markdownæˆ–ä¿ç•™æ ‡è®°
        processedText = processedText // AIåŠ©æ‰‹æ ‡é¢˜æ ¼å¼è½¬ä¸ºæ ‡å‡†markdownæ ‡é¢˜
            .replace(/^===(.*?)===/gm, '### $1') // AIåŠ©æ‰‹å‘½ä»¤é¡¹è½¬ä¸ºä»£ç å—+æè¿°
            .replace(/^(\d+)\.\s+`([^`]+)`\s*$/gm, '$1. `$2`') // å¸¦æè¿°çš„å‘½ä»¤é¡¹
            .replace(/^(\d+)\.\s+`([^`]+)`\s*\*\s*\*\*(.*?)\*\*[ï¼š:]\s*(.*?)$/gm,
                '$1. `$2`\n   **$3ï¼š** $4') // åŠŸèƒ½æè¿°é¡¹ä¿æŒmarkdownæ ¼å¼
            .replace(/^\*\s+\*\*(.*?)\*\*[ï¼š:]\s*(.*?)$/gm, '* **$1ï¼š** $2');

        // 2. ä½¿ç”¨marked.jsè§£ææ ‡å‡†markdown
        try {

            // é…ç½®markedé€‰é¡¹
            marked.setOptions({
                breaks: true, // æ”¯æŒæ¢è¡Œ
                gfm: true, // å¯ç”¨GitHub Flavored Markdown
                sanitize: false, // ä¸æ¸…ç†HTMLï¼Œæˆ‘ä»¬ç”¨DOMPurify
                silent: false // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
            });

            let html = marked.parse(processedText);

            // 3. åº”ç”¨AIåŠ©æ‰‹ç‰¹å®šçš„CSSç±»
            html = html.replace(/<h3>/g, '<h3 class="ai-title">').replace(/<h4>/g, '<h4 class="ai-subtitle">').replace(/<code>/g, '<code class="inline-code">').replace(/<p>/g, '<p class="ai-paragraph">').replace(/<li>/g, '<li class="ai-list-item">');

            // 4. ä½¿ç”¨DOMPurifyæ¸…ç†HTMLï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (typeof DOMPurify !== 'undefined') {
                html = DOMPurify.sanitize(html, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'code', 'pre', 'ul', 'ol', 'li', 'blockquote', 'a', 'del', 'hr', 'table', 'thead', 'tbody', 'tr', 'td', 'th'],
                    ALLOWED_ATTR: ['href', 'title', 'class']
                });
            }

            return html;

        }

        catch (error) {
            console.error('marked.jsè§£æå¤±è´¥:', error);
            return parseMarkdownSimple(text);
        }
    }

    // ç®€åŒ–çš„markdownè§£æå™¨ï¼ˆå¤‡ç”¨ï¼‰
    function parseMarkdownSimple(text) {
        if (!text) return '';

        let html = escapeHtml(text);

        // åŸºç¡€markdownè¯­æ³•æ”¯æŒ
        html = html // æ ‡é¢˜
            .replace(/^### (.*?)$/gm, '<h3 class="ai-title">$1</h3>').replace(/^## (.*?)$/gm, '<h2>$1</h2>').replace(/^# (.*?)$/gm, '<h1>$1</h1>') // AIåŠ©æ‰‹ç‰¹æ®Šæ ¼å¼
            .replace(/^===(.*?)===/gm, '<h3 class="ai-title">$1</h3>').replace(/^(\d+)\.\s+`([^`]+)`\s*$/gm, '<div class="ai-command-item"><span class="ai-command-num">$1.</span><code class="ai-command">$2</code></div>') // åˆ—è¡¨
            .replace(/^\*\s+(.*)$/gm, '<div class="ai-list-item">â€¢ $1</div>').replace(/^-\s+(.*)$/gm, '<div class="ai-list-item">â€¢ $1</div>').replace(/^(\d+)\.\s+(.*)$/gm, '<div class="ai-list-item">$1. $2</div>') // æ ¼å¼åŒ–
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>').replace(/~~(.*?)~~/g, '<del>$1</del>') // æ®µè½å’Œæ¢è¡Œ
            .replace(/\n\n/g, '</p><p class="ai-paragraph">').replace(/\n/g, '<br>');

        // åŒ…è£…æ®µè½
        if (html && !html.startsWith('<')) {
            html = '<p class="ai-paragraph">' + html + '</p>';
        }

        return html;
    }

    // ================================
    // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å‡½æ•°
    // ================================

    // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
    function initializeFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const messageInput = document.getElementById('messageInput');
        const dragOverlay = document.getElementById('dragOverlay');

        if (!fileInput || !messageInput) {
            console.warn('æ–‡ä»¶ä¸Šä¼ åˆå§‹åŒ–å¤±è´¥ï¼šæ‰¾ä¸åˆ°å¿…è¦å…ƒç´ ');
            return;
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', handleFileSelect);

        // æ‹–æ‹½ä¸Šä¼ äº‹ä»¶
        messageInput.addEventListener('dragenter', handleDragEnter);
        messageInput.addEventListener('dragover', handleDragOver);
        messageInput.addEventListener('dragleave', handleDragLeave);
        messageInput.addEventListener('drop', handleFileDrop);

        console.log('âœ… æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    }

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        processFiles(files);
        e.target.value = ''; // æ¸…ç©ºä»¥å…è®¸é‡å¤é€‰æ‹©
    }

    let dragCounter = 0;

    function handleDragEnter(e) {
        e.preventDefault();
        dragCounter++;
        showDragOverlay();
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    }

    function handleDragLeave(e) {
        e.preventDefault();
        dragCounter--;

        if (dragCounter === 0) {
            hideDragOverlay();
        }
    }

    function handleFileDrop(e) {
        e.preventDefault();
        dragCounter = 0;
        hideDragOverlay();

        const files = Array.from(e.dataTransfer.files);
        processFiles(files);
    }

    function showDragOverlay() {
        const dragOverlay = document.getElementById('dragOverlay');
        const messageInput = document.getElementById('messageInput');

        if (dragOverlay) {
            dragOverlay.classList.add('active');
        }

        if (messageInput) {
            messageInput.classList.add('drag-over');
        }
    }

    function hideDragOverlay() {
        const dragOverlay = document.getElementById('dragOverlay');
        const messageInput = document.getElementById('messageInput');

        if (dragOverlay) {
            dragOverlay.classList.remove('active');
        }

        if (messageInput) {
            messageInput.classList.remove('drag-over');
        }
    }

    function processFiles(files) {
        for (const file of files) {
            // éªŒè¯æ–‡ä»¶æ ¼å¼
            const ext = '.' + file.name.split('.').pop().toLowerCase();

            if (!ext.match(/\.(txt|md)$/)) {
                showMessage(`æ–‡ä»¶ ${file.name
                    }

                    æ ¼å¼ä¸æ”¯æŒï¼Œä»…æ”¯æŒ txt å’Œ md æ–‡ä»¶`, 'error');
                continue;
            }

            // éªŒè¯æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                showMessage(`æ–‡ä»¶ ${file.name
                    }

                    è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ 10MB`, 'error');
                continue;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (attachedFiles.some(f => f.name === file.name && f.size === file.size)) {
                showMessage(`æ–‡ä»¶ ${file.name
                    }

                    å·²å­˜åœ¨`, 'warning');
                continue;
            }

            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();

            reader.onload = (e) => {
                const fileInfo = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    content: e.target.result
                }

                    ;

                attachedFiles.push(fileInfo);
                updateAttachmentPreview();
                updateSendButtonState(); // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€

                showMessage(`æ–‡ä»¶ ${file.name
                    }

                    ä¸Šä¼ æˆåŠŸ`, 'success');
            }

                ;

            reader.onerror = () => {
                showMessage(`è¯»å–æ–‡ä»¶ ${file.name
                    }

                    å¤±è´¥`, 'error');
            }

                ;

            reader.readAsText(file, 'utf-8');
        }
    }

    function updateAttachmentPreview() {
        const preview = document.getElementById('attachmentPreview');
        const list = document.getElementById('attachmentList');

        if (!preview || !list) {
            console.warn('æ‰¾ä¸åˆ°é™„ä»¶é¢„è§ˆå…ƒç´ ');
            return;
        }

        if (attachedFiles.length === 0) {
            preview.style.display = 'none';
            return;
        }

        preview.style.display = 'block';

        list.innerHTML = attachedFiles.map(file => ` <div class="attachment-item" data-file-id="${file.id}" > <div class="attachment-icon" >${file.name.toLowerCase().endsWith('.md') ? 'MD' : 'TXT'
            }

            </div> <div class="attachment-info" > <div class="attachment-name" >${escapeHtml(file.name)
            }

            </div> <div class="attachment-size" >${formatFileSize(file.size)
            }

            </div> </div> <button onclick="removeAttachment(${file.id})" class="remove-attachment" >Ã—</button> </div> `).join('');
    }

    function removeAttachment(fileId) {
        console.log('åˆ é™¤é™„ä»¶:', fileId, 'å½“å‰é™„ä»¶:', attachedFiles.map(f => f.id));
        attachedFiles = attachedFiles.filter(file => file.id.toString() !== fileId.toString());
        updateAttachmentPreview();
        updateSendButtonState(); // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        console.log('åˆ é™¤åå‰©ä½™é™„ä»¶:', attachedFiles.length);
    }

    function clearAllAttachments() {
        attachedFiles = [];
        updateAttachmentPreview();
        updateSendButtonState(); // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B',
            'KB',
            'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function showMessage(message, type) {
        const messageEl = document.createElement('div');
        messageEl.className = 'message ' + type;
        messageEl.textContent = message;
        messageEl.style.cssText = ` position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        z-index: 1001;

        background-color: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#dc3545'
            }

        ;

        border: 1px solid ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#dc3545'
            }

        ;
        `;

        document.body.appendChild(messageEl);

        setTimeout(() => {
            if (document.body.contains(messageEl)) {
                document.body.removeChild(messageEl);
            }
        }

            , 3000);
    }

</script>

{% endblock %}