{% extends "base_layout.html" %}

{% block title %}AIé…ç½®ç®¡ç† - AI4SEå·¥å…·é›†{% endblock %}
{% block page_title %}AIé…ç½®ç®¡ç†{% endblock %}
{% block page_subtitle %}ç®¡ç†ä½ çš„AIåŠ©æ‰‹è¿æ¥é…ç½®{% endblock %}

{% block extra_css %}
<style>
    /* é…ç½®ç®¡ç†æ ·å¼ */
    .config-management-layout {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    /* Cardæ ·å¼ */
    .card {
        background: #ffffff;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        margin-bottom: 24px;
    }

    .card-title {
        font-size: 16px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 4px;
    }

    .card-subtitle {
        font-size: 14px;
        color: #666666;
        margin-bottom: 20px;
    }

    .card-content {
        padding: 20px;
    }

    /* é…ç½®ç®¡ç†éƒ¨åˆ†æ ·å¼ */
    .config-management-section {
        margin-top: 0;
        border-top: 1px solid #e8e8e8;
        padding-top: 24px;
    }

    .config-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #e8e8e8;
    }

    .config-actions {
        display: flex;
        gap: 12px;
    }

    .config-section-title {
        font-size: 16px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .config-stats {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .config-stat-item {
        background: #f8f9fa;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 13px;
        color: #666666;
    }

    .config-stat-number {
        font-weight: 500;
        color: #333333;
    }

    .configs-list {
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        background: #ffffff;
        margin-bottom: 16px;
        max-height: 500px;
        overflow-y: auto;
    }

    .config-item {
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.2s ease;
    }

    .config-item:last-child {
        border-bottom: none;
    }

    .config-item:hover {
        background: #f8f9fa;
    }

    .config-item.active {
        background: #f0f8ff;
        border-left: 3px solid #333333;
    }

    .config-info {
        flex: 1;
    }

    .config-name {
        font-size: 14px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .config-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .config-badge.active {
        background: #e8f4fd;
        color: #1c5aa0;
    }

    .config-details {
        font-size: 12px;
        color: #666666;
        line-height: 1.4;
    }

    .config-model {
        color: #333333;
        font-weight: 500;
    }

    .config-actions-row {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .config-action-btn {
        padding: 6px 12px;
        border: 1px solid #e8e8e8;
        background: #ffffff;
        color: #666666;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        min-width: 60px;
        box-sizing: border-box;
    }

    .config-action-btn:hover {
        background: #f8f8f8;
        border-color: #d0d0d0;
        color: #333333;
    }

    .config-action-btn.primary {
        background: #333333;
        color: #ffffff;
        border-color: #333333;
    }

    .config-action-btn.primary:hover {
        background: #555555;
        border-color: #555555;
    }

    .config-action-btn.danger {
        color: #dc3545;
        border-color: #dc3545;
    }

    .config-action-btn.danger:hover {
        background: #dc3545;
        color: #ffffff;
    }

    .config-action-btn.current {
        background: #e8f4fd;
        color: #1c5aa0;
        border-color: #e8f4fd;
        cursor: default;
        font-weight: 500;
    }

    .config-action-btn.current:hover {
        background: #e8f4fd;
        color: #1c5aa0;
        border-color: #e8f4fd;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666666;
    }

    .empty-state-icon {
        font-size: 48px;
        color: #e8e8e8;
        margin-bottom: 16px;
    }

    .empty-state-title {
        font-size: 16px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 8px;
    }

    .empty-state-desc {
        font-size: 14px;
        color: #666666;
        margin-bottom: 20px;
    }

    .config-management-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .bulk-actions {
        display: flex;
        gap: 8px;
    }

    /* æµ‹è¯•çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .test-status {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        margin-top: 4px;
    }

    .test-status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .test-status.success .test-status-dot {
        background: #28a745;
    }

    .test-status.error .test-status-dot {
        background: #dc3545;
    }

    .test-status.pending .test-status-dot {
        background: #ffc107;
    }

    .test-status.unknown .test-status-dot {
        background: #6c757d;
    }

    /* è¡¨å•æ ·å¼ */
    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #333333;
        margin-bottom: 6px;
    }

    .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        font-size: 14px;
        line-height: 1.4;
        transition: border-color 0.2s ease;
        box-sizing: border-box;
    }

    .form-input:focus {
        outline: none;
        border-color: #333333;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .btn {
        padding: 10px 16px;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        background: #ffffff;
        color: #666666;
    }

    .btn:hover {
        background: #f8f8f8;
        border-color: #d0d0d0;
        color: #333333;
    }

    .btn-ghost {
        background: transparent;
        border: 1px solid #e8e8e8;
        color: #666666;
    }

    .btn-ghost:hover {
        background: #f8f8f8;
        border-color: #d0d0d0;
        color: #333333;
    }

    .btn-primary {
        background: #333333;
        border-color: #333333;
        color: #ffffff;
    }

    .btn-primary:hover {
        background: #555555;
        border-color: #555555;
        color: #ffffff;
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .config-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .config-actions-row {
            width: 100%;
            justify-content: flex-end;
        }

        .config-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }
    }
</style>
{% endblock %}

{% block content %}

<div class="config-management-layout"><!-- AIé…ç½®è¡¨å• -->
    <div class="card">
        <div class="card-title">AIæœåŠ¡é…ç½®</div>
        <div class="card-subtitle">é…ç½®ä½ çš„AIåŠ©æ‰‹è¿æ¥è®¾ç½®</div>
        <div class="card-content">
            <form id="aiConfigForm">
                <div class="form-group"><label class="form-label">é…ç½®åç§°</label><input type="text" class="form-input"
                        id="configName" name="config_name" placeholder="ç»™ä½ çš„AIé…ç½®èµ·ä¸ªåå­—ï¼Œå¦‚ï¼šæˆ‘çš„OpenAIé…ç½®" required></div>
                <div class="form-grid">
                    <div class="form-group"><label class="form-label">APIå¯†é’¥</label><input type="password"
                            class="form-input" id="apiKey" name="api_key" placeholder="è¾“å…¥ä½ çš„APIå¯†é’¥" required></div>
                    <div class="form-group"><label class="form-label">æ¨¡å‹åç§°</label><input type="text" class="form-input"
                            id="modelName" name="model_name" placeholder="å¦‚: gpt-4o, qwen-vl-max-latest" required></div>
                </div>
                <div class="form-group"><label class="form-label">APIåŸºç¡€URL</label><input type="url" class="form-input"
                        id="baseUrl" name="base_url" placeholder="å¦‚: https://api.openai.com/v1" required></div>
                <div class="form-actions"><button type="button" class="btn btn-ghost"
                        onclick="clearForm()">æ¸…ç©º</button><button type="button" class="btn"
                        onclick="testAiConfig()">æµ‹è¯•è¿æ¥</button><button type="submit"
                        class="btn btn-primary">ä¿å­˜é…ç½®</button></div>
            </form>
        </div>
    </div><!-- é…ç½®ç®¡ç†éƒ¨åˆ† -->
    <div class="config-management-section">
        <div class="config-section-title"><span>âš™ï¸</span>é…ç½®ç®¡ç† </div><!-- é…ç½®ç»Ÿè®¡ -->
        <div class="config-stats">
            <div class="config-stat-item">æ€»é…ç½®: <span class="config-stat-number" id="totalConfigs">0</span></div>
            <div class="config-stat-item">å·²é€‰ç”¨: <span class="config-stat-number" id="selectedConfigs">0</span></div>
            <div class="config-stat-item">å½“å‰ä½¿ç”¨: <span class="config-stat-number" id="currentConfigName">æ— </span></div>
        </div><!-- é…ç½®åˆ—è¡¨ -->
        <div class="configs-list" id="configsList"><!-- é…ç½®é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            <div class="empty-state" id="emptyState">
                <div class="empty-state-icon">âš™ï¸</div>
                <div class="empty-state-title">æš‚æ— AIé…ç½®</div>
                <div class="empty-state-desc">åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªAIé…ç½®æ¥å¼€å§‹ä½¿ç”¨æ™ºèƒ½åŠŸèƒ½</div>
            </div>
        </div><!-- æ‰¹é‡æ“ä½œ -->
        <div class="config-management-actions">
            <div class="bulk-actions"><button class="btn" onclick="testAllConfigs()">æ‰¹é‡æµ‹è¯•</button></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥axios.jsç”¨äºAPIè°ƒç”¨ -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    // ===== é…ç½®ç®¡ç†åŠŸèƒ½ =====

    // åˆå§‹åŒ–é…ç½®ç®¡ç†
    async function initializeConfigManagement() {
        await loadConfigList();
        await updateConfigStats();
    }

    // åŠ è½½é…ç½®åˆ—è¡¨
    async function loadConfigList() {
        try {
            const response = await axios.get('/api/ai-configs');
            if (response.data.code === 200) {
                const configs = response.data.data.configs;
                renderConfigList(configs);
            } else {
                console.error('åŠ è½½é…ç½®åˆ—è¡¨å¤±è´¥:', response.data.message);
            }
        } catch (error) {
            console.error('åŠ è½½é…ç½®åˆ—è¡¨å¤±è´¥:', error);
            renderEmptyState();
        }
    }

    // æ¸²æŸ“é…ç½®åˆ—è¡¨
    function renderConfigList(configs) {
        const configsList = document.getElementById('configsList');
        let emptyState = document.getElementById('emptyState');

        if (configs.length === 0) {
            renderEmptyState();
            return;
        }

        // éšè—æˆ–ç§»é™¤ç©ºçŠ¶æ€
        if (emptyState) {
            emptyState.style.display = 'none';
        }

        // æ¸…é™¤ç°æœ‰å†…å®¹ï¼ˆä½†ä¿ç•™emptyStateå…ƒç´ ï¼‰
        const existingItems = configsList.querySelectorAll('.config-item');
        existingItems.forEach(item => item.remove());

        configs.forEach(config => {
            const configItem = createConfigItem(config);
            configsList.appendChild(configItem);
        });
    }

    // åˆ›å»ºé…ç½®é¡¹DOMå…ƒç´ 
    function createConfigItem(config) {
        const div = document.createElement('div');
        div.className = `config-item ${config.is_default ? 'active' : ''}`;

        const formatDate = (dateStr) => {
            if (!dateStr) return 'æœªçŸ¥';
            try {
                return new Date(dateStr).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return 'æœªçŸ¥';
            }
        };

        div.innerHTML = `<div class="config-info">
            <div class="config-name">
                ${escapeHtml(config.config_name)}
                ${config.is_default ? '<span class="config-badge active">ä½¿ç”¨ä¸­</span>' : ''}
            </div>
            <div class="config-details">
                æ¨¡å‹: <span class="config-model">${escapeHtml(config.model_name)}</span>
                â€¢ API: ${escapeHtml(new URL(config.base_url).hostname)}
                â€¢ åˆ›å»ºæ—¶é—´: ${formatDate(config.created_at)}
            </div>
            <div class="test-status unknown" id="test-status-${config.id}">
                <span class="test-status-dot"></span>è¿æ¥çŠ¶æ€æœªçŸ¥
            </div>
        </div>
        <div class="config-actions-row">
            <button class="config-action-btn" onclick="editConfig(${config.id})">ç¼–è¾‘</button>
            <button class="config-action-btn" onclick="testSingleConfig(${config.id})">æµ‹è¯•</button>
            ${config.is_default ?
                '<span class="config-action-btn current">ä½¿ç”¨ä¸­</span>' :
                `<button class="config-action-btn primary" onclick="selectConfig(${config.id})">é€‰ç”¨</button>`
            }
            <button class="config-action-btn danger" onclick="deleteConfig(${config.id})">åˆ é™¤</button>
        </div>`;

        return div;
    }

    // æ¸²æŸ“ç©ºçŠ¶æ€
    function renderEmptyState() {
        const configsList = document.getElementById('configsList');
        let emptyState = document.getElementById('emptyState');

        // å¦‚æœemptyStateä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
        if (!emptyState) {
            emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.id = 'emptyState';
            emptyState.innerHTML = `<div class="empty-state-icon">âš™ï¸</div>
                <div class="empty-state-title">æš‚æ— AIé…ç½®</div>
                <div class="empty-state-desc">åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªAIé…ç½®æ¥å¼€å§‹ä½¿ç”¨æ™ºèƒ½åŠŸèƒ½</div>`;
        }

        // æ¸…é™¤ç°æœ‰çš„é…ç½®é¡¹
        const existingItems = configsList.querySelectorAll('.config-item');
        existingItems.forEach(item => item.remove());

        // æ˜¾ç¤ºç©ºçŠ¶æ€
        if (!configsList.contains(emptyState)) {
            configsList.appendChild(emptyState);
        }
        emptyState.style.display = 'block';
    }

    // æ›´æ–°é…ç½®ç»Ÿè®¡ä¿¡æ¯
    async function updateConfigStats() {
        try {
            const response = await axios.get('/api/ai-configs/stats');
            if (response.data.code === 200) {
                const stats = response.data.data;
                document.getElementById('totalConfigs').textContent = stats.total_configs;
                document.getElementById('selectedConfigs').textContent = stats.selected_configs;
                document.getElementById('currentConfigName').textContent = stats.current_config_name;
            }
        } catch (error) {
            console.error('æ›´æ–°é…ç½®ç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    // é€‰ç”¨é…ç½®
    async function selectConfig(configId) {
        try {
            const response = await axios.post(`/api/ai-configs/${configId}/set-default`);
            if (response.data.code === 200) {
                showMessage('é…ç½®é€‰ç”¨æˆåŠŸ', 'success');
                // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨å’Œç»Ÿè®¡ä¿¡æ¯
                await loadConfigList();
                await updateConfigStats();
                // é€šçŸ¥å…¶ä»–é¡µé¢é…ç½®å·²æ›´æ”¹
                notifyConfigChange();
            } else {
                showMessage('é€‰ç”¨å¤±è´¥: ' + response.data.message, 'error');
            }
        } catch (error) {
            console.error('é€‰ç”¨é…ç½®å¤±è´¥:', error);
            showMessage('é€‰ç”¨å¤±è´¥: ' + (error.response?.data?.message || error.message), 'error');
        }
    }

    // åˆ é™¤é…ç½®
    async function deleteConfig(configId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
            return;
        }

        try {
            const response = await axios.delete(`/api/ai-configs/${configId}`);
            if (response.data.code === 200) {
                showMessage('é…ç½®åˆ é™¤æˆåŠŸ', 'success');
                // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨å’Œç»Ÿè®¡ä¿¡æ¯
                await loadConfigList();
                await updateConfigStats();
                // é€šçŸ¥å…¶ä»–é¡µé¢é…ç½®å·²æ›´æ”¹
                notifyConfigChange();
            } else {
                showMessage('åˆ é™¤å¤±è´¥: ' + response.data.message, 'error');
            }
        } catch (error) {
            console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
            showMessage('åˆ é™¤å¤±è´¥: ' + (error.response?.data?.message || error.message), 'error');
        }
    }

    // ç¼–è¾‘é…ç½®
    async function editConfig(configId) {
        try {
            // è·å–é…ç½®è¯¦æƒ…
            const response = await axios.get('/api/ai-configs');
            if (response.data.code === 200) {
                const configs = response.data.data.configs;
                const config = configs.find(c => c.id === configId);
                if (config) {
                    setEditMode(config);
                    showMessage('å·²åŠ è½½é…ç½®åˆ°ç¼–è¾‘è¡¨å•ï¼Œä¿®æ”¹åç‚¹å‡»ä¿å­˜', 'success');
                    // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
                    document.querySelector('.card').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        } catch (error) {
            console.error('åŠ è½½é…ç½®è¯¦æƒ…å¤±è´¥:', error);
            showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + (error.response?.data?.message || error.message), 'error');
        }
    }

    // æµ‹è¯•å•ä¸ªé…ç½®
    async function testSingleConfig(configId) {
        const statusEl = document.getElementById(`test-status-${configId}`);
        if (statusEl) {
            statusEl.className = 'test-status pending';
            statusEl.innerHTML = '<span class="test-status-dot"></span>æµ‹è¯•ä¸­...';
        }

        try {
            const response = await axios.post(`/api/ai-configs/${configId}/test`);
            if (response.data.code === 200) {
                const testData = response.data.data;
                if (testData.test_success) {
                    if (statusEl) {
                        statusEl.className = 'test-status success';
                        statusEl.innerHTML = '<span class="test-status-dot"></span>è¿æ¥æ­£å¸¸';
                    }
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å’ŒAIå›å¤
                    const successMessage = `âœ… ${testData.config_name} æµ‹è¯•æˆåŠŸï¼\n\n` +
                        `ğŸ“± æ¨¡å‹: ${testData.model_name}\n` +
                        `â±ï¸ å“åº”æ—¶é—´: ${testData.duration_ms} ms\n` +
                        `ğŸ¤– AIå›å¤: ${testData.ai_response}`;
                    showMessage(successMessage, 'success');
                } else {
                    if (statusEl) {
                        statusEl.className = 'test-status error';
                        statusEl.innerHTML = '<span class="test-status-dot"></span>æµ‹è¯•å¤±è´¥';
                    }
                    showMessage(`âŒ ${testData.config_name} æµ‹è¯•å¤±è´¥\n\n${response.data.message}`, 'error');
                }
            } else {
                if (statusEl) {
                    statusEl.className = 'test-status error';
                    statusEl.innerHTML = '<span class="test-status-dot"></span>æµ‹è¯•å¤±è´¥';
                }
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                let errorMessage = `âŒ æµ‹è¯•å¤±è´¥: ${response.data.message}`;
                // å¦‚æœæœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œæ˜¾ç¤ºå‡ºæ¥
                if (response.data.data && response.data.data.error_details) {
                    const details = response.data.data.error_details;
                    errorMessage += `\n\nğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯: \n`;
                    errorMessage += `é…ç½®: ${details.config_name} (${details.model_name})\n`;
                    errorMessage += `æ¥å£: ${details.base_url}\n`;
                    errorMessage += `é”™è¯¯ç±»å‹: ${details.error_type}\n`;
                    errorMessage += `é”™è¯¯ä¿¡æ¯: ${details.error_message}\n`;
                    if (details.error_traceback) {
                        errorMessage += `\nğŸ“‹ é”™è¯¯å †æ ˆ:\n${details.error_traceback}`;
                    }
                }
                showMessage(errorMessage, 'error');
            }
        } catch (error) {
            console.error('æµ‹è¯•é…ç½®å¤±è´¥:', error);
            if (statusEl) {
                statusEl.className = 'test-status error';
                statusEl.innerHTML = '<span class="test-status-dot"></span>è¿æ¥å¤±è´¥';
            }
            // æ˜¾ç¤ºå®Œæ•´çš„é”™è¯¯ä¿¡æ¯
            let errorMessage = `âŒ ç½‘ç»œæˆ–ç³»ç»Ÿé”™è¯¯: ${error.message}`;
            if (error.response && error.response.data) {
                errorMessage += `\n\nğŸŒ æœåŠ¡å™¨å“åº”:\n${JSON.stringify(error.response.data, null, 2)}`;
            }
            showMessage(errorMessage, 'error');
        }
    }

    // æ‰¹é‡æµ‹è¯•æ‰€æœ‰é…ç½®
    async function testAllConfigs() {
        try {
            const batchButton = document.querySelector('button[onclick="testAllConfigs()"]');
            const originalText = batchButton.textContent;
            batchButton.textContent = 'æ‰¹é‡æµ‹è¯•ä¸­...';
            batchButton.disabled = true;

            // é‡ç½®æ‰€æœ‰çŠ¶æ€ä¸ºæµ‹è¯•ä¸­
            document.querySelectorAll('[id^="test-status-"]').forEach(statusEl => {
                statusEl.className = 'test-status pending';
                statusEl.innerHTML = '<span class="test-status-dot"></span>æµ‹è¯•ä¸­...';
            });

            showMessage('ğŸš€ å¼€å§‹æ‰¹é‡æµ‹è¯•ï¼Œè¯·ç¨å€™...', 'info');
            const response = await axios.post('/api/ai-configs/test-all');
            if (response.data.code === 200) {
                const results = response.data.data;
                const summary = results.summary;

                // æ›´æ–°æ¯ä¸ªé…ç½®çš„æµ‹è¯•çŠ¶æ€
                results.test_results.forEach(result => {
                    const statusEl = document.getElementById(`test-status-${result.config_id}`);
                    if (statusEl) {
                        statusEl.className = `test-status ${result.test_success ? 'success' : 'error'}`;
                        const statusText = result.test_success ? 'è¿æ¥æ­£å¸¸' : 'è¿æ¥å¤±è´¥';
                        const duration = result.duration_ms ? ` (${result.duration_ms} ms)` : '';
                        statusEl.innerHTML = `<span class="test-status-dot"></span>${statusText}${duration}`;
                    }
                });

                // å‡†å¤‡è¯¦ç»†ç»“æœä¿¡æ¯
                let resultDetails = [];
                results.test_results.forEach(result => {
                    if (result.test_success) {
                        resultDetails.push(`âœ… ${result.config_name} (${result.model_name}): ${result.ai_response} [${result.duration_ms} ms]`);
                    } else {
                        let errorInfo = `âŒ ${result.config_name} (${result.model_name}): ${result.message}`;
                        if (result.error_details) {
                            errorInfo += `\n é”™è¯¯ç±»å‹: ${result.error_details.error_type}`;
                            errorInfo += `\n é”™è¯¯è¯¦æƒ…: ${result.error_details.error_message}`;
                        }
                        resultDetails.push(errorInfo);
                    }
                });

                // æ˜¾ç¤ºæ‰¹é‡æµ‹è¯•ç»“æœ
                let batchMessage = `ğŸ¯ æ‰¹é‡æµ‹è¯•å®Œæˆï¼\n\n` +
                    `ğŸ“Š æµ‹è¯•ç»Ÿè®¡:\n` +
                    `â€¢ æ€»é…ç½®æ•°: ${summary.total}\n` +
                    `â€¢ æˆåŠŸè¿æ¥: ${summary.success}\n` +
                    `â€¢ è¿æ¥å¤±è´¥: ${summary.failed}\n` +
                    `â€¢ æ€»è€—æ—¶: ${summary.total_duration_ms} ms\n\n`;

                if (summary.success > 0) {
                    batchMessage += `ğŸ“‹ æµ‹è¯•ç»“æœ:\n${resultDetails.join('\n')}`;
                }

                const messageType = summary.success === summary.total ? 'success' : summary.success > 0 ? 'warning' : 'error';
                showMessage(batchMessage, messageType);
            } else {
                showMessage('æ‰¹é‡æµ‹è¯•å¤±è´¥: ' + response.data.message, 'error');
            }
        } catch (error) {
            console.error('æ‰¹é‡æµ‹è¯•å¤±è´¥:', error);
            let errorMessage = `âŒ æ‰¹é‡æµ‹è¯•ç³»ç»Ÿé”™è¯¯: ${error.message}`;
            if (error.response && error.response.data) {
                errorMessage += `\n\nğŸŒ æœåŠ¡å™¨å“åº”:\n${JSON.stringify(error.response.data, null, 2)}`;
            }
            showMessage(errorMessage, 'error');
        } finally {
            // æ¢å¤æ‰¹é‡æµ‹è¯•æŒ‰é’®çŠ¶æ€
            const batchButton = document.querySelector('button[onclick="testAllConfigs()"]');
            if (batchButton) {
                batchButton.textContent = 'æ‰¹é‡æµ‹è¯•';
                batchButton.disabled = false;
            }
        }
    }

    // æ¸…ç©ºè¡¨å•
    function clearForm() {
        document.getElementById('configName').value = '';
        document.getElementById('apiKey').value = '';
        document.getElementById('baseUrl').value = '';
        document.getElementById('modelName').value = '';
        document.getElementById('apiKey').placeholder = 'è¾“å…¥ä½ çš„APIå¯†é’¥';
        document.getElementById('apiKey').required = true;

        // æ¸…é™¤ç¼–è¾‘æ¨¡å¼æ ‡è¯†
        const form = document.getElementById('aiConfigForm');
        form.removeAttribute('data-edit-mode');
        form.removeAttribute('data-edit-id');
        showMessage('è¡¨å•å·²æ¸…ç©º', 'success');
    }

    // è®¾ç½®ç¼–è¾‘æ¨¡å¼
    function setEditMode(config) {
        // å¡«å……è¡¨å•
        document.getElementById('configName').value = config.config_name;
        document.getElementById('baseUrl').value = config.base_url;
        document.getElementById('modelName').value = config.model_name;
        // APIå¯†é’¥ä¸å¡«å……ï¼Œéœ€è¦ç”¨æˆ·é‡æ–°è¾“å…¥
        document.getElementById('apiKey').value = '';
        document.getElementById('apiKey').placeholder = 'ä¿æŒç©ºç™½åˆ™ä¸ä¿®æ”¹APIå¯†é’¥';
        document.getElementById('apiKey').required = false;

        // è®¾ç½®ç¼–è¾‘æ¨¡å¼æ ‡è¯†
        document.getElementById('aiConfigForm').dataset.editMode = 'true';
        document.getElementById('aiConfigForm').dataset.editId = config.id;
    }

    async function testAiConfig() {
        const configName = document.getElementById('configName').value;
        const apiKey = document.getElementById('apiKey').value;
        const baseUrl = document.getElementById('baseUrl').value;
        const modelName = document.getElementById('modelName').value;

        if (!configName || !apiKey || !baseUrl || !modelName) {
            showMessage('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
            return;
        }

        // åŸºç¡€æ ¼å¼éªŒè¯
        try {
            new URL(baseUrl);
        } catch (e) {
            showMessage('APIåŸºç¡€URLæ ¼å¼ä¸æ­£ç¡®', 'error');
            return;
        }

        // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
        const testButton = document.querySelector('button[onclick="testAiConfig()"]');
        const originalText = testButton.textContent;
        testButton.textContent = 'æµ‹è¯•ä¸­...';
        testButton.disabled = true;

        try {
            const response = await axios.post('/api/ai-configs/test-preview', {
                config_name: configName,
                api_key: apiKey,
                base_url: baseUrl,
                model_name: modelName
            });

            if (response.data.code === 200) {
                const testData = response.data.data;
                if (testData.test_success) {
                    showMessage(`âœ… é¢„è§ˆæµ‹è¯•æˆåŠŸï¼\n\n` +
                        `ğŸ“± é…ç½®: ${testData.config_name}\n` +
                        `ğŸ¤– æ¨¡å‹: ${testData.model_name}\n` +
                        `â±ï¸ å“åº”æ—¶é—´: ${testData.duration_ms} ms\n` +
                        `ğŸ’¬ AIå›å¤: ${testData.ai_response}`,
                        'success'
                    );
                } else {
                    showMessage(`âš ï¸ é¢„è§ˆæµ‹è¯•å¤±è´¥\n\n${response.data.message}`, 'error');
                }
            } else {
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                let errorMessage = `âŒ é¢„è§ˆæµ‹è¯•å¤±è´¥: ${response.data.message}`;
                // å¦‚æœæœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œæ˜¾ç¤ºå‡ºæ¥
                if (response.data.data && response.data.data.error_details) {
                    const details = response.data.data.error_details;
                    errorMessage += `\n\nğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯: \n`;
                    errorMessage += `é…ç½®: ${details.config_name} (${details.model_name})\n`;
                    errorMessage += `æ¥å£: ${details.base_url}\n`;
                    errorMessage += `é”™è¯¯ç±»å‹: ${details.error_type}\n`;
                    errorMessage += `é”™è¯¯ä¿¡æ¯: ${details.error_message}\n`;
                    if (details.error_traceback) {
                        errorMessage += `\nğŸ“‹ é”™è¯¯å †æ ˆ:\n${details.error_traceback}`;
                    }
                }
                showMessage(errorMessage, 'error');
            }
        } catch (error) {
            console.error('é¢„è§ˆæµ‹è¯•å¤±è´¥:', error);
            // æ˜¾ç¤ºå®Œæ•´çš„é”™è¯¯ä¿¡æ¯
            let errorMessage = `âŒ ç½‘ç»œæˆ–ç³»ç»Ÿé”™è¯¯: ${error.message}`;
            if (error.response && error.response.data) {
                errorMessage += `\n\nğŸŒ æœåŠ¡å™¨å“åº”:\n${JSON.stringify(error.response.data, null, 2)}`;
            }
            showMessage(errorMessage, 'error');
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            testButton.textContent = originalText;
            testButton.disabled = false;
        }
    }

    // AIé…ç½®æäº¤å¤„ç†å‡½æ•°
    async function handleAiConfigSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const isEditMode = form.dataset.editMode === 'true';
        const editId = form.dataset.editId;

        const formData = new FormData(form);

        const data = {
            config_name: formData.get('config_name'),
            api_key: formData.get('api_key'),
            base_url: formData.get('base_url'),
            model_name: formData.get('model_name')
        };

        if (!data.config_name || !data.base_url || !data.model_name) {
            showMessage('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯', 'error');
            return;
        }

        // ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœAPIå¯†é’¥ä¸ºç©ºåˆ™ä¸æ›´æ–°
        if (isEditMode && !data.api_key) {
            delete data.api_key;
        }

        if (!isEditMode && !data.api_key) {
            showMessage('æ–°å»ºé…ç½®æ—¶APIå¯†é’¥ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        // ç®€å•çš„é…ç½®éªŒè¯
        try {
            new URL(data.base_url);
        } catch (e) {
            showMessage('APIåŸºç¡€URLæ ¼å¼ä¸æ­£ç¡®', 'error');
            return;
        }

        try {
            let response;
            if (isEditMode) {
                // æ›´æ–°é…ç½®
                response = await axios.put(`/api/ai-configs/${editId}`, data);
            } else {
                // åˆ›å»ºæ–°é…ç½®ï¼Œç¬¬ä¸€ä¸ªé…ç½®è‡ªåŠ¨è®¾ä¸ºé»˜è®¤
                const statsResponse = await axios.get('/api/ai-configs/stats');
                const isFirstConfig = statsResponse.data.data.total_configs === 0;

                response = await axios.post('/api/ai-configs', {
                    ...data,
                    is_default: isFirstConfig
                });
            }

            if (response.data.code === 200) {
                showMessage(isEditMode ? 'AIé…ç½®æ›´æ–°æˆåŠŸï¼' : 'AIé…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨å’Œç»Ÿè®¡ä¿¡æ¯
                await loadConfigList();
                await updateConfigStats();
                // é€šçŸ¥å…¶ä»–é¡µé¢é…ç½®å·²æ›´æ”¹
                notifyConfigChange();
                // æ¸…ç©ºè¡¨å•
                clearForm();
            } else {
                showMessage('ä¿å­˜å¤±è´¥: ' + response.data.message, 'error');
            }
        } catch (error) {
            console.error(isEditMode ? 'æ›´æ–°AIé…ç½®å¤±è´¥:' : 'ä¿å­˜AIé…ç½®å¤±è´¥:', error);
            showMessage('ä¿å­˜å¤±è´¥: ' + (error.response?.data?.message || error.message), 'error');
        }
    }

    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showMessage(message, type = 'info') {
        const messageEl = document.createElement('div');
        messageEl.textContent = message;

        // ä¸ºä¸åŒç±»å‹è®¾ç½®èƒŒæ™¯è‰²
        let backgroundColor, borderColor, textColor;

        switch (type) {
            case 'success':
                backgroundColor = '#28a745';
                borderColor = '#28a745';
                textColor = 'white';
                break;
            case 'warning':
                backgroundColor = '#ffc107';
                borderColor = '#ffc107';
                textColor = '#212529';
                break;
            case 'error':
                backgroundColor = '#dc3545';
                borderColor = '#dc3545';
                textColor = 'white';
                break;
            case 'info':
                backgroundColor = '#17a2b8';
                borderColor = '#17a2b8';
                textColor = 'white';
                break;
            default:
                backgroundColor = '#6c757d';
                borderColor = '#6c757d';
                textColor = 'white';
        }

        messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 8px;
            color: ${textColor};
            z-index: 1001;
            background-color: ${backgroundColor};
            border: 1px solid ${borderColor};
            white-space: pre-line;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 13px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-height: 80vh;
            overflow-y: auto;
            cursor: pointer;
            transition: all 0.3s ease;
        `;

        // æ·»åŠ ç‚¹å‡»å…³é—­åŠŸèƒ½
        messageEl.addEventListener('click', function () {
            if (document.body.contains(messageEl)) {
                document.body.removeChild(messageEl);
            }
        });

        // æ·»åŠ æ‚¬æµ®æ•ˆæœ
        messageEl.addEventListener('mouseenter', function () {
            messageEl.style.transform = 'translateY(-2px)';
            messageEl.style.boxShadow = '0 6px 16px rgba(0,0,0,0.2)';
        });

        messageEl.addEventListener('mouseleave', function () {
            messageEl.style.transform = 'translateY(0)';
            messageEl.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        });

        document.body.appendChild(messageEl);

        // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ—¶é•¿
        const displayTime = type === 'success' || type === 'info' ? 8000 : type === 'warning' ? 10000 : 12000;

        setTimeout(() => {
            if (document.body.contains(messageEl)) {
                messageEl.style.opacity = '0';
                messageEl.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (document.body.contains(messageEl)) {
                        document.body.removeChild(messageEl);
                    }
                }, 300);
            }
        }, displayTime);
    }

    // é€šçŸ¥å…¶ä»–é¡µé¢é…ç½®å·²æ›´æ”¹
    function notifyConfigChange() {
        // ä½¿ç”¨LocalStorageæ¥é€šçŸ¥å…¶ä»–é¡µé¢
        localStorage.setItem('ai_config_changed', Date.now().toString());

        // è§¦å‘storageäº‹ä»¶ï¼ˆç”¨äºåŒä¸€æµè§ˆå™¨çš„å…¶ä»–æ ‡ç­¾é¡µï¼‰
        window.dispatchEvent(new StorageEvent('storage', {
            key: 'ai_config_changed',
            newValue: Date.now().toString()
        }));

        console.log('å·²é€šçŸ¥å…¶ä»–é¡µé¢AIé…ç½®å·²æ›´æ”¹');
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–é…ç½®ç®¡ç†
    document.addEventListener('DOMContentLoaded', async function () {
        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('aiConfigForm').addEventListener('submit', handleAiConfigSubmit);

        // åˆå§‹åŒ–é…ç½®ç®¡ç†
        await initializeConfigManagement();
    });

</script>
{% endblock %}