<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰§è¡Œæ§åˆ¶å° - AIæµ‹è¯•ç³»ç»Ÿ</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
        }

        .header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .back-btn {
            color: #1890ff;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid #1890ff;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: #1890ff;
            color: white;
        }

        .content {
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            height: calc(100vh - 120px);
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 600;
            font-size: 16px;
        }

        .panel-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .testcase-selector {
            margin-bottom: 20px;
        }

        .testcase-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .testcase-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }

        .execution-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .mode-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 20px;
        }

        .mode-selector label {
            font-weight: 500;
        }

        .mode-selector input[type="radio"] {
            margin-right: 4px;
        }

        .mode-description {
            margin-bottom: 20px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }

        .mode-description small {
            color: #666;
            font-size: 13px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #52c41a;
            color: white;
        }

        .btn-primary:hover {
            background: #73d13d;
        }

        .btn-primary:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .btn-danger:hover {
            background: #ff7875;
        }

        .execution-status {
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status-idle {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #389e0d;
        }

        .status-running {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }

        .status-success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }

        .status-failed {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: #1890ff;
            transition: width 0.3s ease;
        }

        .step-list {
            margin-top: 20px;
        }

        .step-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-icon.pending {
            background: #f0f0f0;
            color: #8c8c8c;
        }

        .step-icon.running {
            background: #1890ff;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .step-icon.success {
            background: #52c41a;
            color: white;
        }

        .step-icon.failed {
            background: #ff4d4f;
            color: white;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .step-description {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }

        .step-time {
            color: #8c8c8c;
            font-size: 12px;
            margin-top: 4px;
        }

        .log-container {
            background: #001529;
            color: #fff;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 4px;
        }

        .log-timestamp {
            color: #8c8c8c;
            margin-right: 8px;
        }

        .log-level-info {
            color: #1890ff;
        }

        .log-level-success {
            color: #52c41a;
        }

        .log-level-error {
            color: #ff4d4f;
        }

        .log-level-warning {
            color: #fa8c16;
        }

        .screenshot-container {
            margin-top: 16px;
        }

        .screenshot-container img {
            max-width: 100%;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* æ­¥éª¤æˆªå›¾ç¼©ç•¥å›¾æ ·å¼ */
        .step-screenshot {
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .step-screenshot-thumbnail {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid #e8e8e8;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .step-screenshot-thumbnail:hover {
            border-color: #1890ff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .step-screenshot-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            text-align: center;
        }

        /* æˆªå›¾å†å²æ ·å¼ */
        .screenshot-history-container {
            margin-top: 20px;
        }

        .screenshot-history {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            background: #fafafa;
        }

        .screenshot-item {
            position: relative;
            width: 120px;
            height: 90px;
            border: 2px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .screenshot-item:hover {
            border-color: #1890ff;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .screenshot-item.current {
            border-color: #52c41a;
            box-shadow: 0 0 0 2px rgba(82, 196, 26, 0.2);
        }

        .screenshot-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .screenshot-item .step-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 4px;
            font-size: 10px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .screenshot-item .step-index {
            position: absolute;
            top: 2px;
            left: 2px;
            background: #1890ff;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* å…¨å±æˆªå›¾æŸ¥çœ‹å™¨ */
        .screenshot-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }

        .screenshot-viewer img {
            max-width: 95%;
            max-height: 95%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            cursor: default;
        }

        .screenshot-viewer-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }

        .screenshot-viewer-close:hover {
            color: #ccc;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #8c8c8c;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ‰§è¡Œæ§åˆ¶å°</h1>
        <a href="/" class="back-btn">è¿”å›é¦–é¡µ</a>
    </div>

    <div class="content">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">æ‰§è¡Œæ§åˆ¶</div>
            <div class="panel-content">
                <!-- æµ‹è¯•ç”¨ä¾‹é€‰æ‹© -->
                <div class="testcase-selector">
                    <label for="testcaseSelect">é€‰æ‹©æµ‹è¯•ç”¨ä¾‹:</label>
                    <select id="testcaseSelect" class="testcase-select">
                        <option value="">è¯·é€‰æ‹©æµ‹è¯•ç”¨ä¾‹</option>
                    </select>
                </div>

                <!-- æ‰§è¡Œæ¨¡å¼ -->
                <div class="mode-selector">
                    <label>æ‰§è¡Œæ¨¡å¼:</label>
                    <label><input type="radio" name="mode" value="headless" checked> ğŸš€ æ— å¤´æ¨¡å¼</label>
                    <label><input type="radio" name="mode" value="browser"> ğŸ–¥ï¸ æµè§ˆå™¨æ¨¡å¼</label>
                </div>

                <!-- æ¨¡å¼è¯´æ˜ -->
                <div class="mode-description">
                    <small id="modeDescription">
                        ğŸš€ <strong>æ— å¤´æ¨¡å¼</strong>: åå°æ‰§è¡Œï¼Œé€Ÿåº¦å¿«ï¼Œå¤±è´¥æ—¶åœæ­¢æ‰§è¡Œ
                    </small>
                </div>

                <!-- æ‰§è¡Œæ§åˆ¶æŒ‰é’® -->
                <div class="execution-controls">
                    <button id="startBtn" class="btn btn-primary" onclick="startExecution()">â–¶ï¸ å¼€å§‹æ‰§è¡Œ</button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopExecution()" disabled>â¹ï¸ åœæ­¢æ‰§è¡Œ</button>
                </div>

                <!-- æ‰§è¡ŒçŠ¶æ€ -->
                <div id="executionStatus" class="execution-status status-idle">
                    çŠ¶æ€: å°±ç»ª
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div id="progressContainer" style="display: none;">
                    <div>æ‰§è¡Œè¿›åº¦:</div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div id="progressText">0 / 0</div>
                </div>

                <!-- æ­¥éª¤åˆ—è¡¨ -->
                <div id="stepList" class="step-list">
                    <div class="empty-state">
                        <div class="icon">ğŸ“</div>
                        <div>è¯·é€‰æ‹©æµ‹è¯•ç”¨ä¾‹æŸ¥çœ‹æ‰§è¡Œæ­¥éª¤</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ç›‘æ§é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">æ‰§è¡Œç›‘æ§</div>
            <div class="panel-content">
                <!-- å®æ—¶æ—¥å¿— -->
                <div>
                    <h4>æ‰§è¡Œæ—¥å¿—:</h4>
                    <div id="logContainer" class="log-container">
                        <div class="log-entry">
                            <span class="log-timestamp">[ç­‰å¾…ä¸­]</span>
                            <span class="log-level-info">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ‰§è¡ŒæŒ‡ä»¤...</span>
                        </div>
                    </div>
                </div>

                <!-- æˆªå›¾å±•ç¤º -->
                <div id="screenshotContainer" class="screenshot-container" style="display: none;">
                    <h4>å½“å‰æˆªå›¾:</h4>
                    <img id="currentScreenshot" src="" alt="æ‰§è¡Œæˆªå›¾">
                </div>

                <!-- æ­¥éª¤æˆªå›¾å†å² -->
                <div id="screenshotHistoryContainer" class="screenshot-history-container" style="display: none;">
                    <h4>æ­¥éª¤æˆªå›¾å†å²:</h4>
                    <div id="screenshotHistory" class="screenshot-history">
                        <!-- æˆªå›¾ç¼©ç•¥å›¾å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        const API_BASE = '/api';
        let currentExecution = null;
        let pollingInterval = null;
        let testcases = [];
        let screenshotHistory = []; // å­˜å‚¨æ‰€æœ‰æ­¥éª¤çš„æˆªå›¾å†å²

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadTestcases();
            setupEventListeners();
            addLog('æ‰§è¡Œæ§åˆ¶å°å·²å°±ç»ª', 'success');
        });

        function setupEventListeners() {
            // æµ‹è¯•ç”¨ä¾‹é€‰æ‹©å˜åŒ–
            document.getElementById('testcaseSelect').addEventListener('change', function() {
                const testcaseId = this.value;
                if (testcaseId) {
                    loadTestcaseSteps(testcaseId);
                } else {
                    clearStepList();
                }
            });

            // URLå‚æ•°å¤„ç†
            const urlParams = new URLSearchParams(window.location.search);
            const testcaseId = urlParams.get('testcase');
            if (testcaseId) {
                setTimeout(() => {
                    document.getElementById('testcaseSelect').value = testcaseId;
                    loadTestcaseSteps(testcaseId);
                }, 1000);
            }
        }

        // è½®è¯¢æ£€æŸ¥æ‰§è¡ŒçŠ¶æ€
        function startPolling(executionId) {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            pollingInterval = setInterval(async () => {
                try {
                    const response = await axios.get(`${API_BASE}/executions/${executionId}/status`);
                    if (response.data.code === 200) {
                        const status = response.data.data;
                        updateExecutionFromStatus(status);

                        // å¦‚æœæ‰§è¡Œå®Œæˆï¼Œåœæ­¢è½®è¯¢
                        if (status.status === 'completed' || status.status === 'failed') {
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                        }
                    }
                } catch (error) {
                    console.error('è½®è¯¢æ‰§è¡ŒçŠ¶æ€å¤±è´¥:', error);
                }
            }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
        }

        function updateExecutionFromStatus(status) {
            // æ›´æ–°æ‰§è¡ŒçŠ¶æ€
            updateExecutionStatus(status.status, status.message || '');

            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            if (status.steps) {
                status.steps.forEach((step, index) => {
                    updateStepStatus(index, step.status);
                });
                updateProgress(status.completed_steps || 0, status.total_steps || 0);
            }

            // æ·»åŠ æ—¥å¿—
            if (status.current_step) {
                    addLog(`æ­¥éª¤ ${data.step_index + 1} æ‰§è¡ŒæˆåŠŸ (${data.duration}ç§’)`, 'success');
                } else {
                    addLog(`æ­¥éª¤ ${data.step_index + 1} æ‰§è¡Œå¤±è´¥: ${data.error_message}`, 'error');
                }

                // å¤„ç†æˆªå›¾
                if (data.screenshot) {
                    // æ–°æ ¼å¼ï¼šå®Œæ•´çš„æˆªå›¾å¯¹è±¡
                    addScreenshotToHistory(data.screenshot);
                    showScreenshot(data.screenshot.path);
                } else if (data.screenshot_path) {
                    // å…¼å®¹æ—§æ ¼å¼ï¼šåªæœ‰è·¯å¾„
                    const screenshot = {
                        path: data.screenshot_path,
                        step_index: data.step_index || screenshotHistory.length,
                        step_name: `æ­¥éª¤ ${(data.step_index || screenshotHistory.length) + 1}`,
                        timestamp: Date.now()
                    };
                    addScreenshotToHistory(screenshot);
                    showScreenshot(data.screenshot_path);
                }

                // è°ƒè¯•è¾“å‡º
                console.log('æ­¥éª¤å®Œæˆäº‹ä»¶:', data);
                console.log('æˆªå›¾å†å²:', screenshotHistory);
            });

            socket.on('execution_completed', function(data) {
                currentExecution = null;
                const status = data.status === 'success' ? 'success' : 'failed';
                updateExecutionStatus(status, `æ‰§è¡Œå®Œæˆ: ${data.status}`);
                addLog(`æµ‹è¯•æ‰§è¡Œå®Œæˆ: ${data.steps_passed}/${data.total_steps} æ­¥éª¤æˆåŠŸ`, 
                       data.status === 'success' ? 'success' : 'error');
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            });

            socket.on('execution_error', function(data) {
                currentExecution = null;
                updateExecutionStatus('failed', 'æ‰§è¡Œé”™è¯¯');
                addLog(`æ‰§è¡Œé”™è¯¯: ${data.message}`, 'error');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            });
        }

        async function loadTestcases() {
            try {
                console.log('å¼€å§‹åŠ è½½æµ‹è¯•ç”¨ä¾‹...');
                addLog('æ­£åœ¨åŠ è½½æµ‹è¯•ç”¨ä¾‹...', 'info');

                const response = await axios.get(`${API_BASE}/testcases?size=100`);
                console.log('æµ‹è¯•ç”¨ä¾‹APIå“åº”:', response.data);

                if (response.data.code === 200) {
                    testcases = response.data.data.items;
                    console.log('åŠ è½½çš„æµ‹è¯•ç”¨ä¾‹:', testcases);
                    addLog(`æˆåŠŸåŠ è½½ ${testcases.length} ä¸ªæµ‹è¯•ç”¨ä¾‹`, 'success');
                    renderTestcaseOptions();
                } else {
                    console.error('APIè¿”å›é”™è¯¯:', response.data);
                    addLog(`åŠ è½½å¤±è´¥: ${response.data.message}`, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
                addLog(`åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function renderTestcaseOptions() {
            console.log('å¼€å§‹æ¸²æŸ“æµ‹è¯•ç”¨ä¾‹é€‰é¡¹...');
            const select = document.getElementById('testcaseSelect');

            if (!select) {
                console.error('æ‰¾ä¸åˆ°testcaseSelectå…ƒç´ ');
                addLog('é¡µé¢å…ƒç´ åŠ è½½é”™è¯¯', 'error');
                return;
            }

            select.innerHTML = '<option value="">è¯·é€‰æ‹©æµ‹è¯•ç”¨ä¾‹</option>';

            console.log('è¦æ¸²æŸ“çš„æµ‹è¯•ç”¨ä¾‹æ•°é‡:', testcases.length);

            testcases.forEach((testcase, index) => {
                console.log(`æ¸²æŸ“æµ‹è¯•ç”¨ä¾‹ ${index + 1}:`, testcase);
                const option = document.createElement('option');
                option.value = testcase.id;
                option.textContent = `${testcase.name} (${testcase.category || 'æœªåˆ†ç±»'})`;
                select.appendChild(option);
            });

            addLog(`å·²åŠ è½½ ${testcases.length} ä¸ªæµ‹è¯•ç”¨ä¾‹åˆ°ä¸‹æ‹‰èœå•`, 'success');
        }

        async function loadTestcaseSteps(testcaseId) {
            try {
                const response = await axios.get(`${API_BASE}/testcases/${testcaseId}`);
                if (response.data.code === 200) {
                    const testcase = response.data.data;
                    renderSteps(testcase.steps);
                }
            } catch (error) {
                addLog('åŠ è½½æµ‹è¯•æ­¥éª¤å¤±è´¥', 'error');
            }
        }

        function renderSteps(steps) {
            const stepList = document.getElementById('stepList');
            
            if (!steps || steps.length === 0) {
                stepList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âš ï¸</div>
                        <div>è¯¥æµ‹è¯•ç”¨ä¾‹æš‚æ— æ‰§è¡Œæ­¥éª¤</div>
                    </div>
                `;
                return;
            }

            stepList.innerHTML = steps.map((step, index) => `
                <div class="step-item" id="step-${index}">
                    <div class="step-icon pending" id="step-icon-${index}">
                        ${index + 1}
                    </div>
                    <div class="step-content">
                        <div class="step-title">${step.description || step.action}</div>
                        <div class="step-description">${JSON.stringify(step.params || {})}</div>
                        <div class="step-time" id="step-time-${index}"></div>
                    </div>
                </div>
            `).join('');
        }

        function clearStepList() {
            document.getElementById('stepList').innerHTML = `
                <div class="empty-state">
                    <div class="icon">ğŸ“</div>
                    <div>è¯·é€‰æ‹©æµ‹è¯•ç”¨ä¾‹æŸ¥çœ‹æ‰§è¡Œæ­¥éª¤</div>
                </div>
            `;
        }

        async function startExecution() {
            const testcaseId = document.getElementById('testcaseSelect').value;
            if (!testcaseId) {
                addLog('è¯·å…ˆé€‰æ‹©æµ‹è¯•ç”¨ä¾‹', 'warning');
                return;
            }

            const mode = document.querySelector('input[name="mode"]:checked').value;

            // é‡ç½®æ­¥éª¤çŠ¶æ€
            const stepIcons = document.querySelectorAll('.step-icon');
            stepIcons.forEach(icon => {
                icon.className = 'step-icon pending';
                icon.textContent = icon.id.split('-')[2] ? parseInt(icon.id.split('-')[2]) + 1 : '';
            });

            // æ¸…ç©ºæ—¥å¿—
            document.getElementById('logContainer').innerHTML = '';

            // æ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0, stepIcons.length);

            try {
                // å‘é€HTTPæ‰§è¡Œè¯·æ±‚
                const response = await axios.post(`${API_BASE}/executions/start`, {
                    testcase_id: parseInt(testcaseId),
                    mode: mode
                });

                if (response.data.code === 200) {
                    currentExecution = response.data.data.execution_id;
                    addLog(`å¼€å§‹æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ (æ¨¡å¼: ${mode})`, 'info');
                    addLog(response.data.data.message, 'info');

                    // å¼€å§‹è½®è¯¢çŠ¶æ€
                    startPolling(currentExecution);

                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                } else {
                    addLog(`æ‰§è¡Œå¯åŠ¨å¤±è´¥: ${response.data.message}`, 'error');
                }
            } catch (error) {
                addLog(`æ‰§è¡Œå¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function stopExecution() {
            if (currentExecution) {
                // TODO: å®ç°åœæ­¢æ‰§è¡ŒåŠŸèƒ½
                addLog('åœæ­¢æ‰§è¡ŒåŠŸèƒ½å¼€å‘ä¸­...', 'warning');
            }
        }

        function updateExecutionStatus(status, message) {
            const statusEl = document.getElementById('executionStatus');
            statusEl.className = `execution-status status-${status}`;
            statusEl.textContent = `çŠ¶æ€: ${message}`;
        }

        function updateStepStatus(stepIndex, status) {
            const iconEl = document.getElementById(`step-icon-${stepIndex}`);
            if (iconEl) {
                iconEl.className = `step-icon ${status}`;
                if (status === 'success') {
                    iconEl.textContent = 'âœ“';
                } else if (status === 'failed') {
                    iconEl.textContent = 'âœ—';
                } else if (status === 'running') {
                    iconEl.textContent = 'â³';
                }
            }
        }

        function updateProgress(current, total) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            const percentage = total > 0 ? (current / total) * 100 : 0;
            progressFill.style.width = percentage + '%';
            progressText.textContent = `${current} / ${total}`;
        }

        function getCurrentTotalSteps() {
            const stepIcons = document.querySelectorAll('.step-icon');
            return stepIcons.length;
        }

        function addLog(message, level = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showScreenshot(path) {
            const container = document.getElementById('screenshotContainer');
            const img = document.getElementById('currentScreenshot');

            img.src = path;
            container.style.display = 'block';
        }

        // æˆªå›¾å†å²å¤„ç†å‡½æ•°
        function clearScreenshotHistory() {
            screenshotHistory = [];
            const historyContainer = document.getElementById('screenshotHistory');
            historyContainer.innerHTML = '';
            document.getElementById('screenshotHistoryContainer').style.display = 'none';
        }

        function addScreenshotToHistory(screenshot) {
            screenshotHistory.push(screenshot);
            renderScreenshotHistory();

            // æ˜¾ç¤ºæˆªå›¾å†å²å®¹å™¨
            document.getElementById('screenshotHistoryContainer').style.display = 'block';
        }

        function renderScreenshotHistory() {
            const historyContainer = document.getElementById('screenshotHistory');
            historyContainer.innerHTML = '';

            screenshotHistory.forEach((screenshot, index) => {
                const item = document.createElement('div');
                item.className = 'screenshot-item';
                if (index === screenshotHistory.length - 1) {
                    item.classList.add('current'); // æ ‡è®°å½“å‰æˆªå›¾
                }

                item.innerHTML = `
                    <div class="step-index">${screenshot.step_index + 1}</div>
                    <img src="${screenshot.path}" alt="æ­¥éª¤ ${screenshot.step_index + 1} æˆªå›¾"
                         onerror="this.style.display='none'">
                    <div class="step-label">${screenshot.step_name}</div>
                `;

                // ç‚¹å‡»ç¼©ç•¥å›¾æ˜¾ç¤ºå¤§å›¾
                item.addEventListener('click', function() {
                    showScreenshotFullscreen(screenshot.path, screenshot.step_name);

                    // æ›´æ–°å½“å‰æˆªå›¾
                    showScreenshot(screenshot.path);

                    // æ›´æ–°å½“å‰æ ‡è®°
                    document.querySelectorAll('.screenshot-item').forEach(el => el.classList.remove('current'));
                    item.classList.add('current');
                });

                historyContainer.appendChild(item);
            });

            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æˆªå›¾
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }

        function showScreenshotFullscreen(imagePath, stepName) {
            // åˆ›å»ºå…¨å±æŸ¥çœ‹å™¨
            let viewer = document.getElementById('screenshotViewer');
            if (!viewer) {
                viewer = document.createElement('div');
                viewer.id = 'screenshotViewer';
                viewer.className = 'screenshot-viewer';
                viewer.innerHTML = `
                    <div style="position: relative;">
                        <img id="fullscreenImage" src="" alt="æˆªå›¾">
                        <div style="position: absolute; top: -40px; left: 0; color: white; font-size: 16px; font-weight: bold;">
                            <span id="fullscreenTitle"></span>
                        </div>
                        <div style="position: absolute; top: -40px; right: 0; color: white; font-size: 24px; cursor: pointer;" onclick="closeScreenshotViewer()">
                            âœ•
                        </div>
                    </div>
                `;
                document.body.appendChild(viewer);

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                viewer.addEventListener('click', function(e) {
                    if (e.target === viewer) {
                        closeScreenshotViewer();
                    }
                });
            }

            document.getElementById('fullscreenImage').src = imagePath;
            document.getElementById('fullscreenTitle').textContent = stepName;
            viewer.style.display = 'flex';
        }

        function closeScreenshotViewer() {
            const viewer = document.getElementById('screenshotViewer');
            if (viewer) {
                viewer.style.display = 'none';
            }
        }

        // æ¨¡å¼åˆ‡æ¢å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            const modeRadios = document.querySelectorAll('input[name="mode"]');
            const modeDescription = document.getElementById('modeDescription');

            // æ¨¡å¼æè¿°æ–‡æœ¬
            const modeDescriptions = {
                'headless': 'ğŸš€ <strong>æ— å¤´æ¨¡å¼</strong>: åå°æ‰§è¡Œï¼Œé€Ÿåº¦å¿«ï¼Œå¤±è´¥æ—¶åœæ­¢æ‰§è¡Œ',
                'browser': 'ğŸ–¥ï¸ <strong>æµè§ˆå™¨æ¨¡å¼</strong>: å¯è§†åŒ–æ‰§è¡Œï¼Œä¾¿äºè°ƒè¯•ï¼Œå¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œ'
            };

            // ç›‘å¬æ¨¡å¼åˆ‡æ¢
            modeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        modeDescription.innerHTML = modeDescriptions[this.value];
                    }
                });
            });
        });
    </script>
</body>
</html>
