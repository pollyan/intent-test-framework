{% extends "base_layout.html" %}

{% block title %}仪表板 - AI测试用例管理系统{% endblock %}

{% block page_title %}仪表板{% endblock %}

{% block page_subtitle %}系统概览和快速操作{% endblock %}

{% block extra_css %}
<style>
    /* 统计卡片样式 */
    .stat-card {
        text-align: center;
        padding: 32px 24px;
    }

    .stat-number {
        font-size: 48px;
        font-weight: 200;
        color: #333333;
        margin-bottom: 8px;
        line-height: 1;
        letter-spacing: -2px;
    }

    .stat-label {
        font-size: 13px;
        color: #999999;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* 快速操作样式 */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .quick-action {
        padding: 20px;
        text-align: center;
        cursor: pointer;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        transition: all 0.2s ease;
        background: #ffffff;
    }

    .quick-action:hover {
        border-color: #d0d0d0;
        transform: translateY(-1px);
    }


    .action-title {
        font-weight: 500;
        margin-bottom: 8px;
        color: #333333;
        font-size: 14px;
    }

    .action-desc {
        font-size: 12px;
        color: #666666;
        line-height: 1.4;
    }

    /* 最近执行记录样式 */
    .recent-executions {
        max-height: 300px;
        overflow-y: auto;
    }

    .execution-item {
        display: flex;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .execution-item:last-child {
        border-bottom: none;
    }

    .execution-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
        font-size: 12px;
    }

    .execution-content {
        flex: 1;
    }

    .execution-title {
        font-weight: 500;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #333333;
    }

    .execution-status {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.06);
    }

    .execution-meta {
        font-size: 12px;
        color: #666666;
        line-height: 1.4;
    }

    /* 加载状态样式 */
    .loading {
        text-align: center;
        padding: 60px 20px;
        color: #999999;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f0f0f0;
        border-top: 2px solid #333333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .quick-actions {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <!-- 加载状态 -->
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <div>正在加载数据...</div>
    </div>

    <!-- 主要内容 -->
    <div id="main-content">
        <!-- 统计卡片 -->
        <div class="grid grid-cols-4 mb-4">
            <div class="card stat-card">
                <div class="stat-number" id="total-testcases">0</div>
                <div class="stat-label">测试用例总数</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="total-executions">0</div>
                <div class="stat-label">执行总次数</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="success-executions">0</div>
                <div class="stat-label">成功次数</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="success-rate">0%</div>
                <div class="stat-label">成功率</div>
            </div>
        </div>

        <!-- 功能区域 -->
        <div class="grid grid-cols-2 gap-3">
            <!-- 快速操作 -->
            <div class="card">
                <h3 class="card-title">快速操作</h3>
                <p class="card-subtitle">常用功能快速访问</p>
                <div class="quick-actions">
                    <div class="quick-action" data-url="/testcases?action=create">
                        <div class="action-title">创建测试用例</div>
                        <div class="action-desc">使用自然语言快速创建测试用例</div>
                    </div>
                    <div class="quick-action" data-url="/execution">
                        <div class="action-title">执行测试</div>
                        <div class="action-desc">选择测试用例并立即执行</div>
                    </div>
                    <div class="quick-action" data-url="/reports">
                        <div class="action-title">查看报告</div>
                        <div class="action-desc">查看最新的测试执行报告</div>
                    </div>
                    <div class="quick-action" data-url="/templates">
                        <div class="action-title">使用模板</div>
                        <div class="action-desc">从模板库选择预设测试场景</div>
                    </div>
                </div>
            </div>

            <!-- 最近执行记录 -->
            <div class="card">
                <h3 class="card-title">最近执行记录</h3>
                <p class="card-subtitle">系统执行历史</p>
                <div id="recent-executions" class="recent-executions">
                    <!-- 动态加载内容 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API基础配置
    const API_BASE = '/api';
    
    // 智能WebSocket连接 - 仪表板页面不需要连接WebSocket
    // WebSocket只在执行控制台页面使用，连接到本地代理服务器
    let socket = null;

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    function initializePage() {
        loadDashboardData();
        setupWebSocket();
        setupQuickActions();
    }

    function setupWebSocket() {
        // 仪表板页面不需要WebSocket连接
        // WebSocket连接只在执行控制台页面使用，用于实时监控测试执行
        console.log('仪表板页面已加载，无需WebSocket连接');
    }

    function setupQuickActions() {
        // 设置快速操作点击事件
        const quickActions = document.querySelectorAll('.quick-action');
        quickActions.forEach(action => {
            action.addEventListener('click', function() {
                const url = this.dataset.url;
                if (url) {
                    window.location.href = url;
                }
            });
        });
    }

    async function loadDashboardData() {
        try {
            showLoading(true);

            // 加载统计数据
            const statsResponse = await axios.get(API_BASE + '/stats/dashboard');
            if (statsResponse.data.code === 200) {
                updateStats(statsResponse.data.data);
            }

            // 加载最近执行记录
            const executionsResponse = await axios.get(API_BASE + '/executions?size=10');
            if (executionsResponse.data.code === 200) {
                updateRecentExecutions(executionsResponse.data.data.items);
            }

        } catch (error) {
            console.error('加载数据失败:', error);
            showMessage('加载数据失败', 'error');
        } finally {
            showLoading(false);
        }
    }

    function updateStats(stats) {
        document.getElementById('total-testcases').textContent = stats.total_testcases || 0;
        document.getElementById('total-executions').textContent = stats.total_executions || 0;
        document.getElementById('success-executions').textContent = stats.success_executions || 0;
        document.getElementById('success-rate').textContent = (stats.success_rate || 0) + '%';
    }

    function updateRecentExecutions(executions) {
        const container = document.getElementById('recent-executions');
        container.innerHTML = '';

        if (executions.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4">暂无执行记录</div>';
            return;
        }

        executions.forEach(execution => {
            const item = createExecutionItem(execution);
            container.appendChild(item);
        });
    }

    function createExecutionItem(execution) {
        const item = document.createElement('div');
        item.className = 'execution-item';

        const statusIcon = getStatusIcon(execution.status);
        const statusColor = getStatusColor(execution.status);
        const statusText = getStatusText(execution.status);

        item.innerHTML = `
            <div class="execution-avatar" style="background-color: ${statusColor}">
                ${statusIcon}
            </div>
            <div class="execution-content">
                <div class="execution-title">
                    ${execution.test_case_name}
                    <span class="execution-status" style="color: ${statusColor}">${statusText}</span>
                </div>
                <div class="execution-meta">
                    <div>执行时间: ${execution.duration ? execution.duration + '秒' : '未知'}</div>
                    <div>开始时间: ${new Date(execution.start_time).toLocaleString()}</div>
                </div>
            </div>
        `;

        return item;
    }

    function getStatusIcon(status) {
        switch (status) {
            case 'success': return '✓';
            case 'failed': return '✗';
            case 'running': return '⏳';
            default: return '○';
        }
    }

    function getStatusColor(status) {
        switch (status) {
            case 'success': return '#28a745';
            case 'failed': return '#dc3545';
            case 'running': return '#333333';
            default: return '#6c757d';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'success': return '成功';
            case 'failed': return '失败';
            case 'running': return '运行中';
            case 'pending': return '等待中';
            default: return status;
        }
    }

    function showLoading(show) {
        const loadingEl = document.getElementById('loading');
        const contentEl = document.getElementById('main-content');

        if (show) {
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
        } else {
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
        }
    }
</script>
{% endblock %}
