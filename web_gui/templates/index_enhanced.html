{% extends "base_layout.html" %}

{% block title %}ä»ªè¡¨æ¿ - AIæµ‹è¯•ç”¨ä¾‹ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}ä»ªè¡¨æ¿{% endblock %}

{% block page_subtitle %}ç³»ç»Ÿæ¦‚è§ˆå’Œå¿«é€Ÿæ“ä½œ{% endblock %}

{% block extra_css %}
<style>
    /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
    .stat-card {
        text-align: center;
        padding: 32px 24px;
    }

    .stat-number {
        font-size: 48px;
        font-weight: 200;
        color: #333333;
        margin-bottom: 8px;
        line-height: 1;
        letter-spacing: -2px;
    }

    .stat-label {
        font-size: 13px;
        color: #999999;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* å¿«é€Ÿæ“ä½œæ ·å¼ */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .quick-action {
        padding: 20px;
        text-align: center;
        cursor: pointer;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        transition: all 0.2s ease;
        background: #ffffff;
    }

    .quick-action:hover {
        border-color: #d0d0d0;
        transform: translateY(-1px);
    }

    .action-icon {
        font-size: 24px;
        margin-bottom: 12px;
    }

    .action-title {
        font-weight: 500;
        margin-bottom: 8px;
        color: #333333;
        font-size: 14px;
    }

    .action-desc {
        font-size: 12px;
        color: #666666;
        line-height: 1.4;
    }

    /* æœ€è¿‘æ‰§è¡Œè®°å½•æ ·å¼ */
    .recent-executions {
        max-height: 300px;
        overflow-y: auto;
    }

    .execution-item {
        display: flex;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .execution-item:last-child {
        border-bottom: none;
    }

    .execution-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 12px;
        flex-shrink: 0;
        font-size: 12px;
    }

    .execution-content {
        flex: 1;
    }

    .execution-title {
        font-weight: 500;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #333333;
    }

    .execution-status {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.06);
    }

    .execution-meta {
        font-size: 12px;
        color: #666666;
        line-height: 1.4;
    }

    /* åŠ è½½çŠ¶æ€æ ·å¼ */
    .loading {
        text-align: center;
        padding: 60px 20px;
        color: #999999;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f0f0f0;
        border-top: 2px solid #333333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .quick-actions {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <div>æ­£åœ¨åŠ è½½æ•°æ®...</div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div id="main-content">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid grid-cols-4 mb-4">
            <div class="card stat-card">
                <div class="stat-number" id="total-testcases">0</div>
                <div class="stat-label">æµ‹è¯•ç”¨ä¾‹æ€»æ•°</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="total-executions">0</div>
                <div class="stat-label">æ‰§è¡Œæ€»æ¬¡æ•°</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="success-executions">0</div>
                <div class="stat-label">æˆåŠŸæ¬¡æ•°</div>
            </div>
            <div class="card stat-card">
                <div class="stat-number" id="success-rate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
        </div>

        <!-- åŠŸèƒ½åŒºåŸŸ -->
        <div class="grid grid-cols-2 gap-3">
            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="card">
                <h3 class="card-title">å¿«é€Ÿæ“ä½œ</h3>
                <p class="card-subtitle">å¸¸ç”¨åŠŸèƒ½å¿«é€Ÿè®¿é—®</p>
                <div class="quick-actions">
                    <div class="quick-action" data-url="/testcases?action=create">
                        <div class="action-icon">â•</div>
                        <div class="action-title">åˆ›å»ºæµ‹è¯•ç”¨ä¾‹</div>
                        <div class="action-desc">ä½¿ç”¨è‡ªç„¶è¯­è¨€å¿«é€Ÿåˆ›å»ºæµ‹è¯•ç”¨ä¾‹</div>
                    </div>
                    <div class="quick-action" data-url="/execution">
                        <div class="action-icon">ğŸš€</div>
                        <div class="action-title">æ‰§è¡Œæµ‹è¯•</div>
                        <div class="action-desc">é€‰æ‹©æµ‹è¯•ç”¨ä¾‹å¹¶ç«‹å³æ‰§è¡Œ</div>
                    </div>
                    <div class="quick-action" data-url="/reports">
                        <div class="action-icon">ğŸ“Š</div>
                        <div class="action-title">æŸ¥çœ‹æŠ¥å‘Š</div>
                        <div class="action-desc">æŸ¥çœ‹æœ€æ–°çš„æµ‹è¯•æ‰§è¡ŒæŠ¥å‘Š</div>
                    </div>
                    <div class="quick-action" data-url="/templates">
                        <div class="action-icon">ğŸ“‹</div>
                        <div class="action-title">ä½¿ç”¨æ¨¡æ¿</div>
                        <div class="action-desc">ä»æ¨¡æ¿åº“é€‰æ‹©é¢„è®¾æµ‹è¯•åœºæ™¯</div>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘æ‰§è¡Œè®°å½• -->
            <div class="card">
                <h3 class="card-title">æœ€è¿‘æ‰§è¡Œè®°å½•</h3>
                <p class="card-subtitle">ç³»ç»Ÿæ‰§è¡Œå†å²</p>
                <div id="recent-executions" class="recent-executions">
                    <!-- åŠ¨æ€åŠ è½½å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // APIåŸºç¡€é…ç½®
    const API_BASE = '/api';
    
    // æ™ºèƒ½WebSocketè¿æ¥ - ä»ªè¡¨æ¿é¡µé¢ä¸éœ€è¦è¿æ¥WebSocket
    // WebSocketåªåœ¨æ‰§è¡Œæ§åˆ¶å°é¡µé¢ä½¿ç”¨ï¼Œè¿æ¥åˆ°æœ¬åœ°ä»£ç†æœåŠ¡å™¨
    let socket = null;

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    function initializePage() {
        loadDashboardData();
        setupWebSocket();
        setupQuickActions();
    }

    function setupWebSocket() {
        // ä»ªè¡¨æ¿é¡µé¢ä¸éœ€è¦WebSocketè¿æ¥
        // WebSocketè¿æ¥åªåœ¨æ‰§è¡Œæ§åˆ¶å°é¡µé¢ä½¿ç”¨ï¼Œç”¨äºå®æ—¶ç›‘æ§æµ‹è¯•æ‰§è¡Œ
        console.log('ä»ªè¡¨æ¿é¡µé¢å·²åŠ è½½ï¼Œæ— éœ€WebSocketè¿æ¥');
    }

    function setupQuickActions() {
        // è®¾ç½®å¿«é€Ÿæ“ä½œç‚¹å‡»äº‹ä»¶
        const quickActions = document.querySelectorAll('.quick-action');
        quickActions.forEach(action => {
            action.addEventListener('click', function() {
                const url = this.dataset.url;
                if (url) {
                    window.location.href = url;
                }
            });
        });
    }

    async function loadDashboardData() {
        try {
            showLoading(true);

            // åŠ è½½ç»Ÿè®¡æ•°æ®
            const statsResponse = await axios.get(API_BASE + '/stats/dashboard');
            if (statsResponse.data.code === 200) {
                updateStats(statsResponse.data.data);
            }

            // åŠ è½½æœ€è¿‘æ‰§è¡Œè®°å½•
            const executionsResponse = await axios.get(API_BASE + '/executions?size=10');
            if (executionsResponse.data.code === 200) {
                updateRecentExecutions(executionsResponse.data.data.items);
            }

        } catch (error) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            showMessage('åŠ è½½æ•°æ®å¤±è´¥', 'error');
        } finally {
            showLoading(false);
        }
    }

    function updateStats(stats) {
        document.getElementById('total-testcases').textContent = stats.total_testcases || 0;
        document.getElementById('total-executions').textContent = stats.total_executions || 0;
        document.getElementById('success-executions').textContent = stats.success_executions || 0;
        document.getElementById('success-rate').textContent = (stats.success_rate || 0) + '%';
    }

    function updateRecentExecutions(executions) {
        const container = document.getElementById('recent-executions');
        container.innerHTML = '';

        if (executions.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— æ‰§è¡Œè®°å½•</div>';
            return;
        }

        executions.forEach(execution => {
            const item = createExecutionItem(execution);
            container.appendChild(item);
        });
    }

    function createExecutionItem(execution) {
        const item = document.createElement('div');
        item.className = 'execution-item';

        const statusIcon = getStatusIcon(execution.status);
        const statusColor = getStatusColor(execution.status);
        const statusText = getStatusText(execution.status);

        item.innerHTML = `
            <div class="execution-avatar" style="background-color: ${statusColor}">
                ${statusIcon}
            </div>
            <div class="execution-content">
                <div class="execution-title">
                    ${execution.test_case_name}
                    <span class="execution-status" style="color: ${statusColor}">${statusText}</span>
                </div>
                <div class="execution-meta">
                    <div>æ‰§è¡Œæ—¶é—´: ${execution.duration ? execution.duration + 'ç§’' : 'æœªçŸ¥'}</div>
                    <div>å¼€å§‹æ—¶é—´: ${new Date(execution.start_time).toLocaleString()}</div>
                </div>
            </div>
        `;

        return item;
    }

    function getStatusIcon(status) {
        switch (status) {
            case 'success': return 'âœ“';
            case 'failed': return 'âœ—';
            case 'running': return 'â³';
            default: return 'â—‹';
        }
    }

    function getStatusColor(status) {
        switch (status) {
            case 'success': return '#28a745';
            case 'failed': return '#dc3545';
            case 'running': return '#333333';
            default: return '#6c757d';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'success': return 'æˆåŠŸ';
            case 'failed': return 'å¤±è´¥';
            case 'running': return 'è¿è¡Œä¸­';
            case 'pending': return 'ç­‰å¾…ä¸­';
            default: return status;
        }
    }

    function showLoading(show) {
        const loadingEl = document.getElementById('loading');
        const contentEl = document.getElementById('main-content');

        if (show) {
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
        } else {
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';
        }
    }
</script>
{% endblock %}
