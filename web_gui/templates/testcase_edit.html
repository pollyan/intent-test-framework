{% extends "base_layout.html" %}

{% block title %}{{ '创建测试用例' if is_create_mode else '编辑测试用例' }} - 意图测试平台{% endblock %}

{% block page_title %}{{ '创建测试用例' if is_create_mode else '编辑测试用例' }}{% endblock %}

{% block page_subtitle %}{{ '创建新的测试用例并设置基本信息和执行步骤' if is_create_mode else '修改测试用例的基本信息和执行步骤' }}{% endblock %}

{% block extra_css %}
<style>
/* 拖拽相关样式 */
.step-container {
    transition: all 0.3s ease;
}

.step-container.dragging {
    opacity: 0.5;
}

.draggable-item {
    position: relative;
    transition: all 0.2s ease;
}

.draggable-item:hover .drag-handle {
    opacity: 1;
}

.drag-handle {
    opacity: 0.5;
    transition: opacity 0.2s ease;
}

.drag-handle:hover {
    cursor: grab;
}

.drag-handle:active {
    cursor: grabbing;
}

/* 拖拽时的占位符效果 */
.step-container.drag-over {
    border-top: 3px solid #4299e1;
}

/* 拖拽时的悬浮效果 */
.step-container.dragging .list-item {
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transform: rotate(2deg);
}

/* 禁用拖拽时的文本选择 */
.steps-list {
    user-select: none;
}

/* 步骤类型库网格布局 */
.grid {
    display: grid;
}

.grid-cols-2 {
    grid-template-columns: repeat(2, 1fr);
}

.gap-1 {
    gap: 4px;
}

/* 步骤类型按钮紧凑样式 */
.step-type-btn {
    width: 100%;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>
{% endblock %}

{% block content %}

<!-- 基本信息 -->
<div class="card mb-3">
    <div class="card-title">基本信息</div>
    <div class="card-subtitle">测试用例的基本属性和描述</div>
    
    <div class="grid grid-cols-3 gap-2" style="margin-bottom: 6px;">
        <div>
            <label class="form-label" style="margin-bottom: 2px;">用例名称</label>
            <input type="text" class="form-input" id="testcase-name" value="{{ testcase.name }}" placeholder="请输入用例名称">
        </div>
        <div>
            <label class="form-label" style="margin-bottom: 2px;">分类</label>
            <select class="form-select" id="testcase-category">
                <option value="功能测试" {{ 'selected' if testcase.category == '功能测试' }}>功能测试</option>
                <option value="性能测试" {{ 'selected' if testcase.category == '性能测试' }}>性能测试</option>
                <option value="安全测试" {{ 'selected' if testcase.category == '安全测试' }}>安全测试</option>
                <option value="兼容性测试" {{ 'selected' if testcase.category == '兼容性测试' }}>兼容性测试</option>
            </select>
        </div>
        <div>
            <label class="form-label" style="margin-bottom: 2px;">优先级</label>
            <select class="form-select" id="testcase-priority">
                <option value="1" {{ 'selected' if testcase.priority == 1 }}>高</option>
                <option value="2" {{ 'selected' if testcase.priority == 2 }}>中</option>
                <option value="3" {{ 'selected' if testcase.priority == 3 }}>低</option>
            </select>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-2" style="margin-bottom: 6px;">
        <div>
            <label class="form-label" style="margin-bottom: 2px;">状态</label>
            <select class="form-select" id="testcase-status">
                <option value="active" {{ 'selected' if testcase.is_active }}>活跃</option>
                <option value="inactive" {{ 'selected' if not testcase.is_active }}>暂停</option>
            </select>
        </div>
        <div>
            <label class="form-label" style="margin-bottom: 2px;">标签</label>
            <input type="text" class="form-input" id="testcase-tags" value="{{ testcase.tags or '' }}" placeholder="用逗号分隔">
        </div>
        <div>
            <label class="form-label" style="margin-bottom: 2px;">创建者</label>
            <input type="text" class="form-input" value="{{ testcase.created_by or 'admin' }}" readonly>
        </div>
    </div>

    <div style="margin-bottom: 0;">
        <label class="form-label" style="margin-bottom: 2px;">用例描述</label>
        <textarea class="form-textarea" id="testcase-description" style="min-height: 40px;" placeholder="请输入用例描述">{{ testcase.description or '' }}</textarea>
    </div>
</div>

<!-- 操作栏 -->
<div class="card mb-3">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
            <button class="btn btn-primary" id="save-testcase">{{ '创建用例' if is_create_mode else '保存用例' }}</button>
            <button class="btn btn-ghost" id="cancel-edit">取消编辑</button>
            <button class="btn btn-ghost" id="preview-execution">预览执行</button>
        </div>
        <div class="text-sm text-gray-600">
            {% if is_create_mode %}
                <span id="step-count">0</span>个步骤 • 
                新建用例
            {% else %}
                最后修改: <span data-time="{{ (testcase.updated_at or testcase.created_at) | utc_to_local }}">{{ '未知' if not (testcase.updated_at or testcase.created_at) else '' }}</span> • 
                <span id="step-count">0</span>个步骤 • 
                执行{{ total_executions }}次 • 
                成功率{{ "%.1f"|format(success_rate) }}%
            {% endif %}
        </div>
    </div>
</div>

<!-- 主要编辑区域 -->
<div class="grid gap-3" style="grid-template-columns: 3fr 1fr;">
    <!-- 左侧：步骤列表 -->
    <div class="card">
        <div class="flex items-center justify-between mb-2">
            <div>
                <div class="card-title">执行步骤</div>
                <div class="card-subtitle">拖拽右侧步骤类型到此处，点击步骤可编辑详细参数</div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">共 <span id="total-steps">0</span> 个步骤</span>
                <button class="btn btn-primary btn-small" id="add-step">添加步骤</button>
            </div>
        </div>

        <div class="list" id="steps-list" style="min-height: 400px; background: #f8f9fa; border-radius: 6px; padding: 16px; border: 1px solid #e2e8f0;">
            <!-- 步骤列表将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 右侧：步骤类型库 -->
    <div class="card" id="step-types" style="font-size: 13px;">
        <div class="card-title" style="margin-bottom: 8px;">步骤类型库</div>
        <div class="card-subtitle" style="margin-bottom: 12px;">拖拽到左侧添加步骤</div>
        
        <!-- 页面导航操作 -->
        <div style="margin-bottom: 12px;">
            <div class="text-xs font-medium text-gray-700" style="margin-bottom: 6px;">页面导航</div>
            <div class="grid grid-cols-2 gap-1">
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="goto">
                    <div>
                        <div class="text-xs font-medium">goto</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">导航到页面</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="refresh">
                    <div>
                        <div class="text-xs font-medium">refresh</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">刷新页面</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="back">
                    <div>
                        <div class="text-xs font-medium">back</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">返回上一页</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="evaluateJavaScript">
                    <div>
                        <div class="text-xs font-medium">evaluateJS</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">执行JS</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 智能交互操作 -->
        <div style="margin-bottom: 12px;">
            <div class="text-xs font-medium text-gray-700" style="margin-bottom: 6px;">智能交互</div>
            <div class="grid grid-cols-2 gap-1">
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="ai">
                    <div>
                        <div class="text-xs font-medium">ai</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">智能操作</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiTap">
                    <div>
                        <div class="text-xs font-medium">aiTap</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">点击元素</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiInput">
                    <div>
                        <div class="text-xs font-medium">aiInput</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">输入文本</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiHover">
                    <div>
                        <div class="text-xs font-medium">aiHover</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">悬停元素</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiScroll">
                    <div>
                        <div class="text-xs font-medium">aiScroll</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">滚动页面</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiKeyboardPress">
                    <div>
                        <div class="text-xs font-medium">aiKeyPress</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">键盘按键</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiRightClick">
                    <div>
                        <div class="text-xs font-medium">aiRightClick</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">右键点击</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据提取操作 -->
        <div style="margin-bottom: 12px;">
            <div class="text-xs font-medium text-gray-700" style="margin-bottom: 6px;">数据提取</div>
            <div class="grid grid-cols-2 gap-1">
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiQuery">
                    <div>
                        <div class="text-xs font-medium">aiQuery</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">结构化数据</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiAsk">
                    <div>
                        <div class="text-xs font-medium">aiAsk</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">询问信息</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiBoolean">
                    <div>
                        <div class="text-xs font-medium">aiBoolean</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">布尔值</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiNumber">
                    <div>
                        <div class="text-xs font-medium">aiNumber</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">提取数值</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiString">
                    <div>
                        <div class="text-xs font-medium">aiString</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">提取文本</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiLocate">
                    <div>
                        <div class="text-xs font-medium">aiLocate</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">元素坐标</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 验证等待操作 -->
        <div style="margin-bottom: 12px;">
            <div class="text-xs font-medium text-gray-700" style="margin-bottom: 6px;">验证等待</div>
            <div class="grid grid-cols-2 gap-1">
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiAssert">
                    <div>
                        <div class="text-xs font-medium">aiAssert</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">断言验证</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="aiWaitFor">
                    <div>
                        <div class="text-xs font-medium">aiWaitFor</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">等待条件</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 工具操作 -->
        <div style="margin-bottom: 8px;">
            <div class="text-xs font-medium text-gray-700" style="margin-bottom: 6px;">工具操作</div>
            <div class="grid grid-cols-2 gap-1">
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="logScreenshot">
                    <div>
                        <div class="text-xs font-medium">screenshot</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">截图记录</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="sleep">
                    <div>
                        <div class="text-xs font-medium">sleep</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">延时等待</div>
                    </div>
                </div>
                <div class="btn btn-small btn-ghost text-left step-type-btn" style="padding: 4px 8px; cursor: grab;" data-action="runYaml">
                    <div>
                        <div class="text-xs font-medium">runYaml</div>
                        <div class="text-xs text-gray-500" style="font-size: 11px;">YAML脚本</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 调试信息 -->
<div class="card mt-4">
    <div class="card-title">调试信息</div>
    <div class="card-subtitle">测试用例的技术信息和历史记录</div>
    
    <div class="grid grid-cols-4 gap-3">
        <div>
            <div class="text-sm text-gray-600 mb-1">用例ID</div>
            <div class="text-sm font-medium">{{ testcase.id if testcase.id else '新建用例' }}</div>
        </div>
        <div>
            <div class="text-sm text-gray-600 mb-1">创建时间</div>
            <div class="text-sm font-medium" data-time="{{ testcase.created_at | utc_to_local }}">{{ '未知' if not testcase.created_at else '' }}</div>
        </div>
        <div>
            <div class="text-sm text-gray-600 mb-1">最后修改</div>
            <div class="text-sm font-medium" data-time="{{ (testcase.updated_at or testcase.created_at) | utc_to_local }}">{{ '未知' if not (testcase.updated_at or testcase.created_at) else '' }}</div>
        </div>
        <div>
            <div class="text-sm text-gray-600 mb-1">创建者</div>
            <div class="text-sm font-medium">{{ testcase.created_by or 'admin' }}</div>
        </div>
    </div>
</div>

<script>
// 测试用例编辑器JavaScript
class TestCaseEditor {
    constructor() {
        this.testcaseId = {{ testcase.id if testcase.id else 'null' }};
        this.steps = {{ steps_data|safe }};
        this.isCreateMode = {{ 'true' if is_create_mode else 'false' }};
        this.selectedStepIndex = -1;
        this.isDirty = false;
        this.autoSaveTimer = null;
        this.isSaving = false; // 防止重复提交
        this.isAddingStep = false; // 防止重复添加步骤
        
        this.initializeEditor();
        this.bindEvents();
        this.renderSteps();
        
        // 启动自动保存（创建模式下不启动）
        if (!this.isCreateMode) {
            this.startAutoSave();
        }
    }
    
    initializeEditor() {
        this.stepsList = document.getElementById('steps-list');
        this.totalStepsSpan = document.getElementById('total-steps');
        this.stepCountSpan = document.getElementById('step-count');
        this.editingStep = null;
    }
    
    bindEvents() {
        // 保存测试用例
        document.getElementById('save-testcase').addEventListener('click', () => {
            this.saveTestCase();
        });
        
        // 取消编辑
        document.getElementById('cancel-edit').addEventListener('click', () => {
            if (this.isDirty) {
                if (confirm('确定要取消编辑吗？未保存的更改将丢失。')) {
                    window.history.back();
                }
            } else {
                window.history.back();
            }
        });
        
        // 预览执行
        document.getElementById('preview-execution').addEventListener('click', () => {
            if (this.isCreateMode) {
                this.showMessage('请先保存测试用例后再预览执行', 'warning');
                return;
            }
            window.location.href = `/execution?testcase_id=${this.testcaseId}`;
        });
        
        // 添加步骤
        document.getElementById('add-step').addEventListener('click', () => {
            this.addNewStep();
        });
        
        // 步骤类型按钮
        document.querySelectorAll('.step-type-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.currentTarget.dataset.action;
                this.addStepFromType(action);
            });
        });
        
        // 表单变化检测
        this.bindFormChangeEvents();
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        this.saveTestCase();
                        break;
                }
            }
            if (e.key === 'Escape') {
                this.hideAllInlineEditors();
            }
        });
    }
    
    bindFormChangeEvents() {
        const inputs = ['testcase-name', 'testcase-description', 'testcase-category', 'testcase-priority', 'testcase-status', 'testcase-tags'];
        inputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => {
                    this.isDirty = true;
                });
            }
        });
    }
    
    renderSteps() {
        this.stepsList.innerHTML = '';
        
        if (this.steps.length === 0) {
            this.stepsList.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #a0aec0;">
                    <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">⚙️</div>
                    <div style="font-size: 16px; font-weight: 500; color: #4a5568; margin-bottom: 8px;">暂无步骤</div>
                    <div style="font-size: 14px; color: #a0aec0; margin-bottom: 24px;">点击右侧步骤类型或"添加步骤"按钮开始创建</div>
                    <button class="btn btn-primary btn-small" onclick="document.getElementById('add-step').click()" style="background: #4299e1; border-color: #4299e1;">添加第一个步骤</button>
                </div>
            `;
            this.updateStepCount();
            return;
        }
        
        this.steps.forEach((step, index) => {
            const stepElement = this.createStepElement(step, index);
            this.stepsList.appendChild(stepElement);
        });
        
        this.updateStepCount();
    }
    
    createStepElement(step, index) {
        const container = document.createElement('div');
        container.className = 'step-container';
        container.dataset.index = index;
        
        const actionDesc = this.getActionDescription(step.action);
        const paramsDesc = this.getParamsDescription(step.action, step.params);
        
        container.innerHTML = `
            <div class="list-item draggable-item ${step.skip ? 'step-skipped' : ''}" title="拖拽排序或点击编辑" style="padding: 20px; border-radius: 6px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: move; ${step.skip ? 'opacity: 0.6; background-color: #f7fafc;' : ''}">
                <div class="drag-handle" draggable="true" style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); cursor: grab; padding: 4px;">
                    <svg width="12" height="20" viewBox="0 0 12 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="3" cy="3" r="1.5" fill="#CBD5E0"/>
                        <circle cx="9" cy="3" r="1.5" fill="#CBD5E0"/>
                        <circle cx="3" cy="10" r="1.5" fill="#CBD5E0"/>
                        <circle cx="9" cy="10" r="1.5" fill="#CBD5E0"/>
                        <circle cx="3" cy="17" r="1.5" fill="#CBD5E0"/>
                        <circle cx="9" cy="17" r="1.5" fill="#CBD5E0"/>
                    </svg>
                </div>
                <div class="list-item-content" style="padding-left: 24px;">
                    <div class="list-item-title" style="font-size: 15px; font-weight: 600; color: #2d3748; margin-bottom: 6px;">
                        <span style="display: inline-block; background: #e2e8f0; color: #4a5568; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; margin-right: 8px;">${index + 1}</span>
                        ${step.description || actionDesc}
                        ${step.skip ? '<span style="margin-left: 8px; background: #fed7d7; color: #c53030; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">跳过</span>' : ''}
                    </div>
                    <div class="list-item-subtitle" style="color: #4a5568; font-size: 14px; margin-bottom: 8px;">${paramsDesc}</div>
                    <div class="list-item-meta" style="display: flex; align-items: center; gap: 12px;">
                        <span style="background: #f7fafc; color: #2d3748; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${step.action}</span>
                        <span style="color: #a0aec0; font-size: 12px;">${this.getMainParam(step.action, step.params)}</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button class="btn btn-small btn-ghost step-skip" style="padding: 4px 10px;" title="${step.skip ? '点击取消跳过' : '点击跳过此步骤'}">${step.skip ? '取消跳过' : '跳过'}</button>
                    <div class="btn-group">
                        <button class="btn btn-small btn-ghost step-up" ${index === 0 ? 'disabled' : ''} style="padding: 4px 8px;">↑</button>
                        <button class="btn btn-small btn-ghost step-down" ${index === this.steps.length - 1 ? 'disabled' : ''} style="padding: 4px 8px;">↓</button>
                    </div>
                    <button class="btn btn-small btn-ghost step-edit" style="padding: 4px 10px;">编辑</button>
                    <button class="btn btn-small btn-ghost step-duplicate" style="padding: 4px 10px;">复制</button>
                    <button class="btn btn-small btn-ghost step-delete" style="padding: 4px 10px;">删除</button>
                </div>
            </div>
        `;
        
        // 绑定事件
        const listItem = container.querySelector('.list-item');
        const stepSkipBtn = container.querySelector('.step-skip');
        const stepUpBtn = container.querySelector('.step-up');
        const stepDownBtn = container.querySelector('.step-down');
        const stepEditBtn = container.querySelector('.step-edit');
        const stepDuplicateBtn = container.querySelector('.step-duplicate');
        const stepDeleteBtn = container.querySelector('.step-delete');
        
        // 点击步骤项目进入编辑模式（与点击编辑按钮效果相同）
        listItem.addEventListener('click', () => {
            this.showInlineEdit(container, index);
        });
        
        stepSkipBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleStepSkip(index);
        });
        
        stepUpBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.moveStepUp(index);
        });
        
        stepDownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.moveStepDown(index);
        });
        
        stepEditBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.showInlineEdit(container, index);
        });
        
        stepDuplicateBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.duplicateStep(index);
        });
        
        stepDeleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.deleteStep(index);
        });
        
        // 获取拖拽手柄元素
        const dragHandle = container.querySelector('.drag-handle');
        
        // 添加拖拽事件到拖拽手柄
        dragHandle.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', index);
            container.classList.add('dragging');
            // 设置拖拽时的视觉效果
            setTimeout(() => {
                container.style.opacity = '0.5';
            }, 0);
        });
        
        dragHandle.addEventListener('dragend', (e) => {
            container.classList.remove('dragging');
            container.style.opacity = '';
            // 清理所有拖拽提示样式
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        });
        
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            const draggingElement = document.querySelector('.dragging');
            if (draggingElement && draggingElement !== container) {
                const afterElement = this.getDragAfterElement(this.stepsList, e.clientY);
                if (afterElement == null) {
                    this.stepsList.appendChild(draggingElement);
                } else {
                    this.stepsList.insertBefore(draggingElement, afterElement);
                }
            }
        });
        
        container.addEventListener('drop', (e) => {
            e.preventDefault();
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = [...this.stepsList.children].indexOf(container);
            
            if (fromIndex !== toIndex) {
                this.reorderSteps(fromIndex, toIndex);
            }
        });
        
        return container;
    }
    
    getActionDescription(action) {
        const descriptions = {
            // 页面导航操作
            'goto': '导航到页面',
            'refresh': '刷新页面',
            'back': '返回上一页',
            'evaluateJavaScript': '执行JavaScript代码',
            
            // 智能交互操作
            'ai': '智能操作规划',
            'aiTap': 'AI点击元素',
            'aiInput': 'AI输入文本',
            'aiHover': 'AI悬停元素',
            'aiScroll': 'AI滚动页面',
            'aiKeyboardPress': 'AI键盘按键',
            'aiRightClick': 'AI右键点击',
            
            // 数据提取操作
            'aiQuery': '提取结构化数据',
            'aiAsk': '询问页面信息',
            'aiBoolean': '提取布尔值',
            'aiNumber': '提取数值',
            'aiString': '提取字符串',
            'aiLocate': '定位元素坐标',
            
            // 验证等待操作
            'aiAssert': 'AI断言验证',
            'aiWaitFor': '等待条件满足',
            
            // 工具操作
            'logScreenshot': '截图并记录',
            'sleep': '延时等待',
            'runYaml': '执行YAML脚本'
        };
        return descriptions[action] || action;
    }
    
    getParamsDescription(action, params) {
        if (!params) return '无参数';
        
        switch(action) {
            // 页面导航操作
            case 'goto':
                return `访问 ${params.url || '未指定URL'}`;
            case 'refresh':
                return '刷新当前页面';
            case 'back':
                return '返回上一页';
            case 'evaluateJavaScript':
                return `执行代码: ${params.code ? params.code.substring(0, 30) + '...' : '未指定代码'}`;
                
            // 智能交互操作
            case 'ai':
                return `智能操作: ${params.prompt || '未指定提示词'}`;
            case 'aiTap':
                return `点击 "${params.locate || '未指定元素'}"`;
            case 'aiInput':
                return `在 "${params.locate || '未指定位置'}" 输入 "${params.text || '未指定文本'}"`;
            case 'aiHover':
                return `悬停 "${params.locate || '未指定元素'}"`;
            case 'aiScroll':
                return `滚动 "${params.locate || '页面'}"`;
            case 'aiKeyboardPress':
                return `按键 "${params.keys || '未指定按键'}"`;
            case 'aiRightClick':
                return `右键点击 "${params.locate || '未指定元素'}"`;
                
            // 数据提取操作
            case 'aiQuery':
                return `提取数据: ${params.schema ? Object.keys(params.schema).join(', ') : '未指定字段'}`;
            case 'aiAsk':
                return `询问: ${params.question || '未指定问题'}`;
            case 'aiBoolean':
                return `布尔值: ${params.question || '未指定问题'}`;
            case 'aiNumber':
                return `数值: ${params.question || '未指定问题'}`;
            case 'aiString':
                return `字符串: ${params.question || '未指定问题'}`;
            case 'aiLocate':
                return `定位: ${params.locate || '未指定元素'}`;
                
            // 验证等待操作
            case 'aiAssert':
                return `断言: ${params.assertion || '未指定条件'}`;
            case 'aiWaitFor':
                return `等待: ${params.assertion || '未指定条件'}`;
                
            // 工具操作
            case 'logScreenshot':
                return `截图: ${params.description || '未指定描述'}`;
            case 'sleep':
                return `等待 ${params.duration || 1000}ms`;
            case 'runYaml':
                return `执行脚本: ${params.yaml ? params.yaml.substring(0, 30) + '...' : '未指定脚本'}`;
                
            default:
                return JSON.stringify(params);
        }
    }
    
    getMainParam(action, params) {
        if (!params) return '无参数';
        
        switch(action) {
            // 页面导航操作
            case 'goto':
                return `目标URL: ${params.url || '未指定'}`;
            case 'refresh':
            case 'back':
                return '无需参数';
            case 'evaluateJavaScript':
                return `JS代码: ${params.code ? params.code.substring(0, 20) + '...' : '未指定'}`;
                
            // 智能交互操作
            case 'ai':
                return `提示词: ${params.prompt || '未指定'}`;
            case 'aiTap':
            case 'aiHover':
            case 'aiScroll':
            case 'aiRightClick':
                return `定位描述: ${params.locate || '未指定'}`;
            case 'aiInput':
                return `输入文本: ${params.text || '未指定'}`;
            case 'aiKeyboardPress':
                return `按键: ${params.keys || '未指定'}`;
                
            // 数据提取操作
            case 'aiQuery':
                return `数据结构: ${params.schema ? Object.keys(params.schema).length + '个字段' : '未指定'}`;
            case 'aiAsk':
            case 'aiBoolean':
            case 'aiNumber':
            case 'aiString':
                return `问题: ${params.question || '未指定'}`;
            case 'aiLocate':
                return `定位描述: ${params.locate || '未指定'}`;
                
            // 验证等待操作
            case 'aiAssert':
            case 'aiWaitFor':
                return `条件: ${params.assertion || '未指定'}`;
                
            // 工具操作
            case 'logScreenshot':
                return `描述: ${params.description || '未指定'}`;
            case 'sleep':
                return `等待时间: ${params.duration || 1000}ms`;
            case 'runYaml':
                return `脚本: ${params.yaml ? '已定义' : '未指定'}`;
                
            default:
                return Object.keys(params).length > 0 ? Object.keys(params)[0] + ': ' + params[Object.keys(params)[0]] : '无参数';
        }
    }
    
    // 显示行内编辑表单
    showInlineEdit(stepContainer, stepIndex) {
        // 关闭其他编辑表单
        this.hideAllInlineEditors();
        
        const step = this.steps[stepIndex];
        const editForm = this.createInlineEditForm(step, stepIndex);
        stepContainer.appendChild(editForm);
        
        // 绑定编辑表单事件
        this.bindEditFormEvents(editForm, stepIndex);
        
        this.editingStep = stepIndex;
    }
    
    // 创建行内编辑表单
    createInlineEditForm(step, index) {
        const editForm = document.createElement('div');
        editForm.className = 'inline-edit-form';
        editForm.style.cssText = `
            background: #f8f8f8;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            padding: 16px;
            margin-top: 8px;
            animation: slideDown 0.2s ease;
        `;
        
        editForm.innerHTML = `
            <div class="form-edit-header" style="margin-bottom: 12px;">
                <div style="font-weight: 500; color: #333;">编辑步骤 ${index + 1}</div>
                <div style="font-size: 12px; color: #666;">修改步骤的详细参数</div>
            </div>
            
            <div class="grid grid-cols-2 gap-2" style="margin-bottom: 12px;">
                <div>
                    <label class="form-label" style="margin-bottom: 4px;">步骤名称</label>
                    <input type="text" class="form-input" id="edit-title-${index}" value="${step.description || ''}" placeholder="请输入步骤名称">
                </div>
                <div>
                    <label class="form-label" style="margin-bottom: 4px;">动作类型</label>
                    <select class="form-select" id="edit-action-${index}" onchange="handleActionTypeChange(${index}, this.value)">
                        <optgroup label="页面导航">
                            <option value="goto" ${step.action === 'goto' ? 'selected' : ''}>goto - 导航到页面</option>
                            <option value="refresh" ${step.action === 'refresh' ? 'selected' : ''}>refresh - 刷新页面</option>
                            <option value="back" ${step.action === 'back' ? 'selected' : ''}>back - 返回上一页</option>
                            <option value="evaluateJavaScript" ${step.action === 'evaluateJavaScript' ? 'selected' : ''}>evaluateJavaScript - 执行JS代码</option>
                        </optgroup>
                        <optgroup label="智能交互">
                            <option value="ai" ${step.action === 'ai' ? 'selected' : ''}>ai - 智能操作规划</option>
                            <option value="aiTap" ${step.action === 'aiTap' ? 'selected' : ''}>aiTap - AI点击元素</option>
                            <option value="aiInput" ${step.action === 'aiInput' ? 'selected' : ''}>aiInput - AI输入文本</option>
                            <option value="aiHover" ${step.action === 'aiHover' ? 'selected' : ''}>aiHover - AI悬停元素</option>
                            <option value="aiScroll" ${step.action === 'aiScroll' ? 'selected' : ''}>aiScroll - AI滚动页面</option>
                            <option value="aiKeyboardPress" ${step.action === 'aiKeyboardPress' ? 'selected' : ''}>aiKeyboardPress - AI键盘按键</option>
                            <option value="aiRightClick" ${step.action === 'aiRightClick' ? 'selected' : ''}>aiRightClick - AI右键点击</option>
                        </optgroup>
                        <optgroup label="数据提取">
                            <option value="aiQuery" ${step.action === 'aiQuery' ? 'selected' : ''}>aiQuery - 提取结构化数据</option>
                            <option value="aiAsk" ${step.action === 'aiAsk' ? 'selected' : ''}>aiAsk - 询问页面信息</option>
                            <option value="aiBoolean" ${step.action === 'aiBoolean' ? 'selected' : ''}>aiBoolean - 提取布尔值</option>
                            <option value="aiNumber" ${step.action === 'aiNumber' ? 'selected' : ''}>aiNumber - 提取数值</option>
                            <option value="aiString" ${step.action === 'aiString' ? 'selected' : ''}>aiString - 提取字符串</option>
                            <option value="aiLocate" ${step.action === 'aiLocate' ? 'selected' : ''}>aiLocate - 定位元素坐标</option>
                        </optgroup>
                        <optgroup label="验证等待">
                            <option value="aiAssert" ${step.action === 'aiAssert' ? 'selected' : ''}>aiAssert - AI断言验证</option>
                            <option value="aiWaitFor" ${step.action === 'aiWaitFor' ? 'selected' : ''}>aiWaitFor - 等待条件满足</option>
                        </optgroup>
                        <optgroup label="工具操作">
                            <option value="logScreenshot" ${step.action === 'logScreenshot' ? 'selected' : ''}>logScreenshot - 截图并记录</option>
                            <option value="sleep" ${step.action === 'sleep' ? 'selected' : ''}>sleep - 延时等待</option>
                            <option value="runYaml" ${step.action === 'runYaml' ? 'selected' : ''}>runYaml - 执行YAML脚本</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <label class="form-label" style="margin-bottom: 4px;">动作参数 (JSON)</label>
                <textarea class="form-textarea" id="edit-params-${index}" style="font-family: 'SF Mono', Monaco, monospace; font-size: 13px; min-height: 80px;" placeholder="请输入动作参数的JSON格式">${JSON.stringify(step.params || {}, null, 2)}</textarea>
            </div>

            <div class="flex gap-2">
                <button class="btn btn-primary save-step-inline">保存步骤</button>
                <button class="btn btn-ghost cancel-edit-inline">取消编辑</button>
                <button class="btn btn-ghost delete-step-inline">删除步骤</button>
            </div>
        `;
        
        return editForm;
    }
    
    // 绑定编辑表单事件
    bindEditFormEvents(editForm, stepIndex) {
        const saveBtn = editForm.querySelector('.save-step-inline');
        const cancelBtn = editForm.querySelector('.cancel-edit-inline');
        const deleteBtn = editForm.querySelector('.delete-step-inline');
        
        saveBtn.addEventListener('click', () => {
            const title = editForm.querySelector(`#edit-title-${stepIndex}`).value;
            const action = editForm.querySelector(`#edit-action-${stepIndex}`).value;
            
            try {
                const params = JSON.parse(editForm.querySelector(`#edit-params-${stepIndex}`).value);
                
                // 更新步骤数据
                this.steps[stepIndex] = {
                    ...this.steps[stepIndex],
                    action,
                    description: title,
                    params
                };
                
                this.isDirty = true;
                this.renderSteps();
                this.editingStep = null;
                
                this.showMessage('步骤保存成功', 'success');
                this.autoSave();
            } catch (e) {
                this.showMessage('参数格式错误，请输入有效的JSON', 'error');
            }
        });
        
        cancelBtn.addEventListener('click', () => {
            editForm.remove();
            this.editingStep = null;
        });
        
        deleteBtn.addEventListener('click', () => {
            if (confirm('确定要删除这个步骤吗？')) {
                this.steps.splice(stepIndex, 1);
                this.isDirty = true;
                this.renderSteps();
                this.editingStep = null;
            }
        });
    }
    
    // 隐藏所有行内编辑器
    hideAllInlineEditors() {
        document.querySelectorAll('.inline-edit-form').forEach(form => {
            form.remove();
        });
        this.editingStep = null;
    }
    
    // 添加新步骤
    addNewStep() {
        // 防止重复添加
        if (this.isAddingStep) {
            this.showMessage('正在添加步骤，请稍候...', 'warning');
            return;
        }
        
        try {
            this.isAddingStep = true;
            
            const newStep = {
                action: 'goto',
                description: '新步骤',
                params: { url: 'https://example.com' }
            };
            
            this.steps.push(newStep);
            this.isDirty = true;
            this.renderSteps();
            
            // 自动进入编辑模式
            setTimeout(() => {
                const newStepIndex = this.steps.length - 1;
                const stepContainers = document.querySelectorAll('.step-container');
                if (stepContainers[newStepIndex]) {
                    this.showInlineEdit(stepContainers[newStepIndex], newStepIndex);
                }
                this.isAddingStep = false;
            }, 100);
        } catch (error) {
            this.isAddingStep = false;
            this.showMessage('添加步骤失败: ' + error.message, 'error');
        }
    }
    
    addStepFromType(action) {
        // 防止重复添加
        if (this.isAddingStep) {
            this.showMessage('正在添加步骤，请稍候...', 'warning');
            return;
        }
        
        try {
            this.isAddingStep = true;
            
            const defaultParams = this.getDefaultParams(action);
            const newStep = {
                action: action,
                description: this.getActionDescription(action),
                params: defaultParams
            };
            
            this.steps.push(newStep);
            this.isDirty = true;
            this.renderSteps();
            
            // 自动进入编辑模式
            setTimeout(() => {
                const newStepIndex = this.steps.length - 1;
                const stepContainers = document.querySelectorAll('.step-container');
                if (stepContainers[newStepIndex]) {
                    this.showInlineEdit(stepContainers[newStepIndex], newStepIndex);
                }
                this.isAddingStep = false;
            }, 100);
        } catch (error) {
            this.isAddingStep = false;
            this.showMessage('添加步骤失败: ' + error.message, 'error');
        }
    }
    
    getDefaultParams(action) {
        const defaults = {
            // 页面导航操作
            'goto': { url: 'https://example.com' },
            'refresh': {},
            'back': {},
            'evaluateJavaScript': { code: 'console.log("Hello World");' },
            
            // 智能交互操作
            'ai': { prompt: '' },
            'aiTap': { locate: '按钮描述', options: { deepThink: false, cacheable: true } },
            'aiInput': { text: '输入内容', locate: '输入框描述', options: { deepThink: false, cacheable: true } },
            'aiHover': { locate: '元素描述', options: { deepThink: false, cacheable: true } },
            'aiScroll': { locate: '滚动区域', options: { deepThink: false, cacheable: true } },
            'aiKeyboardPress': { keys: 'Enter', options: { deepThink: false } },
            'aiRightClick': { locate: '右键目标', options: { deepThink: false, cacheable: true } },
            
            // 数据提取操作
            'aiQuery': { schema: { '字段名': '字段描述, 数据类型' } },
            'aiAsk': { question: '询问关于页面的问题' },
            'aiBoolean': { question: '返回布尔值的问题' },
            'aiNumber': { question: '返回数值的问题' },
            'aiString': { question: '返回字符串的问题' },
            'aiLocate': { locate: '元素描述' },
            
            // 验证等待操作
            'aiAssert': { assertion: '断言条件描述', errorMsg: '断言失败时的错误信息' },
            'aiWaitFor': { assertion: '等待条件描述', options: { timeoutMs: 15000, checkIntervalMs: 3000 } },
            
            // 工具操作
            'logScreenshot': { description: '截图描述' },
            'sleep': { duration: 1000 },
            'runYaml': { yaml: 'steps:\n  - action: aiTap\n    locate: 按钮' }
        };
        return defaults[action] || {};
    }
    
    toggleStepSkip(index) {
        this.steps[index].skip = !this.steps[index].skip;
        this.isDirty = true;
        this.renderSteps();
        this.autoSave();
        
        const message = this.steps[index].skip ? '步骤已设置为跳过' : '步骤已取消跳过';
        this.showMessage(message, 'success');
    }
    
    async moveStepUp(index) {
        if (index > 0) {
            [this.steps[index], this.steps[index - 1]] = [this.steps[index - 1], this.steps[index]];
            this.isDirty = true;
            this.renderSteps();
            await this.autoSave();
        }
    }
    
    async moveStepDown(index) {
        if (index < this.steps.length - 1) {
            [this.steps[index], this.steps[index + 1]] = [this.steps[index + 1], this.steps[index]];
            this.isDirty = true;
            this.renderSteps();
            await this.autoSave();
        }
    }
    
    getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.step-container:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    async reorderSteps(fromIndex, toIndex) {
        if (fromIndex === toIndex) return;
        
        const movedStep = this.steps.splice(fromIndex, 1)[0];
        this.steps.splice(toIndex, 0, movedStep);
        
        this.isDirty = true;
        this.renderSteps();
        await this.autoSave();
    }
    
    duplicateStep(index) {
        const stepCopy = JSON.parse(JSON.stringify(this.steps[index]));
        stepCopy.description = (stepCopy.description || '') + ' (复制)';
        this.steps.splice(index + 1, 0, stepCopy);
        this.isDirty = true;
        this.renderSteps();
    }
    
    deleteStep(index) {
        if (confirm('确定要删除这个步骤吗？')) {
            this.steps.splice(index, 1);
            this.isDirty = true;
            this.renderSteps();
            this.hideAllInlineEditors();
        }
    }
    
    
    updateStepCount() {
        const count = this.steps.length;
        this.totalStepsSpan.textContent = count;
        this.stepCountSpan.textContent = count;
    }
    
    async saveTestCase(silent = false) {
        // 防止重复提交
        if (this.isSaving) {
            if (!silent) this.showMessage('正在保存中，请稍候...', 'warning');
            return;
        }
        
        // 获取保存按钮
        const saveBtn = document.getElementById('save-testcase');
        const originalText = saveBtn ? saveBtn.textContent : '';
        
        try {
            this.isSaving = true;
            
            // 更新按钮状态
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '保存中...';
                saveBtn.classList.add('disabled');
            }
            
            const formData = {
                name: document.getElementById('testcase-name').value,
                description: document.getElementById('testcase-description').value,
                category: document.getElementById('testcase-category').value,
                priority: parseInt(document.getElementById('testcase-priority').value),
                tags: document.getElementById('testcase-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                steps: this.steps
            };
            
            // 验证必填字段
            if (!formData.name.trim()) {
                if (!silent) this.showMessage('请输入用例名称', 'error');
                // 恢复按钮状态
                this.isSaving = false;
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = originalText;
                    saveBtn.classList.remove('disabled');
                }
                return;
            }
            
            let url, method;
            if (this.isCreateMode) {
                url = '/api/testcases';
                method = 'POST';
            } else {
                url = `/api/testcases/${this.testcaseId}`;
                method = 'PUT';
            }
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.isDirty = false;
                if (this.isCreateMode) {
                    // 创建成功后跳转到编辑页面
                    if (!silent) {
                        this.showMessage('测试用例创建成功', 'success');
                        setTimeout(() => {
                            window.location.href = `/testcases/${result.data.id}/edit`;
                        }, 1000);
                    }
                } else {
                    if (!silent) {
                        this.showMessage('测试用例保存成功', 'success');
                        
                        // 更新页面显示的信息
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                }
            } else {
                if (!silent) this.showMessage(result.message || '保存失败', 'error');
            }
        } catch (error) {
            if (!silent) this.showMessage('保存失败: ' + error.message, 'error');
        } finally {
            // 恢复按钮状态
            this.isSaving = false;
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
                saveBtn.classList.remove('disabled');
            }
        }
    }
    
    startAutoSave() {
        // 每30秒自动保存一次
        this.autoSaveTimer = setInterval(() => {
            this.autoSave();
        }, 30000);
    }
    
    async autoSave() {
        if (!this.isDirty || this.isCreateMode) return; // 创建模式下不自动保存
        
        try {
            await this.saveTestCase(true); // 静默保存
        } catch (error) {
            console.error('自动保存失败:', error);
        }
    }
    
    // 处理动作类型切换
    handleActionTypeChange(index, newActionType) {
        console.log('handleActionTypeChange called:', index, newActionType);
        
        if (!newActionType || index < 0 || index >= this.steps.length) {
            console.log('Invalid parameters:', index, newActionType);
            return;
        }

        const currentStep = this.steps[index];
        const oldActionType = currentStep.action;
        
        console.log('Action type change:', oldActionType, '->', newActionType);
        
        // 如果动作类型没有改变，直接返回
        if (oldActionType === newActionType) {
            console.log('No action type change needed');
            return;
        }

        // 保存当前参数用于智能保留
        const oldParams = currentStep.params || {};
        console.log('Old params:', oldParams);
        
        // 更新步骤的动作类型
        currentStep.action = newActionType;
        
        // 智能合并参数
        const newParams = this.mergeParamsOnActionChange(oldActionType, newActionType, oldParams);
        console.log('New params after merge:', newParams);
        currentStep.params = newParams;
        
        // 重新渲染参数文本区域
        const paramsTextarea = document.getElementById(`edit-params-${index}`);
        if (paramsTextarea) {
            paramsTextarea.value = JSON.stringify(newParams, null, 2);
            console.log('Updated params textarea');
        } else {
            console.log('Params textarea not found:', `edit-params-${index}`);
        }
        
        // 标记为已修改
        this.isDirty = true;
        
        // 显示参数更新提示
        this.showMessage(`动作类型已从 "${oldActionType}" 切换为 "${newActionType}"，参数已自动更新`, 'success');
        
        console.log('Final step params:', currentStep.params);
    }
    
    // 智能参数合并算法
    mergeParamsOnActionChange(oldAction, newAction, oldParams) {
        const newParams = {};
        
        // 基础参数映射表
        const paramMappings = {
            'locate': ['locate', 'prompt', 'assertion'],
            'prompt': ['prompt', 'locate', 'assertion'], 
            'text': ['text'],
            'url': ['url'],
            'timeout': ['timeout', 'duration', 'timeoutMs'],
            'duration': ['duration', 'timeout'],
            'timeoutMs': ['timeoutMs', 'timeout', 'duration'],
            'query': ['query', 'schema', 'question'],
            'question': ['question', 'query', 'prompt'],
            'schema': ['schema', 'query'],
            'assertion': ['assertion', 'locate', 'prompt', 'condition'],
            'condition': ['condition', 'assertion', 'prompt'],
            'description': ['description', 'name'],
            'name': ['name', 'description'],
            'keys': ['keys', 'key'],
            'key': ['key', 'keys'],
            'code': ['code', 'yaml'],
            'yaml': ['yaml', 'code'],
            'options': ['options']
        };
        
        // 默认参数设置（与新增步骤时的默认值保持一致）
        const defaultParams = {
            // 页面导航操作
            'goto': { url: 'https://example.com' },
            'refresh': {},
            'back': {},
            'evaluateJavaScript': { code: 'console.log("Hello World");' },
            
            // 智能交互操作
            'ai': { prompt: '' },
            'aiTap': { locate: '按钮描述', options: { deepThink: false, cacheable: true } },
            'aiInput': { text: '输入内容', locate: '输入框描述', options: { deepThink: false, cacheable: true } },
            'aiHover': { locate: '元素描述', options: { deepThink: false, cacheable: true } },
            'aiScroll': { locate: '滚动区域', options: { deepThink: false, cacheable: true } },
            'aiKeyboardPress': { keys: 'Enter', options: { deepThink: false } },
            'aiRightClick': { locate: '右键目标', options: { deepThink: false, cacheable: true } },
            
            // 数据提取操作
            'aiQuery': { schema: { '字段名': '字段描述, 数据类型' } },
            'aiAsk': { question: '询问关于页面的问题' },
            'aiBoolean': { question: '返回布尔值的问题' },
            'aiNumber': { question: '返回数值的问题' },
            'aiString': { question: '返回字符串的问题' },
            'aiLocate': { locate: '元素描述' },
            
            // 验证等待操作
            'aiAssert': { assertion: '断言条件描述', errorMsg: '断言失败时的错误信息' },
            'aiWaitFor': { assertion: '等待条件描述', options: { timeoutMs: 15000, checkIntervalMs: 3000 } },
            
            // 工具操作
            'logScreenshot': { description: '截图描述' },
            'sleep': { duration: 1000 },
            'runYaml': { yaml: 'steps:\n  - action: aiTap\n    locate: 按钮' }
        };
        
        // 设置新动作类型的默认参数
        Object.assign(newParams, defaultParams[newAction] || {});
        
        // 1. 保留同名参数（优先级最高）
        for (const paramName in oldParams) {
            if (newParams.hasOwnProperty(paramName) && oldParams[paramName] !== undefined && oldParams[paramName] !== '') {
                // 对于 options 对象，合并而不是替换
                if (paramName === 'options' && typeof oldParams[paramName] === 'object' && typeof newParams[paramName] === 'object') {
                    newParams[paramName] = { ...newParams[paramName], ...oldParams[paramName] };
                } else {
                    newParams[paramName] = oldParams[paramName];
                }
            }
        }
        
        // 2. 尝试保留兼容的参数（跨参数名映射）
        for (const [newParamName, possibleOldNames] of Object.entries(paramMappings)) {
            if (newParams.hasOwnProperty(newParamName) && (newParams[newParamName] === '' || !newParams[newParamName])) {
                for (const oldParamName of possibleOldNames) {
                    if (oldParams[oldParamName] !== undefined && oldParams[oldParamName] !== '' && oldParamName !== newParamName) {
                        newParams[newParamName] = oldParams[oldParamName];
                        break;
                    }
                }
            }
        }
        
        return newParams;
    }
    
    showMessage(message, type = 'info') {
        // 创建消息提示
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        `;
        
        // 设置背景色
        switch(type) {
            case 'success':
                messageDiv.style.backgroundColor = '#28a745';
                break;
            case 'error':
                messageDiv.style.backgroundColor = '#dc3545';
                break;
            default:
                messageDiv.style.backgroundColor = '#333';
        }
        
        document.body.appendChild(messageDiv);
        
        // 3秒后自动移除
        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }
}

// 通用时间格式化函数
function formatLocalTime(isoString) {
    if (!isoString) return '未知';
    try {
        return new Date(isoString).toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    } catch (e) {
        return '时间格式错误';
    }
}

// 页面加载完成后初始化编辑器
document.addEventListener('DOMContentLoaded', function() {
    // 格式化所有时间显示
    document.querySelectorAll('[data-time]').forEach(element => {
        const isoTime = element.getAttribute('data-time');
        if (isoTime) {
            element.textContent = formatLocalTime(isoTime);
        }
    });
    
    const editor = new TestCaseEditor();
    
    // 将动作类型切换函数设置为全局可访问
    window.handleActionTypeChange = function(index, newActionType) {
        editor.handleActionTypeChange(index, newActionType);
    };
});
</script>

<style>
/* 步骤列表特定样式 */
.step-container {
    border: none;
    margin: 0;
    padding: 0;
}

.step-container .list-item {
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 0;
}

.step-container .list-item:last-child {
    border-bottom: none;
}

/* 确保行内编辑表单样式 */
.inline-edit-form {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 16px;
    margin: 8px 0;
}

.inline-edit-form .form-group {
    margin-bottom: 12px;
}

.inline-edit-form .form-group:last-child {
    margin-bottom: 0;
}

/* 动画效果 */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}